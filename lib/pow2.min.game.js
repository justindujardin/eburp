
/*!
  pow2 - v0.0.21
  built: 2014-11-28
 */

var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.connectComponent=function(){return b.prototype.connectComponent.call(this)&&this.host instanceof a.TileMap},c.prototype.process=function(a){a.camera.point.set(this.host.bounds.point),a.cameraScale=Math.min(6,Math.round(a.screenToWorld(a.context.canvas.width)/a.camera.extent.x)),this.host&&(a.camera.point.x=Math.max(0,a.camera.point.x),a.camera.point.y=Math.max(0,a.camera.point.y),a.camera.point.x=Math.min(a.camera.point.x,this.host.bounds.extent.x-a.camera.extent.x),a.camera.point.y=Math.min(a.camera.point.y,this.host.bounds.extent.y-a.camera.extent.y),this.host.bounds.extent.x<a.camera.extent.x&&(a.camera.point.x=(this.host.bounds.extent.x-a.camera.extent.x)/2),this.host.bounds.extent.y<a.camera.extent.y&&(a.camera.point.y=(this.host.bounds.extent.y-a.camera.extent.y)/2))},c}(a.CameraComponent);a.TileMapCameraComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(c){b.call(this),this.tiles=[],this.dirtyLayers=!1,this._loaded=!1,this.bounds=new a.Rect(0,0,10,10),this.mapName=c}return __extends(c,b),c.prototype.onAddToScene=function(){this.findComponent(a.CameraComponent)||this.addComponent(new a.TileMapCameraComponent),this.load()},c.prototype.load=function(b){var c=this;void 0===b&&(b=this.mapName);var d=a.ResourceLoader.get();d.load("/maps/"+b+".tmx",function(a){c.mapName=b,c.setMap(a)})},c.prototype.isLoaded=function(){return this._loaded},c.prototype.loaded=function(){this.trigger("loaded",this),this.scene&&this.scene.trigger("map:loaded",this),this._loaded=!0},c.prototype.unloaded=function(){this.trigger("unloaded",this),this.scene&&this.scene.trigger("map:unloaded",this),this._loaded=!1},c.prototype.setMap=function(b){var c=this;if(!b||!b.isReady())return!1;this.map&&this.unloaded(),this.map=b,this.bounds=new a.Rect(0,0,this.map.width,this.map.height);var d=_.sortBy(this.map.tilesets,function(a){return a.firstgid});return this.tiles.length=0,_.each(d,function(a){for(;c.tiles.length<a.firstgid;)c.tiles.push(null);c.tiles=c.tiles.concat(a.tiles)}),this.features=_.where(this.map.layers,{name:"Features"})[0]||[],this.zones=_.where(this.map.layers,{name:"Zones"})[0]||[],this.loaded(),!0},c.prototype.getLayers=function(){return this.map?this.map.layers:[]},c.prototype.getLayer=function(a){return _.where(this.map.layers,{name:a})[0]},c.prototype.getTerrain=function(a,b,c){return this.getTileData(this.getLayer(a),b,c)},c.prototype.getTileData=function(a,b,c){if(!(this.map&&a&&a.data&&this.bounds.pointInRect(b,c)))return null;var d=c*this.map.width+b,e=a.data[d];return this.tiles[e]},c.prototype.getTileGid=function(a,b,c){var d=this.getLayer(a);if(!(this.map&&d&&d.data&&this.bounds.pointInRect(b,c)))return null;var e=c*this.map.width+b;return d.data[e]},c.prototype.getTileMeta=function(a){if(this.tiles.length<=a)return null;var b=_.find(this.map.tilesets,function(b){return b.hasGid(a)});return b?b.getTileMeta(a):null},c.prototype.getTerrainTexture=function(a,b){var c=this.getTerrain("Terrain",a,b);return c?c.icon:null},c}(a.SceneObject);a.TileMap=b}(pow2||(pow2={}));var pow2;!function(a){var b={visible:!0,enabled:!0,icon:"",iconCoords:null,scale:1,image:null,tileMap:null},c=function(c){function d(a){return void 0===a&&(a=b),c.call(this,a),_.extend(this,_.defaults(a||{},b)),this}return __extends(d,c),d.prototype.setPoint=function(b){b.round(),this.renderPoint&&(this.renderPoint=b.clone()),this.point=b.clone();var c=this.findComponent(a.MovableComponent);c&&(c.targetPoint.set(b),c.path.length=0)},d.prototype.onAddToScene=function(){this.icon&&this.setSprite(this.icon),this.tileMap||(this.tileMap=this.scene.objectByType(a.TileMap))},d.prototype.setSprite=function(a,b){var c=this;void 0===b&&(b=0);var d=this.icon;if(a){var e=this.world.sprites.getSpriteMeta(a);this.world.sprites.getSpriteSheet(e.source,function(a){return c.meta=e,c.image=a.data})}else this.meta=null;return this.icon=a,d},d}(a.SceneObject);a.TileObject=c}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.syncComponent=function(){return this.tileMap=this.host.tileMap,!!this.tileMap&&this.tileMap instanceof a.TileMap},c.prototype.disconnectComponent=function(){return this.tileMap=null,!0},c.prototype.enter=function(){return!0},c.prototype.entered=function(){return this.isEntered=!0,!0},c.prototype.exit=function(){return!0},c.prototype.exited=function(){return this.isEntered=!1,!0},c}(a.SceneComponent);a.TileComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this._renderPoint=new a.Point}return __extends(c,b),c.prototype.render=function(a,b,c){if(b.image&&a.visible){this._renderPoint.set(a.renderPoint||a.point);var d=this._renderPoint,e=b.meta,f=c.unitSize,g=c.unitSize;e&&"undefined"!=typeof e.cellWidth&&"undefined"!=typeof e.cellHeight&&(f=e.cellWidth,g=e.cellHeight);var h=c.fastScreenToWorldNumber(f),i=c.fastScreenToWorldNumber(g);if(d.x-=h*a.scale/2,d.y-=i*a.scale/2,c.fastWorldToScreenPoint(d,d),b.icon&&b.meta){var j=e.x,k=e.y;if(b.meta.frames>1){if(b.frame>4);var l=e.width/f,m=b.frame%l,n=Math.floor((b.frame-m)/l);j+=m*f,k+=n*g}c.context.drawImage(b.image,j,k,f,g,d.x,d.y,f*a.scale,g*a.scale)}else c.context.drawImage(b.image,d.x,d.y,f*a.scale,g*a.scale)}},c}(a.SceneObjectRenderer);a.TileObjectRenderer=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.buffer=null,this.bufferMapName=null,this.bufferComplete=!1,this._clipRect=new a.Rect,this._renderRect=new a.Rect}return __extends(c,b),c.prototype.render=function(a,b){var c=this,d=8,e=d*b.unitSize;if(a.isLoaded()){if(a.dirtyLayers&&(a.dirtyLayers=!1,this.buffer=null,this.bufferComplete=!1),!this.bufferComplete||null===this.buffer||null===this.bufferMapName||this.bufferMapName!==a.mapName){var f=e/b.unitSize,g=Math.ceil(a.bounds.extent.x/d),h=Math.ceil(a.bounds.extent.y/d);this.buffer=new Array(g);for(var i=0;g>i;i++)this.buffer[i]=new Array(h);this.bufferComplete=!0;for(var j=a.getLayers(),i=0;g>i;i++)for(var k=0;h>k;k++){var l=i*f,m=l+f,n=k*f,o=n+f;this.buffer[i][k]=b.renderToCanvas(e,e,function(d){for(var e=l;m>e;e++)for(var f=n;o>f;f++)_.each(j,function(g){if(g.visible){var h=a.getTileGid(g.name,e,f),i=a.getTileMeta(h);if(i){var j,k,m,o,p,q,r,s,t=i.image.data;if(!t||!t.complete)return void(c.bufferComplete=!1);r=i.x,s=i.y,q=i.width,p=i.height,m=(e-l)*b.unitSize,o=(f-n)*b.unitSize,k=j=b.unitSize,d.drawImage(t,r,s,q,p,m,o,k,j)}}})})}this.bufferMapName=a.mapName}var p=b.fastWorldToScreenNumber(d);b.fastWorldToScreenRect(b.getCameraClip(),this._clipRect);for(var q=this.buffer.length,h=this.buffer[0].length,i=0;q>i;i++)for(var k=0;h>k;k++)this._renderRect.set(i*d-.5,k*d-.5,d,d),b.fastWorldToScreenRect(this._renderRect,this._renderRect),this._renderRect.intersect(this._clipRect)&&b.context.drawImage(this.buffer[i][k],0,0,e,e,this._renderRect.point.x,this._renderRect.point.y,p,p)}},c}(a.SceneObjectRenderer);a.TileMapRenderer=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.objectRenderer=new a.TileObjectRenderer,this.mapRenderer=new a.TileMapRenderer,this.tileMap=null}return __extends(c,b),c.prototype.setTileMap=function(a){this.tileMap=a},c.prototype.setScene=function(a){a!==this.scene&&(this.cameraComponent=null,b.prototype.setScene.call(this,a))},c.prototype.getCameraClip=function(){if(!this.tileMap)return this.camera;var a=this.camera.clone();a.point.round(),a.extent.round();var b=this.tileMap.bounds;return a.point.x<b.point.x&&(a.point.x+=b.point.x-a.point.x),a.point.y<b.point.y&&(a.point.y+=b.point.y-a.point.y),a.point.x+a.extent.x>b.point.x+b.extent.x&&(a.point.x-=a.point.x+a.extent.x-(b.point.x+b.extent.x)),a.point.y+a.extent.y>b.point.y+b.extent.y&&(a.point.y-=a.point.y+a.extent.y-(b.point.y+b.extent.y)),a},c.prototype.setRenderState=function(){var a,c;b.prototype.setRenderState.call(this),this.camera&&this.context&&this.tileMap&&(c=this.worldToScreen(this.tileMap.bounds.point),c.x=parseFloat(c.x.toFixed(2)),c.y=parseFloat(c.y.toFixed(2)),a=this.worldToScreen(this.camera.point),a.x=parseFloat(a.x.toFixed(2)),a.y=parseFloat(a.y.toFixed(2)),this.context.translate(c.x-a.x,c.y-a.y))},c.prototype.renderFrame=function(){return this.clearRect(),this.tileMap?(this.mapRenderer.render(this.tileMap,this),this):void 0},c.prototype.renderPost=function(){this.camera&&this.context&&this.tileMap&&this.renderAnalog()},c.prototype.renderAnalog=function(){var a,b,c,d,e,f,g;if(this.world&&this.world.input){var h=this.world.input;if("undefined"!=typeof h.touches){for(a=this.worldToScreen(this.camera.point),d=h.touchStart.clone().add(a),c=h.touchCurrent.clone().add(a),this.context.save(),g=h.touches,e=0,f=g.length;f>e;e++)b=g[e],b.identifier===h.touchId&&(this.context.beginPath(),this.context.strokeStyle="cyan",this.context.lineWidth=6,this.context.arc(d.x,d.y,40,0,2*Math.PI,!0),this.context.stroke(),this.context.beginPath(),this.context.strokeStyle="cyan",this.context.lineWidth=2,this.context.arc(d.x,d.y,60,0,2*Math.PI,!0),this.context.stroke(),this.context.beginPath(),this.context.strokeStyle="cyan",this.context.arc(c.x,c.y,40,0,2*Math.PI,!0),this.context.stroke(),this.context.fillStyle="white");this.context.restore()}return this}},c}(a.SceneView);a.TileMapView=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(a){function b(b){a.call(this),this.frame=0,"undefined"!=typeof b&&_.extend(this,b)}return __extends(b,a),b.prototype.connectComponent=function(){return this.setSprite(this.icon,this.frame),a.prototype.connectComponent.call(this)},b.prototype.setSprite=function(a,b){var c=this;void 0===b&&(b=0);var d=this.icon;return a?(this.meta=this.host.world.sprites.getSpriteMeta(a),this.host.world.sprites.getSpriteSheet(this.meta.source,function(a){return c.image=a.data})):this.meta=null,this.icon=a,d},b}(a.SceneComponent);a.SpriteComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(a){void 0===a&&(a={lengthMS:500,spriteName:null}),b.call(this),this._elapsed=0,this._renderFrame=3,this.lengthMS=500,"undefined"!=typeof a&&_.extend(this,a)}return __extends(c,b),c.prototype.connectComponent=function(){return this._renderFrame=0,this._elapsed=0,b.prototype.connectComponent.call(this)},c.prototype.syncComponent=function(){if(!b.prototype.syncComponent.call(this))return!1;var c=this.host.findComponents(a.SpriteComponent);return this.spriteComponent=_.where(c,{name:this.spriteName})[0],!!this.spriteComponent},c.prototype.tick=function(a){this._elapsed+=a,this._elapsed>=this.lengthMS&&(this.trigger("animation:done",this),this._elapsed=this._elapsed%this.lengthMS),b.prototype.tick.call(this,a)},c.prototype.interpolateTick=function(a){if(this.spriteComponent){var c=this._elapsed/this.lengthMS;this.spriteComponent.frame=c*this.spriteComponent.meta.frames|0}b.prototype.interpolateTick.call(this,a)},c}(a.TickedComponent);a.AnimatedSpriteComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.defaults=function(){return _.extend({},b.DEFAULTS)},b.prototype.rollHit=function(a){return!0},b.prototype.damage=function(a){return 0>a?0:(a=Math.ceil(a),this.set({hp:Math.max(0,this.attributes.hp-a)}),this.attributes.hp<0&&this.set({dead:!0}),a)},b.prototype.getEvasion=function(){return 0},b.prototype.isDefeated=function(){return this.attributes.hp<=0},b.prototype.attack=function(a){var b=this.attributes.strength/2;return a.damage(b)},b.BASE_CHANCE_TO_HIT=168,b.BASE_EVASION=48,b.DEFAULTS={name:"Nothing",icon:"",level:1,hp:0,maxHP:0,strength:5,vitality:4,intelligence:1,agility:1,dead:!1,evade:0,hitpercent:1},b}(Backbone.Model);a.EntityModel=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(c){b.call(this,_.omit(c||{},["x","y","type"])),this.feature=c,this.type=c.type||"player",this.groups="string"==typeof c.groups?JSON.parse(c.groups):c.groups,this.model=c.model||new a.EntityModel(c)}return __extends(c,b),c.prototype.isDefeated=function(){return this.model.isDefeated()},c.prototype.getIcon=function(){if(this.icon)return this.icon;var b=this.findComponent(a.SpriteComponent);return b?b.icon:null},c}(a.TileObject);a.GameEntityObject=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(c){b.call(this),this.defaultState=a.CombatStartState.NAME,this.states=[new a.CombatStartState,new a.CombatVictoryState,new a.CombatDefeatState,new a.CombatBeginTurnState,new a.CombatEndTurnState],this.party=[],this.enemies=[],this.turnList=[],this.currentDone=!1,this.keyListener=null,this.parent=c}return __extends(c,b),c.prototype.isFriendlyTurn=function(){var a=this;return this.current&&!!_.find(this.party,function(b){return b._uid===a.current._uid})},c.prototype.getLiveParty=function(){return _.reject(this.party,function(a){return a.isDefeated()})},c.prototype.getLiveEnemies=function(){return _.reject(this.enemies,function(a){return a.isDefeated()})},c.prototype.getRandomPartyMember=function(){for(var a=_.shuffle(this.party);a.length>0;){var b=a.shift();if(!b.isDefeated())return b}return null},c.prototype.getRandomEnemy=function(){for(var a=_.shuffle(this.enemies);a.length>0;){var b=a.shift();if(!b.isDefeated())return b}return null},c.prototype.partyDefeated=function(){var a=_.reject(this.party,function(a){return a.model.attributes.hp<=0});return 0===a.length},c.prototype.enemiesDefeated=function(){return 0===_.reject(this.enemies,function(a){return a.model.attributes.hp<=0}).length},c}(a.StateMachine);a.CombatStateMachine=b;var c=function(c){function d(){c.apply(this,arguments),this.name=d.NAME,this.machine=null,this.parent=null,this.finished=!1}return __extends(d,c),d.prototype.enter=function(d){var e=this;c.prototype.enter.call(this,d),this.parent=d,this.machine=new b(d);var f=d.world.combatScene=new a.Scene;d.world.mark(f),_.each(d.model.party,function(b){var c=new a.GameEntityObject({name:b.attributes.name,icon:b.attributes.icon,model:b}),d=b.attributes.type[0].toUpperCase()+b.attributes.type.substr(1),g=a.combat[d+"CombatRenderComponent"];g="undefined"==typeof g?new a.combat.PlayerCombatRenderComponent:new g,c.addComponent(g),c.addComponent(new a.AnimatedComponent),c.isDefeated()||(c.icon=b.get("icon"),e.machine.party.push(c),f.addObject(c))}),this.tileMap=new a.GameTileMap("combat"),this.tileMap.once("loaded",function(){var b=d.encounterInfo,c=b.target||b.map;_.each(e.tileMap.getLayers(),function(a){a.visible=a.name===c}),e.tileMap.dirtyLayers=!0,e.tileMap.addComponent(new a.CombatCameraComponent),f.addObject(e.tileMap),a.GameStateModel.getDataSource(function(b){for(var c=b.getSheetData("enemies"),g=d.encounter.enemies.length,h=0;g>h;h++){var i=_.where(c,{id:d.encounter.enemies[h]});if(0!==i.length){var j=new a.CreatureModel(i[0]),k=new a.GameEntityObject({model:j});f.addObject(k),k.addComponent(new a.SpriteComponent({name:"enemy",icon:k.model.get("icon")})),e.machine.enemies.push(k)}}e.machine.enemies.length?(_.each(e.machine.party,function(b,c){var d=e.tileMap.getFeature("p"+(c+1));b.setPoint(new a.Point(d.x/16,d.y/16))}),_.each(e.machine.enemies,function(b,c){var d=e.tileMap.getFeature("e"+(c+1));d&&b.setPoint(new a.Point(d.x/16,d.y/16))}),d.trigger("combat:begin",e),e.machine.update(e)):d.trigger("combat:end",e)})}),this.tileMap.load()},d.prototype.exit=function(a){a.trigger("combat:end",this);var b=this.parent.world;b&&b.combatScene&&(b.combatScene.destroy(),b.combatScene=null),this.tileMap.destroy(),a.update(this),this.finished=!1,this.machine=null,this.parent=null},d.NAME="combat",d}(a.State);a.GameCombatState=c}(pow2||(pow2={}));var pow2;!function(a){var b=function(a){function b(){a.apply(this,arguments),this.name=b.NAME}return __extends(b,a),b.NAME="default",b}(a.State);a.GameDefaultState=b;var c=function(c){function d(){c.apply(this,arguments),this.model=null,this.defaultState=b.NAME,this.player=null,this.encounterInfo=null,this.encounter=null,this.states=[new b,new a.GameMapState(""),new a.GameCombatState]}return __extends(d,c),d.prototype.onAddToWorld=function(b){c.prototype.onAddToWorld.call(this,b),a.GameStateModel.getDataSource(),this.model=b.model||new a.GameStateModel},d.prototype.setCurrentState=function(a){return c.prototype.setCurrentState.call(this,a)?(this.update(this),!0):!1},d.prototype.update=function(b){if(this.world&&this.world.scene){var d=this.world.scene;this.player=d.objectByComponent(a.PlayerComponent)}c.prototype.update.call(this,b)},d}(a.StateMachine);a.GameStateMachine=c}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.load=function(){var a=this;try{this.data=JSON.parse(this.getCache()),this.data&&_.defer(function(){a.ready()})}catch(b){}Tabletop.init({key:this.url,callback:function(b){b=a.data=a.transformTypes(b),a.setCache(JSON.stringify(b)),a.ready()}})},c.prototype.getCache=function(){return localStorage.getItem(c.DATA_KEY)},c.clearCache=function(){localStorage.removeItem(c.DATA_KEY)},c.prototype.setCache=function(a){localStorage.setItem(c.DATA_KEY,a)},c.prototype.transformTypes=function(b){var c={};return _.each(b,function(b,d){for(var e=b.elements.slice(0),f=e.length,g=0;f>g;g++){var h=e[g];for(var i in h)if(h.hasOwnProperty(i)&&"string"==typeof h[i]){var j=h[i];j.match(a.GameDataResource.NUMBER_MATCHER)?h[i]=parseInt(j):("usedby"===i||"groups"===i||"zones"===i||"enemies"===i)&&(h[i]=/^\s*$/.test(j)?null:j.split("|"))}}c[d.toLowerCase()]=e}),c},c.prototype.getSheetData=function(a){if(!this.isReady())throw new Error("Cannot query spreadsheet before it's loaded");return this.data[a]?this.data[a]:[]},c.DATA_KEY="__db",c.NUMBER_MATCHER=/^-?\d+$/,c}(a.Resource);a.GameDataResource=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(c){b.call(this,c),this.combatScene=null,this.scene||this.setService("scene",new a.Scene)}return __extends(c,b),c.prototype.randomEncounter=function(b){var c=this;a.GameStateModel.getDataSource(function(a){var d=_.filter(a.getSheetData("encounters"),function(a){return-1!==_.indexOf(a.zones,b.map)||-1!==_.indexOf(a.zones,b.target)});if(0===d.length)throw new Error("No valid encounters for this zone");var e=d.length-1,f=0,g=d[Math.floor(Math.random()*(e-f+1))+f];c._encounter(b,g)})},c.prototype.fixedEncounter=function(b,c){var d=this;a.GameStateModel.getDataSource(function(a){var e=_.where(a.getSheetData("encounters"),{id:c});if(0===e.length)throw new Error("No encounter found with id: "+c);d._encounter(b,e[0])})},c.prototype._encounter=function(a,b){this.scene.trigger("combat:encounter",this),this.state.encounter=b,this.state.encounterInfo=a,this.state.setCurrentState("combat")},c}(a.SceneWorld);a.GameWorld=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.featureHash={}}return __extends(c,b),c.prototype.loaded=function(){if(b.prototype.loaded.call(this),this.buildAStarGraph(),this.addComponent(new a.GameFeatureInputComponent),this.map.properties){var c=this.map.properties;c.combat===!0&&this.addComponent(new a.CombatEncounterComponent),"string"==typeof c.music&&this.addComponent(new a.SoundComponent({url:c.music,volume:.1,loop:!0}))}this.buildFeatures()},c.prototype.destroy=function(){return this.unloaded(),b.prototype.destroy.call(this)},c.prototype.unloaded=function(){this.removeComponentByType(a.GameFeatureInputComponent),this.removeComponentByType(a.CombatEncounterComponent),this.removeComponentByType(a.SoundComponent),this.removeFeaturesFromScene(),b.prototype.unloaded.call(this)},c.prototype.featureKey=function(a,b){return""+a+"_"+b},c.prototype.getFeature=function(a){return _.find(this.features.objects,function(b){return b.name===a})},c.prototype.addFeature=function(a){a._object=this.createFeatureObject(a),this.scene.addObject(a._object),this.indexFeature(a._object)},c.prototype.indexFeature=function(a){var b=this.featureKey(a.point.x,a.point.y),c=this.featureHash[b];c||(c=this.featureHash[b]={}),c[a.type]=a.feature.properties},c.prototype.addFeaturesToScene=function(){var a=this;_.each(this.features.objects,function(b){b._object=a.createFeatureObject(b),a.scene.addObject(b._object)})},c.prototype.removeFeaturesFromScene=function(){_.each(this.features.objects,function(a){var b=a._object;delete a._object,b&&b.destroy()})},c.prototype.buildFeatures=function(){var a=this;return this.removeFeaturesFromScene(),_.each(this.features.objects,function(b){var c=a.featureKey(b.x,b.y),d=a.featureHash[c];d||(d=a.featureHash[c]={}),d[b.type]=b.properties}),this.scene&&this.addFeaturesToScene(),!0},c.prototype.createFeatureObject=function(b){var c="undefined"!=typeof b.properties?b.properties:b,d=_.extend({},c,{tileMap:this,x:Math.round(b.x/this.map.tilewidth),y:Math.round(b.y/this.map.tileheight)}),e=new a.GameFeatureObject(d);this.world.mark(e);var f=null,g=c&&c.type?c.type:b.type;switch(g){case"transition":f=a.PortalFeatureComponent;break;case"treasure":f=a.TreasureFeatureComponent,"undefined"==typeof d.id&&console.error("Treasure must have a given id so it may be hidden");break;case"ship":f=a.ShipFeatureComponent;break;case"store":f=a.StoreFeatureComponent;break;case"encounter":f=a.CombatFeatureComponent,"undefined"==typeof d.id&&console.error("Fixed encounters must have a given id so they may be hidden");break;case"temple":f=a.TempleFeatureComponent;break;default:c&&"TALK"===c.action&&(f=a.DialogFeatureComponent)}if(null!==f){var h=new f;if(!e.addComponent(h))throw new Error("Component "+h.name+" failed to connect to host "+this.name)}return e},c.prototype.buildAStarGraph=function(){for(var a=this,b=this.getLayers(),c=b.length,d=new Array(this.bounds.extent.x),e=0;e<this.bounds.extent.x;e++)d[e]=new Array(this.bounds.extent.y);for(var e=0;e<this.bounds.extent.x;e++)for(var f=0;f<this.bounds.extent.y;f++){for(var g=10,h=!1,i=0;c>i;i++){var j=this.getTileData(b[i],e,f);j&&(j.passable===!1?(g=1e3,h=!0):j.isPath===!0&&(g=1))}d[e][f]=g}_.each(this.features.objects,function(b){var c=b.properties;if(c){var e=["temple","store","sign"];if(c.passable!==!0&&c.type&&-1!==_.indexOf(e,c.type.toLowerCase())){var f=b.x/b.width|0,g=b.y/b.height|0;!c.passable&&a.bounds.pointInRect(f,g)&&(d[f][g]=100)}}}),this.graph=new Graph(d)},c.prototype.calculatePath=function(b,c){if(!this.graph||!this.graph.nodes)return[];if(b.x>=this.graph.nodes.length||b.x<0)return[];if(b.y>=this.graph.nodes[b.x].length)return[];if(c.x>=this.graph.nodes.length||c.x<0)return[];if(c.y>=this.graph.nodes[c.x].length)return[];var d=this.graph.nodes[b.x][b.y],e=this.graph.nodes[c.x][c.y],f=astar.search(this.graph.nodes,d,e);return _.map(f,function(b){return new a.Point(b.pos.x,b.pos.y)})},c.prototype.getCombatZones=function(b){var c={map:null,target:null,targetPoint:b};this.map&&this.map.properties&&this.map.properties&&"undefined"!=typeof this.map.properties.combatZone&&(c.map=this.map.properties.combatZone);var d=1/this.map.tilewidth,e=_.map(this.zones.objects,function(b){var c=b.x*d,e=b.y*d,f=b.width*d,g=b.height*d;return{bounds:new a.Rect(c,e,f,g),name:b.name}}),f=_.find(e,function(a){return a.bounds.pointInRect(b)&&a.name});return f&&(c.target=f.name),c},c}(a.TileMap);a.GameTileMap=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.feature=null,this.host=null}return __extends(c,b),c.prototype.syncComponent=function(){return this.tileMap=this.host.tileMap,b.prototype.syncComponent.call(this)&&this.tileMap instanceof a.GameTileMap?(this.feature=this.host.feature,!!this.feature):!1},c.prototype.disconnectComponent=function(){return this.feature=null,b.prototype.disconnectComponent.call(this)},c}(a.TileComponent);a.GameComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(c,d){b.call(this,c,d),this.objectRenderer=new a.TileObjectRenderer,this.tileMap=null,this.mouse=null,this._features=null,this._players=null,this._playerRenders=null,this._sprites=null,this._movers=null,this.mouseClick=_.bind(this.mouseClick,this)}return __extends(c,b),c.prototype.onAddToScene=function(a){this.mouse=a.world.input.mouseHook(this,"world"),this.$el.on("click touchstart",this.mouseClick),this.scene.on("map:loaded",this.syncComponents,this)},c.prototype.onRemoveFromScene=function(a){a.world.input.mouseUnhook("world"),this.$el.off("click",this.mouseClick),this.scene.off("map:loaded",this.syncComponents,this)},c.prototype.mouseClick=function(b){var c=this.scene.componentByType(a.PlayerComponent);return c?(a.Input.mouseOnView(b.originalEvent,this.mouse.view,this.mouse),c.path=this.tileMap.calculatePath(c.targetPoint,this.mouse.world),b.preventDefault(),!1):void 0},c.prototype.processCamera=function(){this.cameraComponent=this.findComponent(a.CameraComponent),this.cameraComponent||(this.cameraComponent=this.scene.componentByType(a.PlayerCameraComponent)),b.prototype.processCamera.call(this)},c.prototype.syncComponents=function(){b.prototype.syncComponents.call(this),this._features=null,this._players=null,this._playerRenders=null,this._sprites=null,this._movers=null},c.prototype.renderFrame=function(c){b.prototype.renderFrame.call(this,c),this._features||(this._features=this.scene.objectsByType(a.GameFeatureObject));for(var d=this._features.length,e=0;d>e;e++)this.objectRenderer.render(this._features[e],this._features[e],this);this._playerRenders||(this._playerRenders=this.scene.objectsByComponent(a.PlayerRenderComponent)),d=this._playerRenders.length;for(var e=0;d>e;e++){var f=this._playerRenders[e];this.objectRenderer.render(f,f,this)}this._players||(this._players=this.scene.objectsByComponent(a.PlayerComponent)),d=this._players.length;for(var e=0;d>e;e++){var f=this._players[e];this.objectRenderer.render(f,f,this)}this._sprites||(this._sprites=this.scene.componentsByType(a.SpriteComponent)),d=this._sprites.length;for(var e=0;d>e;e++){var g=this._sprites[e];this.objectRenderer.render(g.host,g,this)}this._movers||(this._movers=this.scene.componentsByType(a.MovableComponent)),d=this._movers.length;for(var e=0;d>e;e++){var h=this._movers[e];if(h.path.length>0){this.context.save();var i=h.path[h.path.length-1].clone();i.x-=.5,i.y-=.5;var j=this.worldToScreen(new a.Rect(i,new a.Point(1,1)));this.context.fillStyle="rgba(10,255,10,0.3)",this.context.fillRect(j.point.x,j.point.y,j.extent.x,j.extent.y),this.context.strokeStyle="rgba(10,255,10,0.9)",this.context.lineWidth=1.5,this.context.strokeRect(j.point.x,j.point.y,j.extent.x,j.extent.y),this.context.restore()}}return this},c.prototype.debugRender=function(b){void 0===b&&(b=[]);var c=this.scene.objectByComponent(a.PlayerComponent);if(c&&b.push("Party: ("+c.point.x+","+c.point.y+")"),this.mouse){var d=this.screenToWorld(this.mouse.point,this.cameraScale).add(this.camera.point).round();b.push("Mouse: "+this.mouse.point+", World: "+d);var e=new a.Rect(d,new a.Point(1,1)),f=e.getHalfSize();e.point.x-=f.x,e.point.y-=f.y;var g=this.worldToScreen(e,1),h=[],i=this.scene.db.queryRect(e,a.SceneObject,h);i&&(_.each(h,function(a){b.push("Hit: "+a)}),this.context.fillStyle="rgba(10,255,10,0.3)",this.context.fillRect(g.point.x,g.point.y,g.extent.x,g.extent.y)),this.context.strokeStyle=i?"rgba(10,255,10,0.9)":"rgba(255,255,255,0.9)",this.context.lineWidth=1.5,this.context.strokeRect(g.point.x,g.point.y,g.extent.x,g.extent.y)}},c}(a.TileMapView);a.GameMapView=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.defaults=function(){return _.extend({},b.DEFAULTS)},b.DEFAULTS={name:"",icon:"",cost:0,hero:null,usedby:null},b}(Backbone.Model);a.ItemModel=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.defaults=function(){return _.extend(a.prototype.defaults.call(this),b.DEFAULTS)},b.DEFAULTS={name:"No Armor",icon:"",defense:0,evade:0,cost:0},b}(a.ItemModel);a.ArmorModel=b}(pow2||(pow2={}));var pow2;!function(a){var b=null,c=function(c){function d(b){c.call(this),this.keyData={},_.extend(this,{gold:200,playerPosition:new a.Point,playerMap:"",combatZone:"world-plains",party:[],inventory:[]},b||{})}return __extends(d,c),d.prototype.initData=function(a){d.getDataSource(a)},d.getDataSource=function(c){b?c&&c(b):a.ResourceLoader.get().loadAsType(a.SPREADSHEET_ID,a.GameDataResource,function(a){b=a,c&&c(a)})},d.prototype.setKeyData=function(a,b){this.keyData[a]=b},d.prototype.getKeyData=function(a){return this.keyData[a]},d.prototype.addInventory=function(a){return this.inventory.push(a),a},d.prototype.removeInventory=function(a){for(var b=0;b<this.inventory.length;b++)if(this.inventory[b].cid===a.cid)return this.inventory.splice(b,1),!0;return!1},d.prototype.addHero=function(a){this.party.push(a),a.game=this},d.prototype.addGold=function(a){this.gold+=a},d.prototype.parse=function(c){if(!b)throw new Error("cannot instantiate inventory without valid data source.\nCall model.initData(loader) first.");try{"string"==typeof c&&(c=JSON.parse(c))}catch(d){return void console.log("Failed to load save game.")}if("undefined"!=typeof c.keyData)try{this.keyData=JSON.parse(c.keyData)}catch(d){console.error("Failed to parse keyData"),this.keyData=c.keyData}var e=[];e=e.concat(_.map(b.getSheetData("weapons"),function(b){return _.extend({instanceModel:new a.WeaponModel(b)},b)})),e=e.concat(_.map(b.getSheetData("armor"),function(b){return _.extend({instanceModel:new a.ArmorModel(b)},b)})),this.inventory=_.map(c.inventory,function(a){var b=_.where(e,{id:a.id})[0];return b.instanceModel}),this.party=_.map(c.party,function(b){return new a.HeroModel(b,{parse:!0})}),_.extend(this,_.omit(c,"party","inventory","keyData"))},d.prototype.toJSON=function(){var b=_.omit(a.data,"party","inventory","keyData","world");b.party=_.map(this.party,function(a){return a.toJSON()}),b.inventory=_.map(this.inventory,function(a){return _.pick(a.attributes,"id")});try{b.keyData=JSON.stringify(this.keyData)}catch(c){console.error("Failed to stringify keyData"),b.keyData={}}return b},d}(a.Events);a.GameStateModel=c}(pow2||(pow2={}));var pow2;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.defaults=function(){return _.extend(a.prototype.defaults.call(this),b.DEFAULTS)},b.prototype.isNoWeapon=function(){return this.attributes.name===b.DEFAULTS.name&&this.attributes.icon===b.DEFAULTS.icon&&this.attributes.attack===b.DEFAULTS.attack&&this.attributes.hit===b.DEFAULTS.hit&&this.attributes.cost===b.DEFAULTS.cost},b.DEFAULTS={name:"No Weapon",icon:"",attack:0,hit:0,cost:0},b}(a.ItemModel);a.WeaponModel=b}(pow2||(pow2={}));var pow2;!function(a){var b=[0,32,96,208,400,672,1056,1552,2184,2976];a.HeroTypes={Warrior:"warrior",LifeMage:"mage",DeathMage:"necromancer",Ranger:"ranger"};var c=function(c){function d(){c.apply(this,arguments)}return __extends(d,c),d.prototype.defaults=function(){return _.extend(c.prototype.defaults.call(this),d.DEFAULTS)},d.prototype.equipArmor=function(a){var b,c=a.get("type");return-1!==_.indexOf(d.ARMOR_TYPES,c)&&(b=this[c],this[c]=a),b},d.prototype.unequipArmor=function(a){var b=a.get("type"),c=this[b];return c&&b?(this[b]=null,!0):!1},d.prototype.getEvasion=function(){var b=this,c=_.reduce(d.ARMOR_TYPES,function(a,c){var d=b[c];return d?a+d.attributes.evade:a},0);return a.EntityModel.BASE_EVASION+this.attributes.agility+c},d.prototype.attack=function(a){var b=this.attributes.strength/2,c=this.weapon?this.weapon.attributes.attack:0,d=b+c,e=1.2*d,f=.8*d,g=Math.max(1,Math.floor(Math.random()*(e-f+1))+f);return this.rollHit(a)?a.damage(g):0},d.prototype.getXPForLevel=function(a){return void 0===a&&(a=this.attributes.level),0==a?0:b[a-1]},d.prototype.getDefense=function(){var a=this;return _.reduce(d.ARMOR_TYPES,function(b,c){var d=a[c];return d?b+d.attributes.defense:b
},0)},d.prototype.getDamage=function(){return(this.weapon?this.weapon.attributes.attack:0)+this.attributes.strength/2|0},d.prototype.awardExperience=function(a){var b=this.attributes.exp+a;return this.set({exp:b}),b>=this.attributes.nextLevelExp?(this.awardLevelUp(),!0):!1},d.prototype.awardLevelUp=function(){var a=this.attributes.level+1,b=this.getHPForLevel(a);this.set({level:a,maxHP:b,strength:this.getStrengthForLevel(a),agility:this.getAgilityForLevel(a),vitality:this.getVitalityForLevel(a),intelligence:this.getIntelligenceForLevel(a),nextLevelExp:this.getXPForLevel(a+1),prevLevelExp:this.getXPForLevel(a)}),this.trigger("levelUp",this)},d.prototype.parse=function(b){var c=this;try{"string"==typeof b&&(b=JSON.parse(b))}catch(e){return console.log("Failed to load save game."),{}}return b?(a.GameStateModel.getDataSource(function(e){if(_.each(d.ARMOR_TYPES,function(d){if(b[d]){var f=_.where(e.getSheetData("armor"),{name:b[d]})[0];f&&(c[d]=new a.ArmorModel(f))}}),b.weapon){var f=_.where(e.getSheetData("weapons"),{name:b.weapon})[0];c.weapon=new a.WeaponModel(f)}}),_.omit(b,_.flatten(["weapon",d.ARMOR_TYPES]))):{}},d.prototype.toJSON=function(){var a=this,b=c.prototype.toJSON.call(this);return this.weapon&&(b.weapon=this.weapon.get("name")),_.each(d.ARMOR_TYPES,function(c){a[c]&&(b[c]=a[c].get("name"))}),b},d.prototype.getHPForLevel=function(a){return void 0===a&&(a=this.attributes.level),Math.floor(this.attributes.vitality*Math.pow(a,1.1))+2*this.attributes.baseVitality},d.prototype.getStrengthForLevel=function(a){return void 0===a&&(a=this.attributes.level),Math.floor(this.attributes.baseStrength*Math.pow(a,.65))},d.prototype.getAgilityForLevel=function(a){return void 0===a&&(a=this.attributes.level),Math.floor(this.attributes.baseAgility*Math.pow(a,.95))},d.prototype.getVitalityForLevel=function(a){return void 0===a&&(a=this.attributes.level),Math.floor(this.attributes.baseVitality*Math.pow(a,.95))},d.prototype.getIntelligenceForLevel=function(a){return void 0===a&&(a=this.attributes.level),Math.floor(this.attributes.baseIntelligence*Math.pow(a,.95))},d.create=function(b,c){var e=null;switch(b){case a.HeroTypes.Warrior:e=new d({type:b,level:0,name:c,icon:"warrior-male.png",baseStrength:10,baseAgility:2,baseIntelligence:1,baseVitality:7,hitpercent:10,hitPercentPerLevel:3});break;case a.HeroTypes.LifeMage:e=new d({type:b,name:c,level:0,icon:"healer-female.png",baseStrength:1,baseAgility:6,baseIntelligence:9,baseVitality:4,hitpercent:5,hitPercentPerLevel:1});break;case a.HeroTypes.Ranger:e=new d({type:b,name:c,level:0,icon:"ranger-female.png",baseStrength:3,baseAgility:10,baseIntelligence:2,baseVitality:5,hitpercent:7,hitPercentPerLevel:2});break;case a.HeroTypes.DeathMage:e=new d({type:b,name:c,level:0,icon:"magician-male.png",baseStrength:2,baseAgility:10,baseIntelligence:4,baseVitality:4,hitpercent:5,hitPercentPerLevel:2});break;default:throw new Error("Unknown character class: "+b)}return e.awardLevelUp(),e.set({hp:e.get("maxHP")}),e},d.MAX_LEVEL=50,d.MAX_ATTR=50,d.ARMOR_TYPES=["head","body","arms","feet","accessory"],d.DEFAULTS={name:"Hero",icon:"",combatSprite:"",type:a.HeroTypes.Warrior,level:1,exp:0,nextLevelExp:0,prevLevelExp:0,hp:0,maxHP:6,description:"",baseStrength:0,baseAgility:0,baseIntelligence:0,baseVitality:0,hitpercent:5,hitPercentPerLevel:1,evade:0},d}(a.EntityModel);a.HeroModel=c}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.defaults=function(){return _.extend(b.prototype.defaults.call(this),c.DEFAULTS)},c.prototype.attack=function(a){var b=a,c=b.getDefense(),d=this.attributes.attacklow,e=this.attributes.attackhigh,f=Math.floor(Math.random()*(e-d+1))+d;return this.rollHit(a)?a.damage(Math.max(1,f-c)):0},c.fromName=function(b){var d=a.getData("creatures"),e=_.where(d,{name:b})[0];return new c(e)},c.fromLevel=function(b){var d=a.getData("creatures");if(!d)throw new Error("Creature data set is missing.");var e=_.where(d,{level:b}),f=e[Math.floor(Math.random()*e.length)];return new c(f)},c.DEFAULTS={name:"Unnamed Creature",icon:"noIcon.png",groups:[],level:0,hp:0,exp:0,strength:0,numAttacks:0,armorClass:0,description:"",evade:0,hitpercent:1},c}(a.EntityModel);a.CreatureModel=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.enter=function(b){var c=this;a.prototype.enter.call(this,b),b.keyListener=function(a){return c.keyPress(b,a.keyCode)===!1?(a.preventDefault(),!1):!0},$(window).on("keypress",b.keyListener)},b.prototype.exit=function(b){$(window).off("keypress",b.keyListener),b.keyListener=null,a.prototype.exit.call(this,b)},b.prototype.keyPress=function(){return!0},b}(a.State);a.CombatState=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(a){function b(c){a.call(this),this.name=b.NAME,this.mapName=c}return __extends(b,a),b.prototype.enter=function(b){var c=this;a.prototype.enter.call(this,b),this.mapName&&b.player&&(b.player.scene.once("map:loaded",function(){c.mapPoint&&b.player.setPoint(c.mapPoint)}),b.player.tileMap.load(this.mapName)),console.log("MAPPPPPPP")},b.prototype.exit=function(a){if(!a.player)throw new Error("Defensive exception: I _think_ this state needs a player.");if(!a.player.tileMap)throw new Error("Defensive exception: The player must have a tileMap.");this.mapName=a.player.tileMap.mapName,this.mapPoint=a.player.point.clone()},b.NAME="map",b}(a.State);a.GameMapState=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(a){function b(b){a.call(this,_.omit(b||{},["x","y","type"])),this.feature=b,this.point.x=b.x,this.point.y=b.y,this.type=b.type,this.frame="undefined"!=typeof b.frame?b.frame:0,this.groups="string"==typeof b.groups?b.groups.split("|"):b.groups,this.category=b.category}return __extends(b,a),b}(a.TileObject);a.GameFeatureObject=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this._tasks=[],this._animationKeys=[],this._currentAnim=null}return __extends(c,b),c.prototype.play=function(a){var b=a;b.elapsed=0,b.move&&(b.startFrame=this.host.frame,b.start=this.host.point.clone(),b.target=this.host.point.clone().add(b.move),b.value=this.host.point.clone()),"undefined"==typeof b.duration&&(b.duration=0),this._tasks.push(b)},c.prototype.stop=function(a){for(var b=0;b<this._tasks.length;b++){var c=this._tasks[b];c.name===a.name&&(c.complete=!0)}},c.prototype.removeCompleteTasks=function(){for(var a=0;a<this._tasks.length;a++){var b=this._tasks[a];b.complete===!0&&(this._tasks.splice(a,1),b.done&&b.done(b),b.callback&&b.callback(b),this.trigger(c.EVENTS.Stopped,{task:b,component:this}),a--)}},c.prototype.interpolateTick=function(a){b.prototype.interpolateTick.call(this,a),this.update(a),this.removeCompleteTasks()},c.prototype.update=function(b){var c=this;0!==this._tasks.length&&_.each(this._tasks,function(d){if(d.elapsed>d.duration&&(d.complete=!0,d.elapsed=d.duration),d.duration>0){var e=d.elapsed/d.duration;if(d.move&&d.move instanceof a.Point&&c.host.point.set(d.value.interpolate(d.start,d.target,e)),d.frames&&d.frames.length){var f=Math.round(c.interpolate(0,d.frames.length-1,e)),g=d.frames[f];c.host.frame=g}}d.complete||(d.elapsed+=b)})},c.prototype.interpolate=function(a,b,c){return c=Math.min(Math.max(c,0),1),a*(1-c)+b*c},c.prototype.playChain=function(a,b){"undefined"!=typeof b&&a.push({name:"Chain Callback",duration:0,callback:b}),this._animationKeys=a,this._animateNext()},c.prototype._animateNext=function(){var a=this;0!==this._animationKeys.length&&(this._currentAnim=this._animationKeys.shift(),this._currentAnim.done=function(){_.defer(function(){a._animateNext()})},this.play(this._currentAnim))},c.EVENTS={Started:"start",Stopped:"stop",Repeated:"repeat"},c}(a.TickedComponent);a.AnimatedComponent=b}(pow2||(pow2={}));var pow2;!function(a){!function(a){a[a.LEFT=10]="LEFT",a[a.RIGHT=4]="RIGHT",a[a.DOWN=7]="DOWN",a[a.UP=1]="UP",a[a.LEFTALT=11]="LEFTALT",a[a.RIGHTALT=5]="RIGHTALT",a[a.DOWNALT=8]="DOWNALT",a[a.UPALT=2]="UPALT"}(a.MoveFrames||(a.MoveFrames={}));a.MoveFrames;!function(a){a[a.WEST=0]="WEST",a[a.EAST=1]="EAST",a[a.SOUTH=2]="SOUTH",a[a.NORTH=3]="NORTH"}(a.Headings||(a.Headings={}));var b=(a.Headings,function(b){function c(){b.apply(this,arguments),this._animator=new a.Animator,this.heading=0,this.animating=!1}return __extends(c,b),c.prototype.connectComponent=function(){return b.prototype.connectComponent.call(this)?(this._animator.setAnimationSource(this.host.icon),!0):!1},c.prototype.setHeading=function(a,b){switch(this.heading=a,this.heading){case 2:this._animator.setAnimation("down");break;case 3:this._animator.setAnimation("up");break;case 1:this._animator.setAnimation("right");break;case 0:this._animator.setAnimation("left")}this.animating=b},c.prototype.setMoving=function(a){this.animating=a},c.prototype.interpolateTick=function(a){b.prototype.interpolateTick.call(this,a),this.animating&&this._animator.updateTime(a),this.host.frame=this._animator.getFrame()},c}(a.TickedComponent));a.PlayerRenderComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.passableKeys=["passable"],this.collideTypes=["temple","store","sign"],this._lastFrame=3,this._renderFrame=3,this.heading=new a.Point(0,-1),this.sprite=null}return __extends(c,b),c.prototype.syncComponent=function(){return this.sprite=this.host.findComponent(a.PlayerRenderComponent),b.prototype.syncComponent.call(this)},c.prototype.tick=function(a){this._lastFrame=this._renderFrame>3?this._renderFrame-4:this._renderFrame,b.prototype.tick.call(this,a)},c.prototype.interpolateTick=function(a){if(b.prototype.interpolateTick.call(this,a),this.sprite){var c=this.targetPoint.x!==this.host.renderPoint.x,d=this.targetPoint.y!==this.host.renderPoint.y;this.velocity.y>0&&d?(this.sprite.setHeading(2,d),this.heading.set(0,1)):this.velocity.y<0&&d?(this.sprite.setHeading(3,d),this.heading.set(0,-1)):this.velocity.x<0&&c?(this.sprite.setHeading(0,c),this.heading.set(-1,0)):this.velocity.x>0&&c?(this.sprite.setHeading(1,c),this.heading.set(1,0)):this.velocity.y>0?(this.sprite.setHeading(2,!1),this.heading.set(0,1)):this.velocity.y<0?(this.sprite.setHeading(3,!1),this.heading.set(0,-1)):this.velocity.x<0?(this.sprite.setHeading(0,!1),this.heading.set(-1,0)):this.velocity.x>0?(this.sprite.setHeading(1,!1),this.heading.set(1,0)):this.sprite.setMoving(!1)}},c.prototype.collideMove=function(b,c,d){void 0===d&&(d=[]);var e=this.collider.collide(b,c,a.GameFeatureObject,d);if(e)for(var f=0;f<d.length;f++){var g=d[f];if(g.passable===!0||!g.type)return!1;if(-1!==_.indexOf(this.collideTypes,g.type.toLowerCase()))return!0}var h=this.host.scene.objectByType(a.TileMap);if(h)for(var i=h.getLayers(),f=0;f<i.length;f++){var j=h.getTileData(i[f],b,c);if(j)for(var k=0;k<this.passableKeys.length;k++)if(j[this.passableKeys[k]]===!1)return!0}return!1},c.prototype.beginMove=function(b,c){this.host.trigger("move:begin",this,b,c);var d=[],e=this.collider.collide(c.x,c.y,a.GameFeatureObject,d);if(e)for(var f=0;f<d.length;f++){var g=d[f],h=g.findComponent(a.TileComponent);if(h&&h.enter&&(console.log("Collide -> "+g.type),h.enter(this.host)===!1))return}},c.prototype.endMove=function(b,c){if(this.collider){this.host.trigger("move:end",this,b,c);var d=this.collider.collideFirst(b.x,b.y,a.GameFeatureObject);if(d){var e=d.findComponent(a.TileComponent);e&&e.exited(this.host)}var f=this.collider.collideFirst(c.x,c.y,a.GameFeatureObject);if(f){var e=f.findComponent(a.TileComponent);e&&e.entered(this.host)}}},c}(a.MovableComponent);a.PlayerComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.started=!1}return __extends(c,b),c.prototype.syncComponent=function(){var c=this;if(!b.prototype.syncComponent.call(this))return!1;this.animation=this.host.findComponent(a.AnimatedSpriteComponent),this.sprite=this.host.findComponent(a.SpriteComponent),this.sound=this.host.findComponent(a.SoundComponent);var d=!(!this.animation||!this.sprite);return!this.started&&d&&(this.started=!0,this.animation.once("animation:done",function(){c.trigger("damage:done",c)})),d},c}(a.SceneComponent);a.DamageComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.syncComponent=function(){return a.prototype.syncComponent.call(this)?(this.host.visible=this.host.enabled=!this.getDataHidden(),!0):!1},b.prototype.setDataHidden=function(a){void 0===a&&(a=!0),this.host&&this.host.world&&this.host.world.model&&this.host.id&&(this.host.world.model.setKeyData(""+this.host.id,{hidden:a}),this.syncComponent())},b.prototype.getDataHidden=function(){if(this.host&&this.host.world&&this.host.world.model&&this.host.id){var a=this.host.world.model.getKeyData(""+this.host.id);if(a&&a.hidden)return!0}return!1},b}(a.GameComponent);a.GameFeatureComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.hitBox=new a.Rect(0,0,1,1),this.hits=[],this.mouse=null}return __extends(c,b),c.prototype.syncComponent=function(){return b.prototype.syncComponent.call(this)&&this.scene&&this.scene.world&&this.scene.world.input?(this.mouse=this.scene.world.input.getMouseHook("world"),!!this.mouse):!1},c.prototype.tick=function(c){this.scene&&this.mouse&&(_.each(this.hits,function(a){a.scale=1}),this.hits.length=0,this.hitBox.point.set(this.mouse.world),this.scene.db.queryRect(this.hitBox,a.GameFeatureObject,this.hits),_.each(this.hits,function(a){a.scale=1.25}),b.prototype.tick.call(this,c))},c}(a.TickedComponent);a.GameFeatureInputComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.connectComponent=function(){return b.prototype.connectComponent.call(this)&&!!this.host.findComponent(a.PlayerComponent)},c.prototype.process=function(a){b.prototype.process.call(this,a),a.camera.setCenter(this.host.renderPoint||this.host.point),this.host.tileMap&&(a.camera.point.x=Math.min(a.camera.point.x,this.host.tileMap.bounds.extent.x-a.camera.extent.x),a.camera.point.y=Math.min(a.camera.point.y,this.host.tileMap.bounds.extent.y-a.camera.extent.y),a.camera.point.x=Math.max(0,a.camera.point.x),a.camera.point.y=Math.max(0,a.camera.point.y),this.host.tileMap.bounds.extent.x<a.camera.extent.x&&(a.camera.point.x=(this.host.tileMap.bounds.extent.x-a.camera.extent.x)/2),this.host.tileMap.bounds.extent.y<a.camera.extent.y&&(a.camera.point.y=(this.host.tileMap.bounds.extent.y-a.camera.extent.y)/2))},c}(a.CameraComponent);a.PlayerCameraComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.collider=null,this.player=null,this.touch=null,this.touchedComponent=null}return __extends(c,b),c.prototype.syncComponent=function(){return b.prototype.syncComponent.call(this),this.player=this.host.findComponent(a.PlayerComponent),this.collider=this.host.findComponent(a.CollisionComponent),!(!this.player||!this.collider)},c.prototype.tick=function(c){if(b.prototype.tick.call(this,c),this.player&&this.collider){var d=[],e=this.collider.collide(this.host.point.x+this.player.heading.x,this.host.point.y+this.player.heading.y,a.GameFeatureObject,d),f=_.find(d,function(b){return!!b.findComponent(a.GameFeatureComponent)});if(e&&f){var g=f.findComponent(a.GameFeatureComponent),h=this.touchedComponent?this.touchedComponent.id:null;this.touchedComponent&&this.touchedComponent.id!==g.id&&(this.touchedComponent.exit(this.host),this.touchedComponent=null),this.touchedComponent=g,g.id!==h&&this.touchedComponent.enter(this.host),this.touch=f}else this.touchedComponent&&(this.touchedComponent.exit(this.host),this.touchedComponent=null),this.touch=null}},c}(a.TickedComponent);a.PlayerTouchComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.enter=function(b){if(this.party=b.findComponent(a.PlayerComponent),!this.party)return!1;var c=this.host.tileMap.getCombatZones(this.party.host.point);return this.host.world.fixedEncounter(c,this.host.id),this.setDataHidden(!0),!0},c.prototype.exited=function(a){return b.prototype.exited.call(this,a)},c}(a.GameFeatureComponent);a.CombatFeatureComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.syncComponent=function(){return a.prototype.syncComponent.call(this)?(this.title=this.feature.title,this.text=this.feature.text,this.icon=this.feature.icon,!0):!1},b.prototype.enter=function(a){return a.scene.trigger("dialog:entered",this),!0},b.prototype.exit=function(a){return a.scene.trigger("dialog:exited",this),!0},b}(a.GameFeatureComponent);a.DialogFeatureComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.syncComponent=function(){return b.prototype.syncComponent.call(this)?(this.map=this.feature.target,this.target=new a.Point(this.feature.targetX,this.feature.targetY),!!this.map):!1},c.prototype.entered=function(a){var b=this;if(!this.target||!this.tileMap)return!1;var c=this.host.tileMap.mapName;return a.scene.once("map:loaded",function(){console.log("Transition from "+c+" to "+b.map),a.setPoint(b.target)}),this.tileMap.load(this.map),!0},c}(a.GameFeatureComponent);a.PortalFeatureComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.syncComponent=function(){if(b.prototype.syncComponent.call(this)){var c=this.host.world;if(c&&c.state){var d=c.state.model,e=d.getKeyData("shipPosition");e&&this.host.setPoint(new a.Point(e.x,e.y))}}return!1},c.prototype.enter=function(b){return this.tileMap?(this.party=b.findComponent(a.PlayerComponent),this.party?(this.party.passableKeys=["shipPassable","passable"],!0):!1):!1},c.prototype.entered=function(a){return this.board(a)},c.prototype.board=function(a){var b=this;return this.partyObject||!this.party?!1:(this.partyObject=a,this.partySprite=a.setSprite(this.host.icon),this.host.visible=!1,this.host.enabled=!1,this.party.setMoveFilter(function(a,c){var d=b.tileMap.getTerrain("Terrain",a.x,a.y),e=b.tileMap.getTerrain("Terrain",c.x,c.y);d&&e&&d.shipPassable&&e.passable&&b.disembark(a)}),!0)},c.prototype.disembark=function(a){this.partyObject.setSprite(this.partySprite),this.party.clearMoveFilter(),this.party.passableKeys=["passable"],this.host.point.set(a||this.partyObject.point),this.host.visible=!0,this.host.enabled=!0,this.partyObject=null,this.party=null;var b=this.host.world;b&&b.state&&b.state.model&&b.state.model.setKeyData("shipPosition",this.host.point)},c}(a.GameFeatureComponent);a.ShipFeatureComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.syncComponent=function(){var c=this;if(!b.prototype.syncComponent.call(this))return!1;this.name=this.feature.name;var d=-1!==_.indexOf(this.host.groups,"weapon");return d?this.inventory=_.filter(a.data.weapons,function(a){return a.level===c.feature.level}):-1!==_.indexOf(this.host.groups,"armor")&&(this.inventory=_.filter(a.data.armor,function(a){return a.level===c.feature.level})),!0},c.prototype.disconnectComponent=function(){return this.inventory=null,b.prototype.disconnectComponent.call(this)},c.prototype.enter=function(a){return a.scene.trigger("store:entered",this),!0},c.prototype.exit=function(a){return a.scene.trigger("store:exited",this),!0},c}(a.GameFeatureComponent);a.StoreFeatureComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.syncComponent=function(){return a.prototype.syncComponent.call(this)?(this.name="Temple",this.cost=this.feature.cost,this.icon=this.feature.icon,!0):!1},b.prototype.enter=function(a){return a.scene.trigger("temple:entered",this),!0},b.prototype.exit=function(a){return a.scene.trigger("temple:exited",this),!0},b}(a.GameFeatureComponent);a.TempleFeatureComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.syncComponent=function(){return a.prototype.syncComponent.call(this)?(this.name="Treasure Chest",this.gold=this.feature.gold,this.item=this.feature.item,this.icon=this.feature.icon,!0):!1},b.prototype.enter=function(a){return a.scene.trigger("treasure:entered",this),this.setDataHidden(!0),!0},b}(a.GameFeatureComponent);a.TreasureFeatureComponent=b}(pow2||(pow2={}));var pow2;!function(a){a.COMBAT_ENCOUNTERS={FIXED:"fixed",RANDOM:"random"}}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.connectComponent=function(){return b.prototype.connectComponent.call(this)&&this.host instanceof a.GameTileMap},c.prototype.process=function(c){return this.host?(c.cameraScale=c.context.canvas.width>768?4:2,c.camera=c.screenToWorld(new a.Rect(0,0,c.context.canvas.width,c.context.canvas.height),c.cameraScale),void(c.camera.point.x=this.host.bounds.extent.x/2-c.camera.extent.x/2)):void b.prototype.process.call(this,c)},c}(a.CameraComponent);a.CombatCameraComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){!function(a){a[a.DEFAULT=10]="DEFAULT",a[a.SWING=1]="SWING",a[a.INJURED=2]="INJURED",a[a.WALK=3]="WALK",a[a.STRIKE=3]="STRIKE",a[a.CELEBRATE=4]="CELEBRATE",a[a.DEAD=5]="DEAD"}(b.StateFrames||(b.StateFrames={}));var c=(b.StateFrames,function(b){function c(){b.apply(this,arguments),this._elapsed=0,this._renderFrame=3,this.state="",this.animating=!1,this.animator=null}return __extends(c,b),c.prototype.syncComponent=function(){return this.animator=this.host.findComponent(a.AnimatedComponent),b.prototype.syncComponent.call(this)},c.prototype.tick=function(a){if(this._elapsed+=a,!(this._elapsed<this.tickRateMS)){if(this._elapsed=this._elapsed%this.tickRateMS,this.host.model){var c=this.host.model.get("hp"),d=Math.max(.01,this.host.model.get("maxHP")),e=c/d;0===e?this.state="Dead":.5>e&&(this.state="Injured")}b.prototype.tick.call(this,a)}},c.prototype.setState=function(a){void 0===a&&(a="Default"),this.state=a},c.prototype.attack=function(a,b){this.animator&&!this.animating&&this._attack(a,b)},c.prototype.getAttackAnimation=function(b){var c=this;return[{name:"Move Forward for Attack",repeats:0,duration:250,frames:[9,11,10],move:new a.Point(-1,0),callback:function(){c.host.setSprite(c.host.icon.replace(".png","-attack.png"),12)}},{name:"Strike at Opponent",repeats:1,duration:100,frames:[12,13,14,15,14,13,12],callback:function(){c.host.setSprite(c.host.icon.replace("-attack.png",".png"),10),b&&b()}},{name:"Return to Party",duration:250,repeats:0,frames:[10,11,9],move:new a.Point(1,0)}]},c.prototype._attack=function(a,b){var c=this,d=this.getAttackAnimation(a),e=_.map(d,function(a){var b=_.extend({},a);return"undefined"!=typeof b.move&&(b.move=b.move.clone()),b});this.animating=!0,this.animator.playChain(e,function(){c.animating=!1,b&&b()})},c.prototype.interpolateTick=function(a){if(b.prototype.interpolateTick.call(this,a),!this.animating){var c=this._elapsed/this.tickRateMS,d=!!(c>0&&.5>c),e=10;switch(this.state){case"Injured":e=10;break;case"Dead":e=10;break;case"Attacking":e=d?3:1}this.host.frame=this._renderFrame=e}},c}(a.TickedComponent));b.PlayerCombatRenderComponent=c}(b=a.combat||(a.combat={}))}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(c,d){b.call(this,c,d),this.objectRenderer=new a.TileObjectRenderer,this.mouse=null,this.mouseClick=_.bind(this.mouseClick,this)}return __extends(c,b),c.prototype.onAddToScene=function(a){this.mouse=a.world.input.mouseHook(this,"combat"),this.$el.on("click touchstart",this.mouseClick)},c.prototype.onRemoveFromScene=function(a){a.world.input.mouseUnhook("combat"),this.$el.off("click touchstart",this.mouseClick)},c.prototype.mouseClick=function(b){var c=[];a.Input.mouseOnView(b.originalEvent,this.mouse.view,this.mouse),this.world.combatScene.db.queryPoint(this.mouse.world,a.GameEntityObject,c)&&this.world.combatScene.trigger("click",this.mouse,c)},c.prototype.processCamera=function(){this.cameraComponent=this.scene.componentByType(a.CombatCameraComponent),b.prototype.processCamera.call(this)},c.prototype.renderFrame=function(c){var d=this;b.prototype.renderFrame.call(this,c);var e=this.scene.objectsByComponent(a.combat.PlayerCombatRenderComponent);_.each(e,function(a){d.objectRenderer.render(a,a,d)});var f=this.scene.componentsByType(a.SpriteComponent);return _.each(f,function(a){d.objectRenderer.render(a.host,a,d)}),this},c}(a.TileMapView);a.GameCombatView=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.name=c.NAME,this.transitions=[new a.CombatEndTurnTransition],this.attacksLeft=0}return __extends(c,b),c.prototype.enter=function(a){b.prototype.enter.call(this,a),this.machine=a,a.currentDone=!1,this.attacksLeft=1,a.current.scale=1.25,this.current=a.current,a.current&&a.isFriendlyTurn()&&(a.focus=a.current),a.current.scene.on("click",this.sceneClick,this),a.trigger("combat:beginTurn",a.current),a.isFriendlyTurn()||this.attack(a)},c.prototype.exit=function(a){this.current.scale=1,a.current.scene.off("click",this.sceneClick,this),b.prototype.exit.call(this,a)},c.prototype.sceneClick=function(a,b){this.machine&&this.attack(this.machine,b[0])},c.prototype.keyPress=function(a,c){if(!a.isFriendlyTurn())return!0;switch(c){case 13:this.attack(a);break;default:return b.prototype.keyPress.call(this,a,c)}return!1},c.prototype.attack=function(b,c){if(!(this.attacksLeft<=0)){this.attacksLeft-=1;var d=null;b.isFriendlyTurn()?(d=b.current,c=c||b.getRandomEnemy()):(d=b.current,c=c||b.getRandomPartyMember());var e=d.findComponent(a.combat.PlayerCombatRenderComponent),f=function(){var f=d.model.attack(c.model),g=c.model.get("hp")<=0,h=f>0,i="/data/sounds/"+(g?"killed":h?"hit":"miss"),j=c.findComponent(a.SpriteComponent),k={animation:new a.AnimatedSpriteComponent({spriteName:"attack",lengthMS:350}),sprite:new a.SpriteComponent({name:"attack",icon:h?"animHit.png":"animMiss.png"}),damage:new a.DamageComponent,sound:new a.SoundComponent({url:i,volume:.3})},l=b.isFriendlyTurn()&&!!j;l&&(j.frame=1),e&&e.setState("Moving"),c.addComponentDictionary(k),b.currentDone=!0,b.trigger("combat:attack",f,d,c),k.damage.once("damage:done",function(){e&&e.setState(),g&&c.model instanceof a.CreatureModel&&c.destroy(),l&&_.delay(function(){j.frame=0},500),c.removeComponentDictionary(k)})};e?e.attack(f):_.delay(function(){f()},1e3)}},c.NAME="Combat Begin Turn",c}(a.CombatState);a.CombatBeginTurnState=b;var c=function(a){function c(){a.apply(this,arguments),this.targetState=b.NAME}return __extends(c,a),c.prototype.evaluate=function(b){return a.prototype.evaluate.call(this,b)&&null!==b.current&&b.currentDone===!0},c}(a.StateTransition);a.CombatBeginTurnTransition=c}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.name=c.NAME}return __extends(c,b),c.prototype.enter=function(a){b.prototype.enter.call(this,a),console.log("SORRY BRO, YOU LOSE."),a.trigger("combat:defeat",a.enemies,a.party),a.update(this)},c.prototype.update=function(b){b.parent.setCurrentState(a.GameMapState.NAME)},c.NAME="Combat Defeat",c}(a.CombatState);a.CombatDefeatState=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.name=c.NAME,this.transitions=[new a.CombatCompletedTransition,new a.CombatStartTransition,new a.CombatBeginTurnTransition]}return __extends(c,b),c.prototype.enter=function(a){for(b.prototype.enter.call(this,a),a.current=null;a.turnList.length>0&&!a.current;)a.current=a.turnList.shift(),a.current&&a.current.isDefeated()&&(a.current=null);a.update(this)},c.NAME="Combat End Turn",c}(a.CombatState);a.CombatEndTurnState=b;var c=function(a){function c(){a.apply(this,arguments),this.targetState=b.NAME}return __extends(c,a),c.prototype.evaluate=function(b){return a.prototype.evaluate.call(this,b)&&b.currentDone===!0},c}(a.StateTransition);a.CombatEndTurnTransition=c}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.name=c.NAME,this.transitions=[new a.CombatBeginTurnTransition]}return __extends(c,b),c.prototype.enter=function(a){b.prototype.enter.call(this,a),a.turnList=_.shuffle(_.union(a.getLiveParty(),a.getLiveEnemies())),a.current=a.turnList.shift(),a.currentDone=!0,a.update(this)},c.NAME="Combat Started",c}(a.CombatState);a.CombatStartState=b;var c=function(a){function c(){a.apply(this,arguments),this.targetState=b.NAME}return __extends(c,a),c.prototype.evaluate=function(b){return a.prototype.evaluate.call(this,b)&&b.currentDone===!0&&0===b.turnList.length&&null===b.current},c}(a.StateTransition);a.CombatStartTransition=c;var d=function(b){function c(){b.apply(this,arguments),this.targetState=""}return __extends(c,b),c.prototype.evaluate=function(c){return b.prototype.evaluate.call(this,c)?c.partyDefeated()?(this.targetState=a.CombatDefeatState.NAME,!0):c.enemiesDefeated()?(this.targetState=a.CombatVictoryState.NAME,!0):!1:!1},c}(a.StateTransition);a.CombatCompletedTransition=d}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.name=c.NAME}return __extends(c,b),c.prototype.enter=function(a){b.prototype.enter.call(this,a);var c=0,d=0;_.each(a.enemies,function(a){c+=a.model.get("gold")||0,d+=a.model.get("exp")||0}),a.parent.model.addGold(c);var e=_.reject(a.party,function(a){return a.isDefeated()}),f=Math.round(d/e.length),g=[];_.each(e,function(a){var b=a.model,c=b.awardExperience(f);c&&g.push(b)});var h={state:this,party:a.party,enemies:a.enemies,levels:g,gold:c,exp:d};a.trigger("combat:victory",h)},c.prototype.update=function(b){b.parent.setCurrentState(a.GameMapState.NAME)},c.NAME="Combat Victory",c}(a.CombatState);a.CombatVictoryState=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.combatFlag=!1,this.combatZone="default",this.isDangerous=!1,this.world=a.getWorld("pow2"),this.player=null}return __extends(c,b),c.prototype.connectComponent=function(){return b.prototype.connectComponent.call(this)&&this.host instanceof a.GameTileMap?(this.battleCounter=this.world.model.getKeyData("battleCounter"),"undefined"==typeof this.battleCounter&&this.resetBattleCounter(),!0):!1},c.prototype.disconnectComponent=function(){return this.player&&this.player.off(null,null,this),this.player=null,b.prototype.disconnectComponent.call(this)},c.prototype.syncComponent=function(){return b.prototype.syncComponent.call(this),this.player&&this.player.off(null,null,this),this.player=this.scene.objectByComponent(a.PlayerComponent),this.player&&this.player.on("move:begin",this.moveProcess,this),!!this.player},c.prototype.moveProcess=function(a,b,c){var d=this.host.getTerrain("Terrain",c.x,c.y);this.isDangerous=d&&d.isDangerous;var e=this.isDangerous?10:6;return this.battleCounter<=0&&this.triggerCombat(c),this._setCounter(this.battleCounter-e),!1},c.prototype.resetBattleCounter=function(){var a=255,b=64;this._setCounter(Math.floor(Math.random()*(a-b+1))+b),this.combatFlag=!1},c.prototype.triggerCombat=function(a){var b=this.host.getCombatZones(a);this.combatZone=b.map||b.target,console.log("Combat in zone : "+this.combatZone),this.host.world.randomEncounter(b),this.host.trigger("combat:encounter",this),this.resetBattleCounter(),this.combatFlag=!0},c.prototype._setCounter=function(a){this.battleCounter=a,this.world.model.setKeyData("battleCounter",this.battleCounter)},c}(a.SceneComponent);a.CombatEncounterComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.getAttackAnimation=function(a){var b=this;return[{name:"Prep Animation",callback:function(){b.host.setSprite(b.host.icon.replace(".png","-magic.png"),19)
}},{name:"Magic cast",repeats:0,duration:1e3,frames:[19,18,17,16,15],callback:function(){a&&a()}},{name:"Back to rest",repeats:0,duration:1e3,frames:[15,16,17,18,19],callback:function(){b.host.setSprite(b.host.icon.replace("-magic.png",".png"),10)}}]},b}(a.PlayerCombatRenderComponent);a.MageCombatRenderComponent=b}(b=a.combat||(a.combat={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.getAttackAnimation=function(b){var c=this;return[{name:"Move Forward for Attack",repeats:0,duration:250,frames:[9,11,10],move:new a.Point(-1,0),callback:function(){c.host.setSprite(c.host.icon.replace(".png","-attack.png"),12)}},{name:"Strike at Opponent",repeats:1,duration:100,frames:[12,13,14,15,14,13,12],callback:function(){c.host.setSprite(c.host.icon.replace("-attack.png",".png"),10),b&&b()}},{name:"Return to Party",duration:250,repeats:0,frames:[10,11,9],move:new a.Point(1,0)}]},c}(b.PlayerCombatRenderComponent);b.WarriorCombatRenderComponent=c}(b=a.combat||(a.combat={}))}(pow2||(pow2={}));
//# sourceMappingURL=pow2.min.game.map