
/*!
  pow2 - v0.1.4
  built: 2015-06-13
 */

var pow2;!function(a){function b(b,c){a.data[b]=c}function c(b){return a.data[b]}function d(b,c){a.data.maps[b]=c}function e(b){for(var c in b)b.hasOwnProperty(c)&&(a.data.sprites[c]=_.extend(a.data.sprites[c]||{},b[c]))}function f(b){return-1===b.indexOf(".tmx")?a.GAME_ROOT+"web/maps/"+b+".tmx":b}function g(b,c){for(var d in c)c.hasOwnProperty(d)&&(a.data.sprites[d]=_.defaults(a.data.sprites[d]||{},c[d]))}function h(b){return a.data.sprites[b]}function i(b,c){_.each(c,function(c){a.data.creatures.push(_.extend(c,{level:b}))})}function j(b){return a.data.maps[b]}function k(){return a.data.maps}a.SPREADSHEET_ID="1IAQbt_-Zq1BUwRNiJorvt4iPEYb5HmZrpyMOkb-OuJo",a.NAME="pow2.core",a.GAME_ROOT="",a.data={maps:{},sprites:{},items:{},creatures:[],weapons:[],armor:[]},a.registerData=b,a.getData=c,a.registerMap=d,a.describeSprites=e,a.getMapUrl=f,a.registerSprites=g,a.getSpriteMeta=h,a.registerCreatures=i,a.getMap=j,a.getMaps=k}(pow2||(pow2={}));var pow2;!function(a){var b=function(){function b(){this.interpFrame=0,this.animElapsed=0,this.animDuration=0,this.frames=[0],this.sourceMeta=null,this.sourceAnims=null}return b.prototype.setAnimationSource=function(b){console.log("Sprite is "+b),this.sourceMeta=a.getSpriteMeta(b),this.sourceMeta&&(this.sourceAnims=this.sourceMeta.animations,this.setAnimation("down"))},b.prototype.setAnimation=function(a){if(!this.sourceAnims)throw new Error("Invalid source animations");var b=this.sourceAnims[a];if(!b)throw new Error("Invalid animation name - "+a);this.frames=b.frames,this.animDuration=b.duration},b.prototype.updateTime=function(a){this.animElapsed+=a;var b=this.animElapsed/this.animDuration,c=Math.round(this.interpolate(0,this.frames.length-1,b));this.interpFrame=this.frames[c],this.animElapsed>this.animDuration&&(this.animElapsed=0)},b.prototype.interpolate=function(a,b,c){return c=Math.min(Math.max(c,0),1),a*(1-c)+b*c},b.prototype.getFrame=function(){return this.interpFrame},b}();a.Animator=b}(pow2||(pow2={}));var pow2;!function(a){var b=function(){function a(){this.transitions=[]}return a.prototype.enter=function(a){},a.prototype.exit=function(a){},a.prototype.update=function(a){for(var b=this.transitions.length,c=0;b>c;c++){var d=this.transitions[c];if(d.evaluate(a)&&a.setCurrentState(d.targetState))return}},a}();a.State=b;var c=function(){function a(){}return a.prototype.evaluate=function(a){return!0},a}();a.StateTransition=c}(pow2||(pow2={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.defaultState=null,this.states=[],this._currentState=null,this._previousState=null,this._newState=!1,this._pendingState=null,this._asyncProcessing=0,this._asyncCurrentCallback=null}return __extends(c,b),c.prototype.onAddToWorld=function(a){},c.prototype.onRemoveFromWorld=function(a){},c.prototype.update=function(a){this._newState=!1,null===this._currentState&&this.setCurrentState(this.defaultState),null!==this._currentState&&this._currentState.update(this),this._newState===!1&&null!==this._currentState&&(this._previousState=this._currentState)},c.prototype.addState=function(a){this.states.push(a)},c.prototype.addStates=function(a){this.states=_.unique(this.states.concat(a))},c.prototype.getCurrentState=function(){return this._currentState},c.prototype.getCurrentName=function(){return null!==this._currentState?this._currentState.name:null},c.prototype.setCurrentState=function(a){var b=this,c="string"==typeof a?this.getState(a):a;return c?(null!==this._pendingState&&this._pendingState.name!==c.name?(console.log("Overwriting pending state ("+this._pendingState.name+") with ("+c.name+")"),this._pendingState=c):this._pendingState||(this._pendingState=c,_.defer(function(){c=b._pendingState,b._pendingState=null,b._setCurrentState(c)||console.error("Failed to set state: "+c.name)})),!0):(console.error("STATE NOT FOUND: "+a),!1)},c.prototype._setCurrentState=function(b){if(!b)return!1;var d=this._currentState;return this._currentState&&b.name===this._currentState.name?(console.warn(this._currentState.name+": Attempting to set current state to already active state"),!0):(this._newState=!0,this._previousState=this._currentState,this._currentState=b,c.DEBUG_STATES&&console.log("STATE: "+(d?d.name:"NULL")+" -> "+this._currentState.name),d&&(this.trigger(a.StateMachine.Events.EXIT,d,b),d.exit(this)),b.enter(this),this.trigger(a.StateMachine.Events.ENTER,b,d),!0)},c.prototype.getPreviousState=function(){return this._previousState},c.prototype.getState=function(a){var b=_.find(this.states,function(b){return b.name===a});return b},c.prototype.notify=function(a,b,c){var d=this;if(this._asyncProcessing>0)throw new Error("TODO: StateMachine cannot handle multiple async UI waits");this._asyncCurrentCallback=function(){d._asyncProcessing--,d._asyncProcessing<=0&&(c&&c(),d._asyncProcessing=0)},this._asyncProcessing=0,this.trigger(a,b),0===this._asyncProcessing&&c&&c()},c.prototype.notifyWait=function(){if(!this._asyncCurrentCallback)throw new Error("No valid async callback set!  Perhaps you called this outside of a notify event handler?");return this._asyncProcessing++,this._asyncCurrentCallback},c.DEBUG_STATES=!1,c.Events={ENTER:"enter",EXIT:"exit"},c}(a.Events);a.StateMachine=b;var c=function(a){function b(){a.apply(this,arguments),this.paused=!1}return __extends(b,a),b.prototype.onAddToWorld=function(a){a.time.addObject(this)},b.prototype.onRemoveFromWorld=function(a){a.time.removeObject(this)},b.prototype.tick=function(a){this.update(a)},b}(b);a.TickedStateMachine=c}(pow2||(pow2={}));var pow2;!function(a){var b=function(){function b(){this.canvas=null,this.context=null,this.world=null,this.canvas=document.createElement("canvas"),this.sizeCanvas(b.SIZE,b.SIZE)}return b.prototype.onAddToWorld=function(a){},b.prototype.onRemoveFromWorld=function(a){},b.prototype.sizeCanvas=function(a,b){this.canvas.width=a,this.canvas.height=b,this.context=this.canvas.getContext("2d"),this.context.msImageSmoothingEnabled=!1,this.context.imageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1},b.prototype.getSpriteSheet=function(a,b){return this.world?this.world.loader.load("/images/"+a+".png",b):null},b.prototype.getSingleSprite=function(b,c,d){var e=this;void 0===c&&(c=0),void 0===d&&(d=function(a){});var f=a.data.sprites[b];if(!f)throw new Error("Unable to find sprite by name: "+b);return this.getSpriteSheet(f.source,function(a){var f=e.getSpriteRect(b,c);e.sizeCanvas(f.extent.x,f.extent.y),e.context.clearRect(0,0,e.canvas.width,e.canvas.height),e.context.drawImage(a.data,f.point.x,f.point.y,f.extent.x,f.extent.y,0,0,e.canvas.width,e.canvas.height);var g=e.canvas.toDataURL(),h=new Image;h.src=g,h.onload=function(){d&&d(h)},h.onerror=function(a){d&&d(a)}})},b.prototype.getSpriteRect=function(c,d){void 0===d&&(d=0);var e=this.getSpriteMeta(c),f=e.x,g=e.y;if(e.frames>1){var h=b.SIZE,i=b.SIZE;e&&"undefined"!=typeof e.cellWidth&&"undefined"!=typeof e.cellHeight&&(h=e.cellWidth,i=e.cellHeight);var j=e.width/h,k=d%j,l=Math.floor((d-k)/j);f+=k*h,g+=l*i}else h=e.width,i=e.height;return new a.Rect(f,g,h,i)},b.prototype.getSpriteMeta=function(b){var c=a.data.sprites[b];return c},b.SIZE=16,b}();a.SpriteRender=b}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(b){function c(c){c=_.defaults(c||{},{loader:a.ResourceLoader.get()}),b.call(this,c),this.setService("input",new a.Input),this.setService("sprites",new a.SpriteRender)}return __extends(c,b),c}(a.World);b.SceneWorld=c}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(){function b(){this._pointRect=new a.Rect(0,0,1,1),this._objects=[]}return b.prototype.addSpatialObject=function(b){b&&b.point instanceof a.Point&&this._objects.push(b)},b.prototype.removeSpatialObject=function(a){this._objects=_.reject(this._objects,function(b){return b._uid===a._uid})},b.prototype.queryPoint=function(a,b,c){return this._pointRect.point.set(a),this.queryRect(this._pointRect,b,c)},b.prototype.queryRect=function(a,b,c){var d;if(!c)throw new Error("Results array must be provided to query scene spatial database");d=!1;var e,f,g,h=this._objects;for(e=0,f=h.length;f>e;e++)g=h[e],(!b||g instanceof b)&&g.enabled!==!1&&g.point&&a.pointInRect(g.point)&&(c.push(g),d=!0);return d},b}();b.SceneSpatialDatabase=c}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(a){function c(c){void 0===c&&(c={}),a.call(this),this.id=_.uniqueId("scene"),this.db=new b.SceneSpatialDatabase,this.options={},this._objects=[],this._views=[],this.world=null,this.fps=0,this.time=0,this.paused=!1,this.options=_.defaults(c||{},{debugRender:!1})}return __extends(c,a),c.prototype.destroy=function(){this.world&&this.world.erase(this);for(var a=this._objects.length,b=0;a>b;b++)this.removeObject(this._objects[b],!0);a=this._views.length;for(var b=0;a>b;b++)this.removeView(this._views[b]);this.paused=!0},c.prototype.onAddToWorld=function(a){a.time.addObject(this)},c.prototype.onRemoveFromWorld=function(a){a.time.removeObject(this)},c.prototype.tick=function(a){if(!this.paused)for(var b=this._objects.length,c=0;b>c;c++)this._objects[c]&&this._objects[c].tick(a)},c.prototype.processFrame=function(a){if(!this.paused){this.time=this.world.time.time;for(var b=this._objects.length,c=0;b>c;c++){var d=this._objects[c];d.interpolateTick&&d.interpolateTick(a)}b=this._views.length;for(var c=0;b>c;c++)this._views[c].render(a);var e=a?1e3/a:0;this.fps+=(e-this.fps)/10}},c.prototype.removeIt=function(a,b){var c=this,d=!1;return this[a]=_.filter(this[a],function(a){return b&&a&&a._uid===b._uid?(c.db.removeSpatialObject(a),a.onRemoveFromScene&&a.onRemoveFromScene(c),c.world&&c.world.erase(a),delete a.scene,d=!0,!1):a?!0:!1}),d},c.prototype.addIt=function(a,b){if(b.scene&&b.scene.removeIt(a,b),_.where(this[a],{_uid:b._uid}).length>0)throw new Error("Object added to scene twice");return this[a].push(b),this.world&&this.world.mark(b),this.db.addSpatialObject(b),b.scene=this,b.onAddToScene&&b.onAddToScene(this),!0},c.prototype.findIt=function(a,b){return _.where(this[a],{_uid:b._uid})},c.prototype.addView=function(a){return this.addIt("_views",a)},c.prototype.removeView=function(a){return this.removeIt("_views",a)},c.prototype.findView=function(a){return!!this.findIt("_views",a)},c.prototype.getViewOfType=function(a){return _.find(this._views,function(b){return b instanceof a})},c.prototype.addObject=function(a){return this.addIt("_objects",a)},c.prototype.removeObject=function(a,b){b="undefined"==typeof b?!0:!!b;var c=a,d=this.removeIt("_objects",a);return c&&b&&c.destroy&&c.destroy(),d},c.prototype.findObject=function(a){return!!this.findIt("_objects",a)},c.prototype.componentByType=function(a){for(var b=this._objects,c=this._objects.length,d=0;c>d;d++){var e=b[d],f=e.findComponent(a);if(f)return f}return null},c.prototype.componentsByType=function(a){for(var b=this._objects,c=this._objects.length,d=[],e=0;c>e;e++){var f=b[e],g=f.findComponents(a);g&&(d=d.concat(g))}return d},c.prototype.objectsByName=function(a){for(var b=this._objects,c=this._objects.length,d=[],e=0;c>e;e++){var f=b[e];f.name===a&&d.push(f)}return d},c.prototype.objectByName=function(a){for(var b=this._objects,c=this._objects.length,d=0;c>d;d++){var e=b[d];if(e.name===a)return e}return null},c.prototype.objectsByType=function(a){for(var b=this._objects,c=this._objects.length,d=[],e=0;c>e;e++){var f=b[e];f instanceof a&&d.push(f)}return d},c.prototype.objectByType=function(a){for(var b=this._objects,c=this._objects.length,d=0;c>d;d++){var e=b[d];if(e instanceof a)return e}return null},c.prototype.objectsByComponent=function(a){for(var b=this._objects,c=this._objects.length,d=[],e=0;c>e;e++){var f=b[e];f.findComponent(a)&&d.push(f)}return d},c.prototype.objectByComponent=function(a){for(var b=this._objects,c=this._objects.length,d=0;c>d;d++){var e=b[d];if(e.findComponent(a))return e}return null},c}(a.Events);b.Scene=c}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(b){function c(c){b.call(this),this._uid=_.uniqueId("so"),this._components=[],_.extend(this,_.defaults(c||{}),{point:new a.Point(0,0),size:new a.Point(1,1),enabled:!0})}return __extends(c,b),c.prototype.tick=function(a){if(this.enabled)for(var b=this._components,c=this._components.length,d=0;c>d;d++){if(!b[d])throw new Error("Component deleted during tick, use _.defer to delay removal until the callstack unwinds");b[d].tick&&b[d].tick(a)}},c.prototype.interpolateTick=function(a){if(this.enabled)for(var b=this._components,c=this._components.length,d=0;c>d;d++){if(!b[d])throw new Error("Component deleted during interpolateTick, use _.defer to delay removal until the callstack unwinds");b[d].interpolateTick&&b[d].interpolateTick(a)}},c.prototype.destroy=function(){_.each(this._components,function(a){a.disconnectComponent()}),this._components.length=0,this.scene&&this.scene.removeObject(this,!1)},c.prototype.onAddToScene=function(a){this.syncComponents()},c.prototype.findComponent=function(a){for(var b=this._components,c=this._components.length,d=0;c>d;d++){var e=b[d];if(e instanceof a)return e}return null},c.prototype.findComponents=function(a){for(var b=this._components,c=[],d=this._components.length,e=0;d>e;e++){var f=b[e];f instanceof a&&c.push(f)}return c},c.prototype.findComponentByName=function(a){for(var b=this._components,c=this._components.length,d=0;c>d;d++){var e=b[d];if(e.name===a)return e}return null},c.prototype.syncComponents=function(){for(var a=this._components,b=this._components.length,c=0;b>c;c++)a[c].syncComponent()},c.prototype.addComponent=function(a,b){if(void 0===b&&(b=!1),_.where(this._components,{id:a.id}).length>0)throw new Error("Component added twice");return a.host=this,a.connectComponent()===!1?(delete a.host,console.log("Component "+a.name+" failed to register."),!1):(this._components.push(a),b!==!0&&this.syncComponents(),!0)},c.prototype.addComponentDictionary=function(a,b){var c=this,d=null;return _.each(a,function(a,b){d||c.addComponent(a,!0)||(d=a)}),d?console.log("Failed to add component set to host. Component "+d.toString()+" failed to connect to host."):this.syncComponents(),!d},c.prototype.removeComponentDictionary=function(a,b){var c=this._components.length,d=_.map(a,function(a){return a.id});this._components=_.filter(this._components,function(a){return-1!==_.indexOf(d,a.id)?a.disconnectComponent()===!1?!0:(a.host=null,!1):!0});var e=this._components.length===c;return e&&b!==!0&&this.syncComponents(),e},c.prototype.removeComponentByType=function(a,b){void 0===b&&(b=!1);var c=this.findComponent(a);return c?this.removeComponent(c):!1},c.prototype.removeComponent=function(a,b){void 0===b&&(b=!1);var c=this._components.length;this._components=_.filter(this._components,function(b){return b.id===a.id?b.disconnectComponent()===!1?!0:(b.host=null,!1):!0});var d=this._components.length===c;return d&&b!==!0&&this.syncComponents(),d},c.prototype.toString=function(){var a=this.constructor,b=this.name;return a&&"Function"!=a.name&&(b=a.name||(this.toString().match(/function (.+?)\(/)||[,""])[1]),_.each(this._components,function(a){b+=", "+a}),b},c}(a.Events);b.SceneObject=c}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(c){function d(b,e){if(c.call(this),this.cameraComponent=null,this.scene=null,this.loader=null,this.animations=[],this.canvas=b,!b)throw new Error("A Canvas is required");if(this.$el=$(b),this.context=b.getContext("2d"),!this.context)throw new Error("Could not retrieve Canvas context");var f=this.context;f.webkitImageSmoothingEnabled=!1,f.mozImageSmoothingEnabled=!1,this.camera=new a.Rect(0,0,9,9),this.cameraScale=1,this.unitSize=d.UNIT,this._sheets={},this.loader=e}return __extends(d,c),d.prototype.onAddToWorld=function(a){},d.prototype.onRemoveFromWorld=function(a){},d.prototype.setScene=function(a){this.scene&&this.scene.removeView(this),this.scene=a,this.scene&&this.scene.addView(this)},d.prototype.renderToCanvas=function(a,b,c){var d=document.createElement("canvas");d.width=a,d.height=b;var e=d.getContext("2d");return e.webkitImageSmoothingEnabled=!1,e.mozImageSmoothingEnabled=!1,c(e),d},d.prototype.renderFrame=function(a){var c=this;_.each(this._components,function(d){d instanceof b.SceneViewComponent&&d.renderFrame(c,a)})},d.prototype.renderPost=function(){},d.prototype.setRenderState=function(){this.context&&(this.context.save(),this.context.scale(this.cameraScale,this.cameraScale))},d.prototype.restoreRenderState=function(){return this.context?(this.context.restore(),!0):!1},d.prototype.render=function(){this._render(0)},d.prototype._render=function(a){var c=this;this.processCamera(),this.setRenderState(),_.each(this._components,function(d){d instanceof b.SceneViewComponent&&d.beforeFrame(c,a)}),this.renderFrame(a),this.renderAnimations(),this.renderPost(),_.each(this._components,function(d){d instanceof b.SceneViewComponent&&d.afterFrame(c,a)}),this.restoreRenderState()},d.prototype.processCamera=function(){this.cameraComponent&&this.cameraComponent.process(this)},d.prototype.clearRect=function(){var a,b,c;return b=c=0,this.camera&&(a=this.worldToScreen(this.camera.point),b=a.x,c=a.y),this.context.clearRect(b,c,this.context.canvas.width,this.context.canvas.height)},d.prototype.worldToScreen=function(b,c){if(void 0===c&&(c=1),b instanceof a.Rect){var d=new a.Rect(b);return d.point.multiply(this.unitSize*c),d.extent.multiply(this.unitSize*c),d}return b instanceof a.Point?new a.Point(b).multiply(this.unitSize*c):b*this.unitSize*c},d.prototype.screenToWorld=function(b,c){if(void 0===c&&(c=1),b instanceof a.Rect){var d=new a.Rect(b);return d.point.multiply(1/(this.unitSize*c)),d.extent.multiply(1/(this.unitSize*c)),d}return b instanceof a.Point?new a.Point(b).multiply(1/(this.unitSize*c)):b*(1/(this.unitSize*c))},d.prototype.fastWorldToScreenPoint=function(a,b,c){return void 0===c&&(c=1),b.set(a),b.multiply(this.unitSize*c),b},d.prototype.fastWorldToScreenRect=function(a,b,c){return void 0===c&&(c=1),b.set(a),b.point.multiply(this.unitSize*c),b.extent.multiply(this.unitSize*c),b},d.prototype.fastWorldToScreenNumber=function(a,b){return void 0===b&&(b=1),a*this.unitSize*b},d.prototype.fastScreenToWorldPoint=function(a,b,c){return void 0===c&&(c=1),b.set(a),b.multiply(1/(this.unitSize*c)),b},d.prototype.fastScreenToWorldRect=function(a,b,c){return void 0===c&&(c=1),b.set(a),b.point.multiply(1/(this.unitSize*c)),b.extent.multiply(1/(this.unitSize*c)),b},d.prototype.fastScreenToWorldNumber=function(a,b){return void 0===b&&(b=1),a*(1/(this.unitSize*b))},d.prototype.renderAnimations=function(){var a,b,c;for(a=0,b=this.animations.length;b>a;a++)c=this.animations[a],c.done=c.fn(c.frame),this.scene.time>=c.time&&(c.frame+=1,c.time=this.scene.time+c.rate);return this.animations=_.filter(this.animations,function(a){return a.done!==!0})},d.UNIT=16,d}(b.SceneObject);b.SceneView=c}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){!function(a){a[a.UP=38]="UP",a[a.DOWN=40]="DOWN",a[a.LEFT=37]="LEFT",a[a.RIGHT=39]="RIGHT",a[a.BACKSPACE=8]="BACKSPACE",a[a.COMMA=188]="COMMA",a[a.DELETE=46]="DELETE",a[a.END=35]="END",a[a.ENTER=13]="ENTER",a[a.ESCAPE=27]="ESCAPE",a[a.HOME=36]="HOME",a[a.SPACE=32]="SPACE",a[a.TAB=9]="TAB"}(a.KeyCode||(a.KeyCode={}));var b=(a.KeyCode,function(){function b(){var a=this;this._keysDown={},this._mouseElements=[],window.addEventListener("keydown",function(b){a._keysDown[b.which]=!0}),window.addEventListener("keyup",function(b){a._keysDown[b.which]=!1});var c=this._mouseElements;window.addEventListener("mousemove touchmove",function(a){for(var d=c.length,e=0;d>e;e++){var f=c[e];a.srcElement===f.view.canvas?b.mouseOnView(a,f.view,f):(f.point.set(-1,-1),f.world.set(-1,-1))}})}return b.mouseOnView=function(b,c,d){var e=b.srcElement,f=b.touches;f&&f.length>0&&(b=f[0]);var g=d||{point:new a.Point,world:new a.Point},h=$(e).offset(),i=b.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-Math.floor(h.left),j=b.clientY+document.body.scrollTop+document.documentElement.scrollTop-Math.floor(h.top);g.point.set(i,j);var k=c.screenToWorld(g.point,c.cameraScale).add(c.camera.point).round();return g.world.set(k.x,k.y),g},b.prototype.mouseHook=function(b,c){var d=_.where(this._mouseElements,{name:c});if(d.length>0)return d[0];var e={name:c,view:b,point:new a.Point(-1,-1),world:new a.Point(-1,-1)};return this._mouseElements.push(e),e},b.prototype.mouseUnhook=function(a){this._mouseElements=_.filter(this._mouseElements,function(b){return b.name===a||b.view._uid===a._uid})},b.prototype.getMouseHook=function(a){return _.find(this._mouseElements,function(b){return b.name===a||b.view._uid===a._uid})},b.prototype.keyDown=function(a){return!!this._keysDown[a]},b}());a.Input=b}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments),this.id=_.uniqueId("sc")}return __extends(b,a),b.prototype.connectComponent=function(){return!0},b.prototype.disconnectComponent=function(){return!0},b.prototype.syncComponent=function(){return!0},b.prototype.toString=function(){var a=this.constructor;return a&&"Function"!=a.name?a.name||(this.toString().match(/function (.+?)\(/)||[,""])[1]:this.name},b}(a.Events);b.SceneComponent=c}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(a){var b=function(){function a(){}return a.prototype.render=function(a,b,c){},a}();a.SceneObjectRenderer=b}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.beforeFrame=function(a,b){},b.prototype.renderFrame=function(a,b){},b.prototype.afterFrame=function(a,b){},b}(a.SceneComponent);a.SceneViewComponent=b}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(c){var d=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.process=function(b){b.camera.point.set(this.host.point),b.cameraScale=b.context.canvas.width>768?4:2;var c=b.screenToWorld(new a.Point(b.context.canvas.width,b.context.canvas.height),b.cameraScale);b.camera.extent.set(c)},c}(b.SceneComponent);c.CameraComponent=d}(c=b.components||(b.components={}))}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(c){var d=function(c){function d(){c.apply(this,arguments),this.collideBox=new a.Rect(0,0,1,1),this.resultsArray=[]}return __extends(d,c),d.prototype.collide=function(a,c,d,e){return void 0===d&&(d=b.SceneObject),void 0===e&&(e=[]),this.host&&this.host.scene?(this.collideBox.point.x=a,this.collideBox.point.y=c,this.host.scene.db.queryRect(this.collideBox,d,e)):!1},d.prototype.collideFirst=function(a,c,d){if(void 0===d&&(d=b.SceneObject),!this.host||!this.host.scene)return null;this.collideBox.point.x=a,this.collideBox.point.y=c,this.resultsArray.length=0;var e=this.host.scene.db.queryRect(this.collideBox,d,this.resultsArray);return e?this.resultsArray[0]:null},d}(b.SceneComponent);c.CollisionComponent=d}(c=b.components||(b.components={}))}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments),this.tickRateMS=300}return __extends(b,a),b.prototype.tick=function(a){},b.prototype.interpolateTick=function(a){},b}(a.SceneComponent);b.TickedComponent=c}(b=a.components||(a.components={}))}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(c){var d=function(d){function e(){d.apply(this,arguments),this._elapsed=0,this.path=[],this.tickRateMS=250,this.velocity=new a.Point(0,0),this.workPoint=new a.Point(0,0),this.currentMove=null}return __extends(e,d),e.prototype.connectComponent=function(){return this.host.point.round(),this.targetPoint=this.host.point.clone(),this.host.renderPoint=this.targetPoint.clone(),d.prototype.connectComponent.call(this)},e.prototype.syncComponent=function(){return this.collider=this.host.findComponent(c.CollisionComponent),d.prototype.syncComponent.call(this)},e.prototype.beginMove=function(a){},e.prototype.completeMove=function(a){},e.prototype.collideMove=function(a,c,d){return void 0===d&&(d=[]),this.collider?this.collider.collide(a,c,b.SceneObject,d):!1},e.prototype.updateVelocity=function(){if(this.host.scene&&this.host.scene.world&&this.host.scene.world.input){var b=this.host.scene.world.input;this.velocity.x=0,b.keyDown(a.KeyCode.LEFT)&&(this.velocity.x-=1),b.keyDown(a.KeyCode.RIGHT)&&(this.velocity.x+=1),this.velocity.y=0,b.keyDown(a.KeyCode.UP)&&(this.velocity.y-=1),b.keyDown(a.KeyCode.DOWN)&&(this.velocity.y+=1)}},e.prototype.interpolateTick=function(a){var b;b=this._elapsed/this.tickRateMS,this.host.renderPoint.set(this.host.point.x,this.host.point.y),this.velocity.isZero()||(this.host.renderPoint.interpolate(this.host.point,this.targetPoint,b),this.host.renderPoint.x=parseFloat(this.host.renderPoint.x.toFixed(2)),this.host.renderPoint.y=parseFloat(this.host.renderPoint.y.toFixed(2)))},e.prototype.tick=function(a){if(this._elapsed+=a,!(this._elapsed<this.tickRateMS)){this._elapsed=this._elapsed%this.tickRateMS,this.targetPoint.equal(this.host.point)||this.collideMove(this.targetPoint.x,this.targetPoint.y)||(this.workPoint.set(this.host.point),this.host.point.set(this.targetPoint),this.completeMove(this.currentMove)),this.updateVelocity(),this.targetPoint.set(this.host.point);var b=this.velocity.isZero();if(!b||0!==this.path.length){if(b){var c=this.path.shift();this.velocity.set(c.x-this.host.point.x,c.y-this.host.point.y)}else this.path.length=0;if(this.targetPoint.add(this.velocity),0===this.velocity.y||this.collideMove(this.host.point.x,this.targetPoint.y)){if(0===this.velocity.x||this.collideMove(this.targetPoint.x,this.host.point.y))return this.targetPoint.set(this.host.point),void(this.path.length=0);this.targetPoint.y=this.host.point.y}else this.targetPoint.x=this.host.point.x;this.currentMove={from:this.host.point.clone(),to:this.targetPoint.clone()},this.beginMove(this.currentMove)}}},e}(c.TickedComponent);c.MovableComponent=d}(c=b.components||(b.components={}))}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(c){var d={url:null,volume:1,loop:!1},e=function(b){function c(a){void 0===a&&(a=d),b.call(this),"undefined"!=typeof a&&_.extend(this,d,a)}return __extends(c,b),c.prototype.disconnectComponent=function(){return this.audio.isReady()&&(this.audio.data.pause(),this.audio.data.currentTime=0),b.prototype.disconnectComponent.call(this)},c.prototype.connectComponent=function(){var c=this;return b.prototype.connectComponent.call(this)&&this.url?this.audio&&this.audio.isReady()?(this.audio.data.currentTime=0,this.audio.data.volume=this.volume,!0):(this.audio=a.ResourceLoader.get().load(this.url,function(){c.audio.isReady()&&(c.audio.data.currentTime=0,c.audio.data.volume=c.volume,c.audio.data.loop=c.loop,c.audio.data.play(),c.audio.data.addEventListener("timeupdate",function(){c.audio.data.currentTime>=c.audio.data.duration&&(c.loop?c.trigger("audio:loop",c):(c.audio.data.pause(),c.trigger("audio:done",c)))}))}),!0):!1},c}(b.SceneComponent);c.SoundComponent=e}(c=b.components||(b.components={}))}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments),this.machine=null,this.paused=!1}return __extends(b,a),b.prototype.tick=function(a){this.paused||this.machine&&this.machine.update(this)},b}(a.TickedComponent);a.StateMachineComponent=b}(b=a.components||(a.components={}))}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(b){function c(c){b.call(this),this.tiles=[],this.dirtyLayers=!1,this._loaded=!1,this.bounds=new a.Rect(0,0,10,10),this.setMap(c)}return __extends(c,b),c.prototype.isLoaded=function(){return this._loaded},c.prototype.loaded=function(){this.trigger(a.tile.TileMap.Events.LOADED,this),this.scene&&this.scene.trigger(a.tile.TileMap.Events.MAP_LOADED,this),this._loaded=!0},c.prototype.unloaded=function(){this.trigger(a.tile.TileMap.Events.UNLOADED,this),this.scene&&this.scene.trigger(a.tile.TileMap.Events.MAP_UNLOADED,this),this._loaded=!1},c.prototype.setMap=function(b){var c=this;if(!b||!b.isReady())return!1;this.map&&this.unloaded(),this.map=b,this.bounds=new a.Rect(0,0,this.map.width,this.map.height);var d=_.sortBy(this.map.tilesets,function(a){return a.firstgid});return this.tiles.length=0,_.each(d,function(a){for(;c.tiles.length<a.firstgid;)c.tiles.push(null);c.tiles=c.tiles.concat(a.tiles)}),this.features=_.where(this.map.layers,{name:"Features"})[0]||[],this.zones=_.where(this.map.layers,{name:"Zones"})[0]||[],this.loaded(),!0},c.prototype.getLayers=function(){return this.map?this.map.layers:[]},c.prototype.getLayer=function(a){return _.where(this.map.layers,{name:a})[0]},c.prototype.getTerrain=function(a,b,c){return this.getTileData(this.getLayer(a),b,c)},c.prototype.getTileData=function(a,b,c){if(!(this.map&&a&&a.data&&this.bounds.pointInRect(b,c)))return null;var d=c*this.map.width+b,e=a.data[d];return this.tiles[e]},c.prototype.getTileGid=function(a,b,c){var d=this.getLayer(a);if(!(this.map&&d&&d.data&&this.bounds.pointInRect(b,c)))return null;var e=c*this.map.width+b;return d.data[e]},c.prototype.getTileMeta=function(a){if(this.tiles.length<=a)return null;var b=_.find(this.map.tilesets,function(b){return b.hasGid(a)});return b?b.getTileMeta(a):null},c.Events={LOADED:"loaded",UNLOADED:"unloaded",MAP_LOADED:"map:loaded",MAP_UNLOADED:"map:unloaded"},c}(a.scene.SceneObject);b.TileMap=c}(b=a.tile||(a.tile={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c={visible:!0,enabled:!0,icon:"",iconCoords:null,scale:1,image:null,tileMap:null},d=function(b){function d(a){return void 0===a&&(a=c),b.call(this,a),_.extend(this,_.defaults(a||{},c)),this}return __extends(d,b),d.prototype.setPoint=function(b){b.round(),this.renderPoint&&(this.renderPoint=b.clone()),this.point=b.clone();var c=this.findComponent(a.scene.components.MovableComponent);c&&(c.targetPoint.set(b),c.path.length=0)},d.prototype.onAddToScene=function(c){b.prototype.onAddToScene.call(this,c),this.icon&&this.setSprite(this.icon),this.tileMap||(this.tileMap=this.scene.objectByType(a.tile.TileMap))},d.prototype.setSprite=function(a,b){var c=this;void 0===b&&(b=0);var d=this.icon;if(a){var e=this.world.sprites.getSpriteMeta(a);this.world.sprites.getSpriteSheet(e.source,function(a){return c.meta=e,c.image=a.data})}else this.meta=null;return this.icon=a,d},d.prototype.getIcon=function(){if(this.icon)return this.icon;var b=this.findComponent(a.tile.components.SpriteComponent);return b?b.icon:null},d}(a.scene.SceneObject);b.TileObject=d}(b=a.tile||(a.tile={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(a){function c(){a.apply(this,arguments)}return __extends(c,a),c.prototype.syncComponent=function(){return!!this.host.tileMap&&this.host.tileMap instanceof b.TileMap},c.prototype.disconnectComponent=function(){return!0},c.prototype.enter=function(a){return!0},c.prototype.entered=function(a){return this.host.trigger(c.Events.ENTERED,this),this.isEntered=!0,!0},c.prototype.exit=function(a){return!0},c.prototype.exited=function(a){return this.host.trigger(c.Events.EXITED,this),this.isEntered=!1,!0},c.Events={ENTERED:"tile:entered",EXITED:"tile:exited"},c}(a.scene.SceneComponent);b.TileComponent=c}(b=a.tile||(a.tile={}))}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.connectComponent=function(){return b.prototype.connectComponent.call(this)&&this.host instanceof a.tile.TileMap;
},c.prototype.process=function(a){a.camera.point.set(this.host.bounds.point),a.cameraScale=Math.min(6,Math.round(a.screenToWorld(a.context.canvas.width)/a.camera.extent.x)),this.host&&(a.camera.point.x=Math.max(0,a.camera.point.x),a.camera.point.y=Math.max(0,a.camera.point.y),a.camera.point.x=Math.min(a.camera.point.x,this.host.bounds.extent.x-a.camera.extent.x),a.camera.point.y=Math.min(a.camera.point.y,this.host.bounds.extent.y-a.camera.extent.y),this.host.bounds.extent.x<a.camera.extent.x&&(a.camera.point.x=(this.host.bounds.extent.x-a.camera.extent.x)/2),this.host.bounds.extent.y<a.camera.extent.y&&(a.camera.point.y=(this.host.bounds.extent.y-a.camera.extent.y)/2))},c}(a.scene.components.CameraComponent);a.TileMapCameraComponent=b}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(b){var c=function(b){function c(){b.apply(this,arguments),this._renderPoint=new a.Point}return __extends(c,b),c.prototype.render=function(a,b,c){if(b.image&&a.visible){this._renderPoint.set(a.renderPoint||a.point);var d=this._renderPoint,e=b.meta,f=c.unitSize,g=c.unitSize;e&&"undefined"!=typeof e.cellWidth&&"undefined"!=typeof e.cellHeight&&(f=e.cellWidth,g=e.cellHeight);var h=c.fastScreenToWorldNumber(f),i=c.fastScreenToWorldNumber(g);if(d.x-=h*a.scale/2,d.y-=i*a.scale/2,c.fastWorldToScreenPoint(d,d),b.icon&&b.meta){var j=e.x,k=e.y;if(b.meta.frames>1){var l=e.width/f,m=b.frame%l,n=Math.floor((b.frame-m)/l);j+=m*f,k+=n*g}c.context.drawImage(b.image,j,k,f,g,d.x,d.y,f*a.scale,g*a.scale)}else c.context.drawImage(b.image,d.x,d.y,f*a.scale,g*a.scale)}},c}(a.scene.SceneObjectRenderer);b.TileObjectRenderer=c}(c=b.render||(b.render={}))}(b=a.tile||(a.tile={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(b){var c=function(b){function c(){b.apply(this,arguments),this.buffer=null,this.bufferMapName=null,this.bufferComplete=!1,this._clipRect=new a.Rect,this._renderRect=new a.Rect}return __extends(c,b),c.prototype.render=function(a,b){var c=this,d=8,e=d*b.unitSize;if(a.isLoaded()){if(a.dirtyLayers&&(a.dirtyLayers=!1,this.buffer=null,this.bufferComplete=!1),!this.bufferComplete||null===this.buffer||null===this.bufferMapName||this.bufferMapName!==a.map.url){var f=e/b.unitSize,g=Math.ceil(a.bounds.extent.x/d),h=Math.ceil(a.bounds.extent.y/d);this.buffer=new Array(g);for(var i=0;g>i;i++)this.buffer[i]=new Array(h);this.bufferComplete=!0;for(var j=a.getLayers(),i=0;g>i;i++)for(var k=0;h>k;k++){var l=i*f,m=l+f,n=k*f,o=n+f;this.buffer[i][k]=b.renderToCanvas(e,e,function(d){for(var e=l;m>e;e++)for(var f=n;o>f;f++)_.each(j,function(g){if(g.visible){var h=a.getTileGid(g.name,e,f),i=a.getTileMeta(h);if(i){var j,k,m,o,p,q,r,s,t=i.image.data;if(!t||!t.complete)return void(c.bufferComplete=!1);r=i.x,s=i.y,q=i.width,p=i.height,m=(e-l)*b.unitSize,o=(f-n)*b.unitSize,k=j=b.unitSize,d.drawImage(t,r,s,q,p,m,o,k,j)}}})})}this.bufferMapName=a.map.url}var p=b.fastWorldToScreenNumber(d);b.fastWorldToScreenRect(b.getCameraClip(),this._clipRect);for(var q=this.buffer.length,h=this.buffer[0].length,i=0;q>i;i++)for(var k=0;h>k;k++)this._renderRect.set(i*d-.5,k*d-.5,d,d),b.fastWorldToScreenRect(this._renderRect,this._renderRect),this._renderRect.intersect(this._clipRect)&&b.context.drawImage(this.buffer[i][k],0,0,e,e,this._renderRect.point.x,this._renderRect.point.y,p,p)}},c}(a.scene.SceneObjectRenderer);b.TileMapRenderer=c}(c=b.render||(b.render={}))}(b=a.tile||(a.tile={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(b){function c(){b.apply(this,arguments),this.objectRenderer=new a.tile.render.TileObjectRenderer,this.mapRenderer=new a.tile.render.TileMapRenderer,this.tileMap=null}return __extends(c,b),c.prototype.setTileMap=function(a){this.tileMap=a},c.prototype.setScene=function(a){a!==this.scene&&(this.cameraComponent=null,b.prototype.setScene.call(this,a))},c.prototype.getCameraClip=function(){if(!this.tileMap)return this.camera;var a=this.camera.clone();a.point.round(),a.extent.round();var b=this.tileMap.bounds;return a.point.x<b.point.x&&(a.point.x+=b.point.x-a.point.x),a.point.y<b.point.y&&(a.point.y+=b.point.y-a.point.y),a.point.x+a.extent.x>b.point.x+b.extent.x&&(a.point.x-=a.point.x+a.extent.x-(b.point.x+b.extent.x)),a.point.y+a.extent.y>b.point.y+b.extent.y&&(a.point.y-=a.point.y+a.extent.y-(b.point.y+b.extent.y)),a},c.prototype.processCamera=function(){this.cameraComponent=this.findComponent(a.scene.components.CameraComponent),!this.cameraComponent&&this.tileMap&&(this.cameraComponent=this.tileMap.findComponent(a.scene.components.CameraComponent)),this.cameraComponent||(this.cameraComponent=this.scene.componentByType(a.scene.components.CameraComponent)),b.prototype.processCamera.call(this)},c.prototype.setRenderState=function(){var a,c;b.prototype.setRenderState.call(this),this.camera&&this.context&&this.tileMap&&(c=this.worldToScreen(this.tileMap.bounds.point),c.x=parseFloat(c.x.toFixed(2)),c.y=parseFloat(c.y.toFixed(2)),a=this.worldToScreen(this.camera.point),a.x=parseFloat(a.x.toFixed(2)),a.y=parseFloat(a.y.toFixed(2)),this.context.translate(c.x-a.x,c.y-a.y))},c.prototype.renderFrame=function(a){return this.clearRect(),this.tileMap?(this.mapRenderer.render(this.tileMap,this),this):void 0},c.prototype.renderPost=function(){},c}(a.scene.SceneView);b.TileMapView=c}(b=a.tile||(a.tile={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(b){var c=function(a){function b(b){a.call(this),this.frame=0,"undefined"!=typeof b&&_.extend(this,b)}return __extends(b,a),b.prototype.syncComponent=function(){return this.host.world&&this.setSprite(this.icon,this.frame),a.prototype.syncComponent.call(this)},b.prototype.setSprite=function(a,b){var c=this;void 0===b&&(b=0);var d=this.icon;return a?(this.meta=this.host.world.sprites.getSpriteMeta(a),this.host.world.sprites.getSpriteSheet(this.meta.source,function(a){return c.image=a.data})):this.meta=null,this.icon=a,d},b}(a.scene.SceneComponent);b.SpriteComponent=c}(c=b.components||(b.components={}))}(b=a.tile||(a.tile={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(b){var c=function(a){function c(b){void 0===b&&(b={lengthMS:500,spriteName:null}),a.call(this),this._elapsed=0,this._renderFrame=3,this.lengthMS=500,"undefined"!=typeof b&&_.extend(this,b)}return __extends(c,a),c.prototype.connectComponent=function(){return this._renderFrame=0,this._elapsed=0,a.prototype.connectComponent.call(this)},c.prototype.syncComponent=function(){if(!a.prototype.syncComponent.call(this))return!1;var c=this.host.findComponents(b.SpriteComponent);return this.spriteComponent=_.where(c,{name:this.spriteName})[0],!!this.spriteComponent},c.prototype.tick=function(b){this._elapsed+=b,this._elapsed>=this.lengthMS&&(this.trigger("animation:done",this),this._elapsed=this._elapsed%this.lengthMS),a.prototype.tick.call(this,b)},c.prototype.interpolateTick=function(b){if(this.spriteComponent){var c=this._elapsed/this.lengthMS;this.spriteComponent.frame=c*this.spriteComponent.meta.frames|0}a.prototype.interpolateTick.call(this,b)},c}(a.scene.components.TickedComponent);b.AnimatedSpriteComponent=c}(c=b.components||(b.components={}))}(b=a.tile||(a.tile={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(b){var c=function(b){function c(a){b.call(this),this.tileMap=a,this._graph=null}return __extends(c,b),c.prototype.connectComponent=function(){return b.prototype.connectComponent.call(this)&&!!this.tileMap},c.prototype.syncComponent=function(){return this.tileMap.off(a.tile.TileMap.Events.LOADED,this._updateGraph,this),this.tileMap.on(a.tile.TileMap.Events.LOADED,this._updateGraph,this),b.prototype.syncComponent.call(this)},c.prototype.disconnectComponent=function(){return this.tileMap.off(a.tile.TileMap.Events.LOADED,this._updateGraph,this),this._graph=null,b.prototype.disconnectComponent.call(this)},c.prototype._updateGraph=function(){this._graph=new Graph(this.buildWeightedGraph())},c.prototype.buildWeightedGraph=function(){return[[]]},c.prototype.calculatePath=function(b,c){if(this._graph||this._updateGraph(),!this._graph||!this._graph.nodes)throw new Error("Invalid AStar graph");if(b.x>=this._graph.nodes.length||b.x<0)return[];if(b.y>=this._graph.nodes[b.x].length)return[];if(c.x>=this._graph.nodes.length||c.x<0)return[];if(c.y>=this._graph.nodes[c.x].length)return[];var d=this._graph.nodes[b.x][b.y],e=this._graph.nodes[c.x][c.y],f=astar.search(this._graph.nodes,d,e);return _.map(f,function(b){return new a.Point(b.pos.x,b.pos.y)})},c}(a.tile.TileComponent);b.PathComponent=c}(c=b.components||(b.components={}))}(b=a.tile||(a.tile={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(b){function c(c,d){b.call(this,c,d),this.objectRenderer=new a.tile.render.TileObjectRenderer,this.mouse=null,this.targetFill="rgba(10,255,10,0.3)",this.targetStroke="rgba(10,255,10,0.3)",this.targetStrokeWidth=1.5,this._players=null,this._playerRenders=null,this._sprites=null,this._movers=null,this._renderables=[],this.mouseClick=_.bind(this.mouseClick,this)}return __extends(c,b),c.prototype.onAddToScene=function(c){this.clearCache(),b.prototype.onAddToScene.call(this,c),this.mouse=c.world.input.mouseHook(this,"world"),this.$el.on("click touchstart",this.mouseClick),this.scene.on(a.tile.TileMap.Events.MAP_LOADED,this.syncComponents,this)},c.prototype.onRemoveFromScene=function(b){this.clearCache(),b.world.input.mouseUnhook("world"),this.$el.off("click",this.mouseClick),this.scene.off(a.tile.TileMap.Events.MAP_LOADED,this.syncComponents,this)},c.prototype.mouseClick=function(b){var c=this.scene.componentByType(a.tile.components.PathComponent),d=this.scene.componentByType(a.scene.components.PlayerComponent);return c&&d?(a.Input.mouseOnView(b.originalEvent,this.mouse.view,this.mouse),d.path=c.calculatePath(d.targetPoint,this.mouse.world),b.preventDefault(),!1):void 0},c.prototype.syncComponents=function(){b.prototype.syncComponents.call(this),this.clearCache()},c.prototype.clearCache=function(){this._players=null,this._playerRenders=null,this._sprites=null,this._movers=null,this._renderables=[]},c.prototype.renderFrame=function(c){b.prototype.renderFrame.call(this,c),this._playerRenders||(this._playerRenders=this.scene.objectsByComponent(a.game.components.PlayerRenderComponent),this._renderables=this._renderables.concat(this._playerRenders)),this._players||(this._players=this.scene.objectsByComponent(a.scene.components.PlayerComponent),this._renderables=this._renderables.concat(this._players)),this._sprites||(this._sprites=this.scene.componentsByType(a.tile.components.SpriteComponent),this._renderables=this._renderables.concat(this._sprites));for(var d=this._renderables.length,e=0;d>e;e++){var f=this._renderables[e];this.objectRenderer.render(f,f,this)}this._movers||(this._movers=this.scene.componentsByType(a.scene.components.MovableComponent)),d=this._movers.length;for(var e=0;d>e;e++){var g=this._movers[e];if(g.path.length>0){this.context.save();var h=g.path[g.path.length-1].clone();h.x-=.5,h.y-=.5;var i=this.worldToScreen(new a.Rect(h,new a.Point(1,1)));this.context.fillStyle=this.targetFill,this.context.fillRect(i.point.x,i.point.y,i.extent.x,i.extent.y),this.context.strokeStyle=this.targetStroke,this.context.lineWidth=this.targetStrokeWidth,this.context.strokeRect(i.point.x,i.point.y,i.extent.x,i.extent.y),this.context.restore()}}return this},c}(a.tile.TileMapView);b.GameMapView=c}(b=a.game||(a.game={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(b){var c=function(b){function c(){b.apply(this,arguments),this._tasks=[],this._animationKeys=[],this._currentAnim=null}return __extends(c,b),c.prototype.play=function(a){var b=a;b.elapsed=0,b.move&&(b.startFrame=this.host.frame,b.start=this.host.point.clone(),b.target=this.host.point.clone().add(b.move),b.value=this.host.point.clone()),"undefined"==typeof b.duration&&(b.duration=0),this._tasks.push(b)},c.prototype.stop=function(a){for(var b=0;b<this._tasks.length;b++){var c=this._tasks[b];c.name===a.name&&(c.complete=!0)}},c.prototype.removeCompleteTasks=function(){for(var a=0;a<this._tasks.length;a++){var b=this._tasks[a];b.complete===!0&&(this._tasks.splice(a,1),b.done&&b.done(b),b.callback&&b.callback(b),this.trigger(c.EVENTS.Stopped,{task:b,component:this}),a--)}},c.prototype.interpolateTick=function(a){b.prototype.interpolateTick.call(this,a),this.update(a),this.removeCompleteTasks()},c.prototype.update=function(b){var c=this;0!==this._tasks.length&&_.each(this._tasks,function(d){if(d.elapsed>d.duration&&(d.complete=!0,d.elapsed=d.duration),d.duration>0){var e=d.elapsed/d.duration;if(d.move&&d.move instanceof a.Point&&c.host.point.set(d.value.interpolate(d.start,d.target,e)),d.frames&&d.frames.length){var f=Math.round(c.interpolate(0,d.frames.length-1,e)),g=d.frames[f];c.host.frame=g}}d.complete||(d.elapsed+=b)})},c.prototype.interpolate=function(a,b,c){return c=Math.min(Math.max(c,0),1),a*(1-c)+b*c},c.prototype.playChain=function(a,b){"undefined"!=typeof b&&a.push({name:"Chain Callback",duration:0,callback:b}),this._animationKeys=a,this._animateNext()},c.prototype._animateNext=function(){var a=this;0!==this._animationKeys.length&&(this._currentAnim=this._animationKeys.shift(),this._currentAnim.done=function(){_.defer(function(){a._animateNext()})},this.play(this._currentAnim))},c.EVENTS={Started:"start",Stopped:"stop",Repeated:"repeat"},c}(a.scene.components.TickedComponent);b.AnimatedComponent=c}(c=b.components||(b.components={}))}(b=a.game||(a.game={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(b){var c=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.buildWeightedGraph=function(){for(var b=this,c=this.tileMap.getLayers(),d=c.length,e=new Array(this.tileMap.bounds.extent.x),f=0;f<this.tileMap.bounds.extent.x;f++)e[f]=new Array(this.tileMap.bounds.extent.y);for(var f=0;f<this.tileMap.bounds.extent.x;f++)for(var g=0;g<this.tileMap.bounds.extent.y;g++){for(var h=10,i=!1,j=0;d>j;j++){var k=this.tileMap.getTileData(c[j],f,g);k&&(k.passable===!1?(h=1e3,i=!0):k.isPath===!0&&(h=1))}e[f][g]=h}return _.each(this.tileMap.features.objects,function(c){var d=c.properties;if(d){var f=a.scene.components.PlayerComponent.COLLIDE_TYPES;if(d.passable!==!0&&d.type&&-1!==_.indexOf(f,d.type)){var g=c.x/c.width|0,h=c.y/c.height|0;!d.passable&&b.tileMap.bounds.pointInRect(g,h)&&(e[g][h]=100)}}}),e},c}(a.tile.components.PathComponent);b.GameMapPathComponent=c}(c=b.components||(b.components={}))}(b=a.game||(a.game={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(b){!function(a){a[a.LEFT=10]="LEFT",a[a.RIGHT=4]="RIGHT",a[a.DOWN=7]="DOWN",a[a.UP=1]="UP",a[a.LEFTALT=11]="LEFTALT",a[a.RIGHTALT=5]="RIGHTALT",a[a.DOWNALT=8]="DOWNALT",a[a.UPALT=2]="UPALT"}(b.MoveFrames||(b.MoveFrames={}));b.MoveFrames;!function(a){a[a.WEST=0]="WEST",a[a.EAST=1]="EAST",a[a.SOUTH=2]="SOUTH",a[a.NORTH=3]="NORTH"}(b.Headings||(b.Headings={}));var c=b.Headings,d=function(b){function d(){b.apply(this,arguments),this._animator=new a.Animator,this.heading=c.WEST,this.animating=!1}return __extends(d,b),d.prototype.setHeading=function(a,b){switch(this._animator.sourceAnims||this._animator.setAnimationSource(this.host.icon),this.heading=a,this.heading){case c.SOUTH:this._animator.setAnimation("down");break;case c.NORTH:this._animator.setAnimation("up");break;case c.EAST:this._animator.setAnimation("right");break;case c.WEST:this._animator.setAnimation("left")}this._animator.updateTime(0),this.animating=b},d.prototype.setMoving=function(a){this.animating=a},d.prototype.interpolateTick=function(a){b.prototype.interpolateTick.call(this,a),this.animating&&this._animator.updateTime(a),this.host.frame=this._animator.getFrame()},d}(a.scene.components.TickedComponent);b.PlayerRenderComponent=d}(c=b.components||(b.components={}))}(b=a.game||(a.game={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(b){var c=function(b){function c(){b.apply(this,arguments),this.passableKeys=["passable"],this._lastFrame=3,this._renderFrame=3,this.heading=new a.Point(0,-1),this.sprite=null,this.collideComponentType=a.tile.TileComponent}return __extends(c,b),c.prototype.syncComponent=function(){return this.sprite=this.host.findComponent(a.game.components.PlayerRenderComponent),b.prototype.syncComponent.call(this)},c.prototype.tick=function(a){this._lastFrame=this._renderFrame>3?this._renderFrame-4:this._renderFrame,b.prototype.tick.call(this,a)},c.prototype.interpolateTick=function(c){if(b.prototype.interpolateTick.call(this,c),this.sprite){var d=this.targetPoint.x!==this.host.renderPoint.x,e=this.targetPoint.y!==this.host.renderPoint.y;this.velocity.y>0&&e?(this.sprite.setHeading(a.game.components.Headings.SOUTH,e),this.heading.set(0,1)):this.velocity.y<0&&e?(this.sprite.setHeading(a.game.components.Headings.NORTH,e),this.heading.set(0,-1)):this.velocity.x<0&&d?(this.sprite.setHeading(a.game.components.Headings.WEST,d),this.heading.set(-1,0)):this.velocity.x>0&&d?(this.sprite.setHeading(a.game.components.Headings.EAST,d),this.heading.set(1,0)):this.velocity.y>0?(this.sprite.setHeading(a.game.components.Headings.SOUTH,!1),this.heading.set(0,1)):this.velocity.y<0?(this.sprite.setHeading(a.game.components.Headings.NORTH,!1),this.heading.set(0,-1)):this.velocity.x<0?(this.sprite.setHeading(a.game.components.Headings.WEST,!1),this.heading.set(-1,0)):this.velocity.x>0?(this.sprite.setHeading(a.game.components.Headings.EAST,!1),this.heading.set(1,0)):this.sprite.setMoving(!1)}},c.prototype.collideWithMap=function(b,c){var d=this.host.scene.objectByType(a.tile.TileMap);if(d)for(var e=d.getLayers(),f=0;f<e.length;f++){var g=d.getTileData(e[f],b.x,b.y);if(g&&g[c]===!1)return!0}return!1},c.prototype.collideMove=function(a,b,c){return void 0===c&&(c=[]),!1},c.prototype.beginMove=function(b){if(this.host.trigger(c.Events.MOVE_BEGIN,this,b.from,b.to),this.collider){var d=[];this.collider.collide(b.from.x,b.from.y,a.tile.TileObject,d);for(var e=0;e<d.length;e++){var f=d[e],g=f.findComponent(this.collideComponentType);if(g&&g.enter&&g.exit(this.host)===!1)return}d.length=0,this.collider.collide(b.to.x,b.to.y,a.tile.TileObject,d);for(var e=0;e<d.length;e++){var f=d[e],g=f.findComponent(this.collideComponentType);if(g&&g.enter&&g.enter(this.host)===!1)return}}},c.prototype.completeMove=function(b){var d=this;if(this.host.trigger(c.Events.MOVE_END,this,b.from,b.to),this.collider){var e=[];this.collider.collide(b.from.x,b.from.y,a.tile.TileObject,e);var f=_.find(e,function(a){return a._uid!==d.host._uid});if(f){var g=f.findComponent(this.collideComponentType);g&&g.host._uid!==this.host._uid&&g.exited(this.host)}e.length=0,this.collider.collide(b.to.x,b.to.y,a.tile.TileObject,e);var h=_.find(e,function(a){return a._uid!==d.host._uid});if(h){var g=h.findComponent(this.collideComponentType);g&&g.host._uid!==this.host._uid&&g.entered(this.host)}}},c.COLLIDE_TYPES=["rpg.components.features.TempleFeatureComponent","rpg.components.features.StoreFeatureComponent","rpg.components.features.DialogFeatureComponent","sign"],c.Events={MOVE_BEGIN:"move:begin",MOVE_END:"move:end"},c}(a.scene.components.MovableComponent);b.PlayerComponent=c}(c=b.components||(b.components={}))}(b=a.scene||(a.scene={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(b){var c=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.process=function(b){a.prototype.process.call(this,b),b.camera.setCenter(this.host.renderPoint||this.host.point),this.host.tileMap&&(b.camera.point.x=Math.min(b.camera.point.x,this.host.tileMap.bounds.extent.x-b.camera.extent.x),b.camera.point.y=Math.min(b.camera.point.y,this.host.tileMap.bounds.extent.y-b.camera.extent.y),b.camera.point.x=Math.max(0,b.camera.point.x),b.camera.point.y=Math.max(0,b.camera.point.y),this.host.tileMap.bounds.extent.x<b.camera.extent.x&&(b.camera.point.x=(this.host.tileMap.bounds.extent.x-b.camera.extent.x)/2),this.host.tileMap.bounds.extent.y<b.camera.extent.y&&(b.camera.point.y=(this.host.tileMap.bounds.extent.y-b.camera.extent.y)/2))},b}(a.scene.components.CameraComponent);b.PlayerCameraComponent=c}(c=b.components||(b.components={}))}(b=a.game||(a.game={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c;!function(b){!function(a){a[a.DEFAULT=10]="DEFAULT",a[a.SWING=1]="SWING",a[a.INJURED=2]="INJURED",a[a.WALK=3]="WALK",a[a.STRIKE=3]="STRIKE",a[a.CELEBRATE=4]="CELEBRATE",a[a.DEAD=5]="DEAD"}(b.StateFrames||(b.StateFrames={}));var c=b.StateFrames,d=function(d){function e(){d.apply(this,arguments),this._elapsed=0,this._renderFrame=3,this.state="",this.animating=!1,this.animator=null,this.attackDirection=a.game.components.Headings.WEST}return __extends(e,d),e.prototype.syncComponent=function(){return this.animator=this.host.findComponent(b.AnimatedComponent),d.prototype.syncComponent.call(this)},e.prototype.setState=function(a){void 0===a&&(a="Default"),this.state=a},e.prototype.attack=function(a,b){this._attack(b,this.getAttackAnimation(a))},e.prototype.magic=function(a,b){this._attack(b,this.getMagicAnimation(a))},e.prototype.getForwardDirection=function(){return this.attackDirection===a.game.components.Headings.WEST?-1:1},e.prototype.getBackwardDirection=function(){return this.attackDirection===a.game.components.Headings.WEST?1:-1},e.prototype.getForwardFrames=function(){return this.attackDirection===a.game.components.Headings.WEST?[9,11,10]:[3,5,4]},e.prototype.getBackwardFrames=function(){return this.attackDirection===a.game.components.Headings.WEST?[10,11,9]:[4,5,3]},e.prototype.getAttackFrames=function(){return this.attackDirection===a.game.components.Headings.WEST?[12,13,14,15,14,13,12]:[4,5,6,7,6,5,4]},e.prototype.getMagicAnimation=function(a){var b=this;return[{name:"Prep Animation",callback:function(){b.host.setSprite(b.host.icon.replace(".png","-magic.png"),19)}},{name:"Magic cast",repeats:0,duration:1e3,frames:[19,18,17,16,15],callback:function(){a&&a()}},{name:"Back to rest",repeats:0,duration:1e3,frames:[15,16,17,18,19],callback:function(){b.host.setSprite(b.host.icon.replace("-magic.png",".png"),10)}}]},e.prototype.getAttackAnimation=function(b){var c=this;return[{name:"Move Forward for Attack",repeats:0,duration:250,frames:this.getForwardFrames(),move:new a.Point(this.getForwardDirection(),0),callback:function(){var a=c.host.icon.replace(".png","-attack.png");c.host.world.sprites.getSpriteMeta(a)&&c.host.setSprite(a,12)}},{name:"Strike at Opponent",repeats:1,duration:100,frames:this.getAttackFrames(),callback:function(){c.host.setSprite(c.host.icon.replace("-attack.png",".png"),10),b&&b()}},{name:"Return to Party",duration:250,repeats:0,frames:this.getBackwardFrames(),move:new a.Point(this.getBackwardDirection(),0)}]},e.prototype.moveForward=function(b){this._playAnimation([{name:"Move Forward",repeats:0,duration:250,frames:this.getForwardFrames(),move:new a.Point(this.getForwardDirection(),0)}],b)},e.prototype.moveBackward=function(b){this._playAnimation([{name:"Move Backward",repeats:0,duration:250,frames:this.getBackwardFrames(),move:new a.Point(this.getBackwardDirection(),0)}],b)},e.prototype._playAnimation=function(a,b){var c=this;if(this.animator&&!this.animating){var d=_.map(a,function(a){var b=_.extend({},a);return"undefined"!=typeof b.move&&(b.move=b.move.clone()),b});this.animating=!0,this.animator.playChain(d,function(){c.animating=!1,b&&b()})}},e.prototype._attack=function(a,b){var c=this;if(this.animator&&!this.animating){var d=_.map(b,function(a){var b=_.extend({},a);return"undefined"!=typeof b.move&&(b.move=b.move.clone()),b});this.animating=!0,this.animator.playChain(d,function(){c.animating=!1,a&&a()})}},e.prototype.interpolateTick=function(a){if(d.prototype.interpolateTick.call(this,a),!this.animating){var b=this._elapsed/this.tickRateMS,e=!!(b>0&&.5>b),f=c.DEFAULT;switch(this.state){case"Injured":f=c.DEFAULT;break;case"Dead":f=c.DEFAULT;break;case"Attacking":f=e?c.STRIKE:c.SWING}this.host.frame=this._renderFrame=f}},e}(a.scene.components.TickedComponent);b.PlayerCombatRenderComponent=d}(c=b.components||(b.components={}))}(b=a.game||(a.game={}))}(pow2||(pow2={}));var pow2;!function(a){!function(a){a[a.NONE=0]="NONE",a[a.ENTITY_TYPE=1]="ENTITY_TYPE",a[a.COMPONENT_TYPE=2]="COMPONENT_TYPE",a[a.COMPONENT_NAME_DUPLICATE=4]="COMPONENT_NAME_DUPLICATE",a[a.COMPONENT_REGISTER=8]="COMPONENT_REGISTER",a[a.COMPONENT_INPUT=16]="COMPONENT_INPUT",a[a.INPUT_NAME=32]="INPUT_NAME",a[a.INPUT_TYPE=64]="INPUT_TYPE"}(a.EntityError||(a.EntityError={}));var b=a.EntityError,c=function(a){function c(){a.apply(this,arguments)}return __extends(c,a),c.getClassType=function(a){if(!a)return null;for(var b=a.split("."),c=0,d=b.length,e=window;d>c;++c)if(e=e[b[c]],!e)return null;return-1!==Function.prototype.toString.call(e).indexOf("[native code]")?null:e},c.prototype.typeofCompare=function(a,b){var c=typeof a,b=""+b;return c.toUpperCase()===b.toUpperCase()},c.prototype.validateTemplate=function(a,d){var e=this,f=c.getClassType(a.type);if(!f)return b.ENTITY_TYPE;var g=b.NONE;if(a.inputs){var h=_.keys(a.inputs);if(h){if("undefined"==typeof d)return console.error("EntityContainer: missing inputs for template that requires: "+h.join(", ")),b.INPUT_NAME;_.each(a.inputs,function(a,f){var h=c.getClassType(a);"undefined"==typeof d[f]?(console.error("EntityContainer: missing input with name: "+f),g|=b.INPUT_NAME):!h||d[f]instanceof h?h||e.typeofCompare(d[f],a)||(console.error("EntityContainer: bad input type for input ("+f+") expected ("+a+") but got ("+typeof d[f]+")"),g|=b.INPUT_TYPE):(console.error("EntityContainer: bad input type for input: "+f),g|=b.INPUT_TYPE)})}if(g!==b.NONE)return g}if(a.components){var i=_.map(a.components,function(a){return a.name}),j=_.uniq(i).length===i.length;if(!j)return console.error("EntityContainer: duplicate name in template components: "+i.join(", ")),b.COMPONENT_NAME_DUPLICATE}return g=b.NONE,_.each(a.components,function(a){var e=c.getClassType(a.type);e?a.params&&_.each(a.params,function(a){"undefined"==typeof d[a]&&(console.error("EntityContainer: missing component param: "+a),g|=b.COMPONENT_INPUT)}):(console.error("EntityContainer: unknown component type: "+a.type),g|=b.COMPONENT_TYPE)}),g},c.prototype.getTemplate=function(a){if(!this.isReady())return null;var b=_.where(this.data,{name:a})[0];return b?b:null},c.prototype.constructObject=function(a,b){var c=[null].concat(b),d=a.bind.apply(a,c);return new d},c.prototype.createObject=function(a,d){var e=this,f=this.getTemplate(a);if(!f)return null;if(this.validateTemplate(f,d)!==b.NONE)return console.log("failed to validate template: "+f.name+":"+f.type),null;var g=c.getClassType(f.type),h=f.params?_.map(f.params,function(a){return d[a]}):[d],i=this.constructObject(g,h),j=b.NONE;return _.each(f.components,function(a){var f=_.map(a.params||[],function(a){return d[a]}),g=c.getClassType(a.type),h=e.constructObject(g,f);h.name=a.name,i.addComponent(h)||(j|=b.COMPONENT_REGISTER)}),j!==b.NONE?null:i},c}(a.JSONResource);a.EntityContainerResource=c}(pow2||(pow2={}));var pow2;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.load=function(){var a=this;try{this.data=JSON.parse(this.getCache(this.url)),this.data&&_.defer(function(){a.ready()})}catch(b){}Tabletop.init({key:this.url,callback:function(b,c){b=a.data=a.transformTypes(b),a.setCache(a.url,JSON.stringify(b)),a.ready()}})},c.prototype.getCache=function(a){return localStorage.getItem(c.DATA_KEY+a)},c.clearCache=function(a){localStorage.removeItem(c.DATA_KEY+a)},c.prototype.setCache=function(a,b){localStorage.setItem(c.DATA_KEY+a,b)},c.prototype.transformTypes=function(b){var c={};return _.each(b,function(b,d){for(var e=b.elements.slice(0),f=e.length,g=0;f>g;g++){var h=e[g];for(var i in h)if(h.hasOwnProperty(i)&&"string"==typeof h[i]){var j=h[i];if(j.match(a.GameDataResource.NUMBER_MATCHER))h[i]=parseInt(j);else if("benefit"===i)switch(j.toLowerCase()){case"true":case"yes":case"1":h[i]=!0;break;case"false":case"no":case"0":case null:h[i]=!1;break;default:h[i]=Boolean(j)}else("usedby"===i||"groups"===i||"zones"===i||"enemies"===i)&&(/^\s*$/.test(j)?h[i]=null:h[i]=j.split("|"))}}c[d.toLowerCase()]=e}),c},c.prototype.getSheetData=function(a){if(!this.isReady())throw new Error("Cannot query spreadsheet before it's loaded");return a=(""+a).toLocaleLowerCase(),this.data[a]?this.data[a]:[]},c.DATA_KEY="__db",c.NUMBER_MATCHER=/^-?\d+$/,c}(a.Resource);a.GameDataResource=b}(pow2||(pow2={}));
//# sourceMappingURL=pow2.min.map