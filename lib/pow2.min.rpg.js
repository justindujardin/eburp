
/*!
  pow2 - v0.1.6
  built: 2015-07-12
 */

var rpg;!function(a){a.app=angular.module("rpg",["ngAnimate","pow2","templates-rpg","ngSanitize","ngTouch"]),a.app.directive("heroCard",function(){return{restrict:"E",scope:!0,templateUrl:"games/rpg/directives/heroCard.html",link:function(a,b,c){a.hero=c.hero,a.$watch(c.hero,function(b){a.hero=b})}}})}(rpg||(rpg={}));var rpg;!function(a){a.COMBAT_ENCOUNTERS={FIXED:"fixed",RANDOM:"random"}}(rpg||(rpg={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},rpg;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.defaults=function(){return _.extend({},b.DEFAULTS)},b.prototype.rollHit=function(a){return!0},b.prototype.damage=function(a){return a=Math.ceil(a),this.set({hp:Math.min(this.attributes.maxHP,Math.max(0,this.attributes.hp-a))}),this.attributes.hp<=0&&this.set({dead:!0}),a},b.prototype.getEvasion=function(){return 0},b.prototype.isDefeated=function(){return this.attributes.hp<=0},b.prototype.attack=function(a){var b=this.attributes.strength/2;return a.damage(b)},b.BASE_CHANCE_TO_HIT=168,b.BASE_EVASION=48,b.DEFAULTS={name:"Nothing",icon:"",level:1,hp:0,maxHP:0,strength:5,vitality:4,intelligence:1,agility:1,dead:!1,evade:0,hitpercent:1},b}(Backbone.Model);a.EntityModel=b}(b=a.models||(a.models={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c=function(b){function c(c){b.call(this,_.omit(c||{},["x","y","type"])),this.world=pow2.getWorld("pow2"),this.type=c.type||"player",this.groups="string"==typeof c.groups?JSON.parse(c.groups):c.groups,this.model=c.model||new a.models.EntityModel(c)}return __extends(c,b),c.prototype.isDefeated=function(){return this.model.isDefeated()},c.prototype.getSpells=function(){var a=this.world.spreadsheet.getSheetData("magic"),b=this.model.get("level"),c=this.model.get("type");return _.filter(a,function(a){return a.level<=b&&-1!==_.indexOf(a.usedby,c)})},c}(pow2.tile.TileObject);b.GameEntityObject=c}(b=a.objects||(a.objects={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c;!function(b){var c=function(b){function c(a){b.call(this),this.combat=a,this.name="default",this.from=null,this.to=null,this.spell=null}return __extends(c,b),c.prototype.getActionName=function(){return this.name},c.prototype.isCurrentTurn=function(){return this.combat.machine.current===this.from},c.prototype.canTarget=function(){return!0},c.prototype.canTargetMultiple=function(){return this.canTarget()},c.prototype.canBeUsedBy=function(b){return b.model&&b.model instanceof a.models.EntityModel},c.prototype.act=function(a){return a&&a(this,null),!0},c.prototype.select=function(){},c}(pow2.scene.SceneComponent);b.CombatActionComponent=c}(c=b.combat||(b.combat={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c;!function(b){var c;!function(c){var d=function(b){function c(){b.apply(this,arguments),this.name="attack"}return __extends(c,b),c.prototype.canBeUsedBy=function(c){var d=[a.models.HeroTypes.LifeMage,a.models.HeroTypes.Necromancer];return b.prototype.canBeUsedBy.call(this,c)&&-1===_.indexOf(d,c.model.get("type"))},c.prototype.act=function(b){var c=this;if(!this.isCurrentTurn())return!1;var d=function(d){b&&b(c,d),c.combat.machine.setCurrentState(a.states.combat.CombatEndTurnState.NAME)},e=this.from,f=this.to,g=e.findComponent(pow2.game.components.PlayerCombatRenderComponent),h=function(){var b=e.model.attack(f.model),h=f.model.get("hp")<=0,i=b>0,j=f.model instanceof a.models.HeroModel&&f.model.defenseBuff>0,k="/data/sounds/"+(h?"killed":i?j?"miss":"hit":"miss"),l={animation:new pow2.tile.components.AnimatedSpriteComponent({spriteName:"attack",lengthMS:350}),sprite:new pow2.tile.components.SpriteComponent({name:"attack",icon:i?j?"animSmoke.png":"animHit.png":"animMiss.png"}),damage:new a.components.DamageComponent,sound:new pow2.scene.components.SoundComponent({url:k,volume:.3})};g&&g.setState("Moving"),f.addComponentDictionary(l),l.damage.once("damage:done",function(){g&&g.setState(),h&&f.model instanceof a.models.CreatureModel&&_.defer(function(){f.destroy()}),f.removeComponentDictionary(l)});var m={damage:b,attacker:e,defender:f};c.combat.machine.notify("combat:attack",m,d)};return g?g.attack(h):_.delay(function(){h()},1e3),!0},c}(b.CombatActionComponent);c.CombatAttackComponent=d}(c=b.actions||(b.actions={}))}(c=b.combat||(b.combat={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c;!function(b){var c;!function(c){var d=function(b){function c(){b.apply(this,arguments),this.name="guard"}return __extends(c,b),c.prototype.canTarget=function(){return!1},c.prototype.act=function(c){return this.combat.machine.setCurrentState(a.states.combat.CombatEndTurnState.NAME),b.prototype.act.call(this,c)},c.prototype.select=function(){if(this.combat.machine.on(a.states.CombatStateMachine.Events.ENTER,this.enterState,this),console.info("Adding guard defense buff to player: "+this.from.model.get("name")),!(this.from.model instanceof a.models.HeroModel))throw new Error("This action is not currently applicable to non hero characters.");var b=this.from.model,c=b.get("level")<10?2:.5;b.defenseBuff+=b.getDefense(!0)*c},c.prototype.enterState=function(b,c){var d=[a.states.combat.CombatChooseActionState.NAME,a.states.combat.CombatVictoryState.NAME,a.states.combat.CombatDefeatState.NAME,a.states.combat.CombatEscapeState.NAME];if(-1!==_.indexOf(d,b.name)){console.info("Removing guard defense buff from player: "+this.from.model.get("name")),this.combat.machine.off(a.states.CombatStateMachine.Events.ENTER,this.enterState,this);var e=this.from.model;e.defenseBuff=0}},c}(b.CombatActionComponent);c.CombatGuardComponent=d}(c=b.actions||(b.actions={}))}(c=b.combat||(b.combat={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c;!function(b){var c;!function(c){var d=function(b){function c(){b.apply(this,arguments),this.name="magic"}return __extends(c,b),c.prototype.canBeUsedBy=function(c){var d=[a.models.HeroTypes.LifeMage,a.models.HeroTypes.Necromancer];return b.prototype.canBeUsedBy.call(this,c)&&-1!==_.indexOf(d,c.model.get("type"))},c.prototype.act=function(b){var c=this;if(!this.isCurrentTurn())return!1;var d=function(d){b&&b(c,d),c.combat.machine.setCurrentState(a.states.combat.CombatEndTurnState.NAME)};if(!this.spell)return console.error("null spell to cast"),!1;switch(this.spell.id){case"heal":return this.healSpell(d);case"push":return this.hurtSpell(d)}return!0},c.prototype.healSpell=function(a){var b=this,c=this.from,d=this.to,e=c.findComponent(pow2.game.components.PlayerCombatRenderComponent);return e.magic(function(){var e=(d.model.get("level"),-b.spell.value);d.model.damage(e);var f="/data/sounds/heal",g={animation:new pow2.tile.components.AnimatedSpriteComponent({spriteName:"heal",lengthMS:550}),sprite:new pow2.tile.components.SpriteComponent({name:"heal",icon:"animSpellCast.png"}),sound:new pow2.scene.components.SoundComponent({url:f,volume:.3})};d.addComponentDictionary(g),g.animation.once("animation:done",function(){d.removeComponentDictionary(g);var f={damage:e,attacker:c,defender:d};b.combat.machine.notify("combat:attack",f,a)})}),!0},c.prototype.hurtSpell=function(b){var c=this,d=this.from,e=this.to,f=d.findComponent(pow2.game.components.PlayerCombatRenderComponent);return f.magic(function(){var f=e.model.damage(c.spell.value),g=e.model.get("hp")<=0,h=f>0,i="/data/sounds/"+(g?"killed":h?"spell":"miss"),j={animation:new pow2.tile.components.AnimatedSpriteComponent({spriteName:"attack",lengthMS:550}),sprite:new pow2.tile.components.SpriteComponent({name:"attack",icon:h?"animHitSpell.png":"animMiss.png"}),damage:new a.components.DamageComponent,sound:new pow2.scene.components.SoundComponent({url:i,volume:.3})};e.addComponentDictionary(j),j.damage.once("damage:done",function(){g&&e.model instanceof a.models.CreatureModel&&_.defer(function(){e.destroy()}),e.removeComponentDictionary(j)});var k={damage:f,attacker:d,defender:e};c.combat.machine.notify("combat:attack",k,b)}),!0},c}(b.CombatActionComponent);c.CombatMagicComponent=d}(c=b.actions||(b.actions={}))}(c=b.combat||(b.combat={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c;!function(b){var c;!function(c){var d=function(b){function c(){b.apply(this,arguments),this.name="run"}return __extends(c,b),c.prototype.canTarget=function(){return!1},c.prototype.act=function(b){var c=this;if(!this.isCurrentTurn())return!1;var d=this._rollEscape(),e={success:d,player:this.combat.machine.current};return this.combat.machine.notify("combat:run",e,function(){d?c.combat.machine.setCurrentState(a.states.combat.CombatEscapeState.NAME):c.combat.machine.setCurrentState(a.states.combat.CombatEndTurnState.NAME),b&&b(c)}),!0},c.prototype._rollEscape=function(){var a=_.random(0,200),b=100;return 200===a?!1:0===a?!0:b>=a},c}(b.CombatActionComponent);c.CombatRunComponent=d}(c=b.actions||(b.actions={}))}(c=b.combat||(b.combat={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b=null,c=function(c){function d(b){var d=this;c.call(this,b),this.combatScene=null,this.spreadsheet=null,this._encounterCallback=null,this.scene||this.setService("scene",new pow2.scene.Scene),this.loader.registerType("powEntities",pow2.EntityContainerResource),a.models.GameStateModel.getDataSource(function(a){d.spreadsheet=a})}return __extends(d,c),d.get=function(){return b||(b=new a.GameWorld),b},d.prototype.reportEncounterResult=function(a){this._encounterCallback&&(this._encounterCallback(a),this._encounterCallback=null)},d.prototype.randomEncounter=function(b,c){var d=this;a.models.GameStateModel.getDataSource(function(a){var e=a.getSheetData("encounters"),f=_.filter(e,function(a){return-1!==_.indexOf(a.zones,b.map)||-1!==_.indexOf(a.zones,b.target)});if(0===f.length)return void(c&&c(!0));var g=f.length-1,h=0,i=f[Math.floor(Math.random()*(g-h+1))+h];d._encounter(b,i,c)})},d.prototype.fixedEncounter=function(b,c,d){var e=this;a.models.GameStateModel.getDataSource(function(a){var f=_.where(a.getSheetData("encounters"),{id:c});if(0===f.length)throw new Error("No encounter found with id: "+c);e._encounter(b,f[0],d)})},d.prototype._encounter=function(b,c,d){this.scene.trigger("combat:encounter",this),this.state.encounter=c,this.state.encounterInfo=b,this.state.setCurrentState(a.states.GameCombatState.NAME),this._encounterCallback=d},d}(pow2.scene.SceneWorld);a.GameWorld=c}(rpg||(rpg={}));var rpg;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.loaded=function(){b.prototype.loaded.call(this),this.map.properties&&this.map.properties.music&&this.addComponent(new pow2.scene.components.SoundComponent({url:this.map.properties.music,volume:.1,loop:!0})),this.buildFeatures()},c.prototype.destroy=function(){return this.unloaded(),b.prototype.destroy.call(this)},c.prototype.unloaded=function(){this.removeComponentByType(pow2.scene.components.SoundComponent),this.removeFeaturesFromScene(),b.prototype.unloaded.call(this)},c.prototype.getFeature=function(a){return _.find(this.features.objects,function(b){return b.name===a})},c.prototype.addFeaturesToScene=function(){var a=this;_.each(this.features.objects,function(b){b._object=a.createFeatureObject(b),b._object&&a.scene.addObject(b._object)})},c.prototype.removeFeaturesFromScene=function(){_.each(this.features.objects,function(a){var b=a._object;delete a._object,b&&b.destroy()})},c.prototype.buildFeatures=function(){return this.removeFeaturesFromScene(),this.scene&&this.addFeaturesToScene(),!0},c.prototype.createFeatureObject=function(b){var c=_.extend({},b.properties||{},{tileMap:this,type:b.type,x:Math.round(b.x/this.map.tilewidth),y:Math.round(b.y/this.map.tileheight)}),d=new a.objects.GameFeatureObject(c);this.world.mark(d);var e=pow2.EntityContainerResource.getClassType(b.type);if(b.type&&e){var f=new e;if(!d.addComponent(f))throw new Error("Component "+f.name+" failed to connect to host "+this.name)}return d},c.prototype.getCombatZones=function(a){var b={map:null,target:null,targetPoint:a};this.map&&this.map.properties&&this.map.properties&&"undefined"!=typeof this.map.properties.combatZone&&(b.map=this.map.properties.combatZone);var c=1/this.map.tilewidth,d=_.map(this.zones.objects,function(a){var b=a.x*c,d=a.y*c,e=a.width*c,f=a.height*c;return{bounds:new pow2.Rect(b,d,e,f),name:a.name}}),e=_.find(d,function(b){return b.bounds.pointInRect(a)&&b.name});return e&&(b.target=e.name),b},c}(pow2.tile.TileMap);a.GameTileMap=b}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c;!function(b){var c=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.connectComponent=function(){return b.prototype.connectComponent.call(this)&&this.host instanceof a.GameTileMap},c.prototype.process=function(a){return this.host?(a.cameraScale=a.context.canvas.width>768?4:2,a.camera=a.screenToWorld(new pow2.Rect(0,0,a.context.canvas.width,a.context.canvas.height),a.cameraScale),void(a.camera.point.x=this.host.bounds.extent.x/2-a.camera.extent.x/2)):void b.prototype.process.call(this,a)},c}(pow2.scene.components.CameraComponent);b.CombatCameraComponent=c}(c=b.combat||(b.combat={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c;!function(b){var c=function(b){function c(){b.apply(this,arguments),this.combatFlag=!1,this.combatZone="default",this.isDangerous=!1,this.enabled=!1,this.world=pow2.getWorld("pow2"),this.player=null}return __extends(c,b),c.prototype.connectComponent=function(){return b.prototype.connectComponent.call(this)&&this.host instanceof a.GameTileMap?(this.battleCounter=this.world.model.getKeyData("battleCounter"),"undefined"==typeof this.battleCounter&&this.resetBattleCounter(),!0):!1},c.prototype.disconnectComponent=function(){return this.player&&this.player.off(null,null,this),this.player=null,b.prototype.disconnectComponent.call(this)},c.prototype.syncComponent=function(){return b.prototype.syncComponent.call(this),this.enabled=this.host.map&&this.host.map.properties&&this.host.map.properties.combat,this.player&&(this.player.off(null,null,this),this.player=null),this.host.scene&&(this.player=this.host.scene.objectByComponent(pow2.scene.components.PlayerComponent)),this.listenMoves(),!!this.player},c.prototype.listenMoves=function(){this.stopListening(),this.player&&this.enabled&&this.player.on(pow2.scene.components.PlayerComponent.Events.MOVE_BEGIN,this.moveProcess,this)},c.prototype.stopListening=function(){this.player&&this.player.off(null,null,this)},c.prototype.moveProcess=function(a,b,c){var d=this.host.getTerrain("Terrain",c.x,c.y);this.isDangerous=d&&d.isDangerous;var e=this.isDangerous?10:6;return this.battleCounter<=0&&this.triggerCombat(c),this._setCounter(this.battleCounter-e),!1},c.prototype.resetBattleCounter=function(){var a=255,b=64;this._setCounter(Math.floor(Math.random()*(a-b+1))+b),this.combatFlag=!1},c.prototype.triggerCombat=function(a){var b=this,c=this.host.getCombatZones(a);this.combatZone=c.map||c.target,console.log("Combat in zone : "+this.combatZone),this.stopListening(),this.host.world.randomEncounter(c,function(){b.resetBattleCounter(),b.listenMoves()}),this.combatFlag=!0},c.prototype._setCounter=function(a){this.battleCounter=a,this.world.model.setKeyData("battleCounter",this.battleCounter)},c}(pow2.scene.SceneComponent);b.CombatEncounterComponent=c}(c=b.combat||(b.combat={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c=function(b){function c(){b.apply(this,arguments),this.host=null}return __extends(c,b),c.prototype.syncComponent=function(){return b.prototype.syncComponent.call(this)&&this.host.tileMap instanceof a.GameTileMap},c}(pow2.tile.TileComponent);b.GameComponent=c}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments),this.started=!1}return __extends(b,a),b.prototype.syncComponent=function(){var b=this;if(!a.prototype.syncComponent.call(this))return!1;this.animation=this.host.findComponent(pow2.tile.components.AnimatedSpriteComponent),this.sprite=this.host.findComponent(pow2.tile.components.SpriteComponent),this.sound=this.host.findComponent(pow2.scene.components.SoundComponent);var c=!(!this.animation||!this.sprite);return!this.started&&c&&(this.started=!0,this.animation.once("animation:done",function(){b.trigger("damage:done",b)})),c},b}(pow2.scene.SceneComponent);a.DamageComponent=b}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c=function(b){function c(){b.apply(this,arguments),this.map=null}return __extends(c,b),c.prototype.collideMove=function(b,d,e){void 0===e&&(e=[]),this.host.scene&&!this.map&&(this.map=this.host.scene.objectByType(pow2.tile.TileMap));var f=this.collider&&this.collider.collide(b,d,a.objects.GameFeatureObject,e);if(f)for(var g=0;g<e.length;g++){var h=e[g];if(h.passable===!0||!h.type)return!1;if(-1!==_.indexOf(c.COLLIDE_TYPES,h.type))return!0}if(this.map)for(var i=this.map.getLayers(),g=0;g<i.length;g++){var j=this.map.getTileData(i[g],b,d);if(j)for(var k=0;k<this.passableKeys.length;k++)if(j[this.passableKeys[k]]===!1)return!0}return!1},c}(pow2.scene.components.PlayerComponent);b.PlayerComponent=c}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.connectComponent=function(){return a.prototype.connectComponent.call(this)?this.host.feature?(this.id=this.host.feature.id,!0):(console.log("Feature host missing feature data."),!1):!1},b.prototype.syncComponent=function(){return a.prototype.syncComponent.call(this)?(this.host.visible=this.host.enabled=!this.getDataHidden(),!0):!1},b.prototype.setDataHidden=function(a){void 0===a&&(a=!0),this.host&&this.host.world&&this.host.world.model&&this.host.id&&(this.host.world.model.setKeyData(""+this.host.id,{hidden:a}),this.syncComponent())},b.prototype.getDataHidden=function(){if(this.host&&this.host.world&&this.host.world.model&&this.host.id){var a=this.host.world.model.getKeyData(""+this.host.id);if(a&&a.hidden)return!0}return!1},b}(pow2.tile.TileComponent);a.GameFeatureComponent=b}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments),this.party=null}return __extends(b,a),b.prototype.connectComponent=function(){return"undefined"==typeof this.host.id?(console.error("Fixed encounters must have a given id so they may be hidden"),!1):a.prototype.connectComponent.call(this)},b.prototype.enter=function(a){var b=this;if(this.party=a.findComponent(pow2.scene.components.PlayerComponent),!this.party)return!1;this.party.velocity.zero(),a.setPoint(a.point);var c=this.host.tileMap.getCombatZones(this.party.host.point);return this.host.world.fixedEncounter(c,this.host.id,function(a){a&&b.setDataHidden(!0)}),!0},b}(a.GameFeatureComponent);b.CombatFeatureComponent=c}(b=a.features||(a.features={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.syncComponent=function(){return a.prototype.syncComponent.call(this)&&this.host.feature?(this.title=this.host.feature.title,this.text=this.host.feature.text,this.icon=this.host.feature.icon,!0):!1},b.prototype.enter=function(a){return this.title&&this.text&&a.scene.trigger("dialog:entered",this),!0},b.prototype.exit=function(a){return this.title&&this.text&&a.scene.trigger("dialog:exited",this),!0},b}(a.GameFeatureComponent);b.DialogFeatureComponent=c}(b=a.features||(a.features={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.syncComponent=function(){return a.prototype.syncComponent.call(this)?(this.map=this.host.feature.target,this.target=new pow2.Point(this.host.feature.targetX,this.host.feature.targetY),!!this.map):!1},b.prototype.entered=function(a){var b=this;return this.target&&this.host.tileMap?(this.host.world.loader.load(pow2.getMapUrl(this.map),function(c){b.host.tileMap.setMap(c),console.log("Transition to "+b.map),a.setPoint(b.target),b.host.tileMap.syncComponents()}),!0):!1},b}(a.GameFeatureComponent);b.PortalFeatureComponent=c}(b=a.features||(a.features={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments),this._tickInterval=-1}return __extends(b,a),b.prototype.syncComponent=function(){if(a.prototype.syncComponent.call(this)){var b=this.host.world;if(b&&b.state){var c=b.state.model,d=c.getKeyData("shipPosition");d&&this.host.setPoint(new pow2.Point(d.x,d.y))}}return!1},b.prototype.enter=function(a){return this.party=a.findComponent(pow2.scene.components.PlayerComponent),this.party?(this.partySprite=a.icon,this.party.passableKeys=["shipPassable"],!0):!1},b.prototype.entered=function(a){return this.board(a)},b.prototype.board=function(a){var b=this;return this.partyObject||!this.party?!1:(this.partyObject=a,a.setSprite(this.host.icon),this.host.visible=!1,this.host.enabled=!1,this._tickInterval=setInterval(function(){if(b.partyObject.point.equal(b.party.targetPoint)&&!b.party.heading.isZero()){var a=b.partyObject.point,c=a.clone().add(b.party.heading);b.party.collideWithMap(a,"shipPassable")||b.party.collideWithMap(c,"passable")||b.disembark(a,c,b.party.heading.clone())}},32),!0)},b.prototype.disembark=function(a,b,c){clearInterval(this._tickInterval),this.partyObject.setSprite(this.partySprite),this.party.targetPoint.set(b),this.party.velocity.set(c),this.party.passableKeys=["passable"],this.host.point.set(a),this.host.visible=!0,this.host.enabled=!0,this.partyObject=null,this.party=null;var d=this.host.world;d&&d.state&&d.state.model&&d.state.model.setKeyData("shipPosition",this.host.point)},b}(a.GameFeatureComponent);b.ShipFeatureComponent=c}(b=a.features||(a.features={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.syncComponent=function(){var b=this;if(!a.prototype.syncComponent.call(this))return!1;this.name=this.host.feature.name;var c=-1!==_.indexOf(this.host.groups,"weapon");return c?this.inventory=_.filter(pow2.data.weapons,function(a){return a.level===b.host.feature.level}):-1!==_.indexOf(this.host.groups,"armor")&&(this.inventory=_.filter(pow2.data.armor,function(a){return a.level===b.host.feature.level})),!0},b.prototype.disconnectComponent=function(){return this.inventory=null,a.prototype.disconnectComponent.call(this)},b.prototype.enter=function(a){return a.scene.trigger("store:entered",this),!0},b.prototype.exit=function(a){return a.scene.trigger("store:exited",this),!0},b}(a.GameFeatureComponent);b.StoreFeatureComponent=c}(b=a.features||(a.features={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.syncComponent=function(){return a.prototype.syncComponent.call(this)&&this.host.feature?(this.name="Temple",this.cost=this.host.feature.cost,this.icon=this.host.feature.icon,!0):!1},b.prototype.enter=function(a){return a.scene.trigger("temple:entered",this),!0},b.prototype.exit=function(a){return a.scene.trigger("temple:exited",this),!0},b}(a.GameFeatureComponent);b.TempleFeatureComponent=c}(b=a.features||(a.features={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.connectComponent=function(){return"undefined"==typeof this.host.id?(console.error("Treasure must have a given id so it may be hidden"),!1):a.prototype.connectComponent.call(this)},b.prototype.syncComponent=function(){return a.prototype.syncComponent.call(this)&&this.host.feature?(this.name="Treasure Chest",this.gold=this.host.feature.gold,this.item=this.host.feature.item,this.icon=this.host.feature.icon,!0):!1},b.prototype.enter=function(a){return a.scene.trigger("treasure:entered",this),this.setDataHidden(!0),!0},b}(a.GameFeatureComponent);b.TreasureFeatureComponent=c}(b=a.features||(a.features={}))}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b=function(a){function b(b){a.call(this,_.omit(b||{},["x","y"])),this.feature=b,this.point.x=b.x,this.point.y=b.y,this.frame="undefined"!=typeof b.frame?b.frame:0,this.groups="string"==typeof b.groups?b.groups.split("|"):b.groups}return __extends(b,a),b}(pow2.tile.TileObject);a.GameFeatureObject=b}(b=a.objects||(a.objects={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c=function(b){function c(){b.apply(this,arguments),this.hitBox=new pow2.Rect(0,0,1,1),this.hits=[],this.mouse=null}return __extends(c,b),c.prototype.syncComponent=function(){return b.prototype.syncComponent.call(this)&&this.host.scene&&this.host.scene.world&&this.host.scene.world.input?(this.mouse=this.host.scene.world.input.getMouseHook("world"),!!this.mouse):!1},c.prototype.tick=function(c){this.host.scene&&this.mouse&&(_.each(this.hits,function(a){a.scale=1}),this.hits.length=0,this.hitBox.point.set(this.mouse.world),this.host.scene.db.queryRect(this.hitBox,a.objects.GameFeatureObject,this.hits),_.each(this.hits,function(a){a.scale=1.25}),b.prototype.tick.call(this,c))},c}(pow2.scene.components.TickedComponent);b.GameFeatureInputComponent=c}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c=function(c){function d(){c.apply(this,arguments),this.collider=null,this.player=null,this.touch=null,this.touchedComponent=null}return __extends(d,c),d.prototype.syncComponent=function(){return c.prototype.syncComponent.call(this),this.player=this.host.findComponent(pow2.scene.components.PlayerComponent),this.collider=this.host.findComponent(pow2.scene.components.CollisionComponent),!(!this.player||!this.collider)},d.prototype.tick=function(d){if(c.prototype.tick.call(this,d),this.player&&this.collider){var e=[],f=this.collider.collide(this.host.point.x+this.player.heading.x,this.host.point.y+this.player.heading.y,a.objects.GameFeatureObject,e),g=_.find(e,function(a){return!!a.findComponent(b.GameFeatureComponent)});if(f&&g){var h=g.findComponent(b.GameFeatureComponent),i=this.touchedComponent?this.touchedComponent.id:null;this.touchedComponent&&this.touchedComponent.id!==h.id&&(this.touchedComponent.exit(this.host),this.touchedComponent=null),this.touchedComponent=h,h.id!==i&&this.touchedComponent.enter(this.host),this.touch=g}else this.touchedComponent&&(this.touchedComponent.exit(this.host),this.touchedComponent=null),this.touch=null}},d}(pow2.scene.components.TickedComponent);b.PlayerTouchComponent=c}(b=a.components||(a.components={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c=function(){function b(b,c){this.compile=b,this.scope=c,this._canvasAcquired=!1,this._stateKey="_test2Pow2State",this.qs().hasOwnProperty("dev")&&(console.log("Clearing gameData cache and loading live from Google Spreadsheets"),pow2.GameDataResource.clearCache(pow2.GameDataResource.DATA_KEY)),this._renderCanvas=b('<canvas style="position:absolute;left:-9000px;top:-9000px;" width="64" height="64"></canvas>')(c)[0],this.loader=new pow2.ResourceLoader,this.currentScene=new pow2.scene.Scene({autoStart:!0,debugRender:!1}),this.world=new a.GameWorld({scene:this.currentScene,model:new a.models.GameStateModel,state:new a.states.GameStateMachine}),this.machine=this.world.state,pow2.registerWorld("pow2",this.world),this.world.time.start(),this.entities=this.world.loader.load(pow2.GAME_ROOT+"games/rpg/entities/map.powEntities")}return b.prototype.getSaveData=function(){return localStorage.getItem(this._stateKey)},b.prototype.resetGame=function(){localStorage.removeItem(this._stateKey)},b.prototype.saveGame=function(a){localStorage.setItem(this._stateKey,a)},b.prototype.createPlayer=function(a,b){if(!a)throw new Error("Cannot create player without valid model");if(!this.entities.isReady())throw new Error("Cannot create player before entities container is loaded");this.sprite&&(this.sprite.destroy(),this.sprite=null),this.sprite=this.entities.createObject("GameMapPlayer",{model:a,map:this.tileMap}),this.sprite.name=a.attributes.name,this.sprite.icon=a.attributes.icon,this.world.scene.addObject(this.sprite),"undefined"==typeof b&&this.tileMap instanceof pow2.tile.TileMap&&(b=this.tileMap.bounds.getCenter()),this.sprite.setPoint(b||new pow2.Point)},b.prototype.loadMap=function(a,b,c,d){var e=this;this.tileMap&&(this.tileMap.destroy(),this.tileMap=null),this.world.loader.load(pow2.getMapUrl(a),function(a){e.tileMap=e.entities.createObject("GameMapObject",{resource:a});var f=c||e.world.model.party[0];e.createPlayer(f,d),e.world.scene.addObject(e.tileMap),e.tileMap.loaded(),b&&b()})},b.prototype.newGame=function(a){this.loadMap("town",a,this.world.model.party[0])},b.prototype.loadGame=function(b,c){var d=this;b?this.world.model.initData(function(){d.world.model.parse(b);var a=d.world.model.getKeyData("playerPosition");a=a?new pow2.Point(a.x,a.y):void 0,d.loadMap(d.world.model.getKeyData("playerMap")||"town",c,d.world.model.party[0],a)}):(0===this.world.model.party.length&&(this.world.model.addHero(a.models.HeroModel.create(a.models.HeroTypes.Warrior,"Warrior")),this.world.model.addHero(a.models.HeroModel.create(a.models.HeroTypes.Ranger,"Ranger")),this.world.model.addHero(a.models.HeroModel.create(a.models.HeroTypes.LifeMage,"Mage"))),this.newGame(c))},b.prototype.getRenderContext=function(a,b){if(this._canvasAcquired)throw new Error("Only one rendering canvas is available at a time.  Check for calls to this function without corresponding releaseCanvas() calls.");this._canvasAcquired=!0,this._renderCanvas.width=a,this._renderCanvas.height=b;var c=this._renderCanvas.getContext("2d");return c.webkitImageSmoothingEnabled=!1,c.mozImageSmoothingEnabled=!1,c},b.prototype.releaseRenderContext=function(){return this._canvasAcquired=!1,this._renderCanvas.toDataURL()},b.prototype.qs=function(){if(window.location.search){var a={};return function(){for(var b,c=/\+/g,d=/([^&=]+)=?([^&]*)/g,e=function(a){return decodeURIComponent(a.replace(c," "))},f=window.location.search.substring(1);b=d.exec(f);)a[e(b[1])]=e(b[2])}(),a}return{}},b}();b.PowGameService=c,a.app.factory("game",["$compile","$rootScope",function(a,b){return new c(a,b)}])}(b=a.services||(a.services={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c=function(a){function b(b,c,d,e,f,g){var h=this;a.call(this),this.element=b,this.document=c,this.scope=d,this.timeout=e,this.game=f,this.animate=g,this._uid=_.uniqueId("alert"),this.paused=!1,this.containerSearch=".ui-container",this.container=null,this._current=null,this._queue=[],this._dismissBinding=null,f.world.mark(this),f.world.time.addObject(this),this._dismissBinding=function(a){h.dismiss()}}return __extends(b,a),b.prototype.onAddToWorld=function(a){},b.prototype.onRemoveFromWorld=function(a){},b.prototype.tick=function(a){},b.prototype.destroy=function(){this.game.world.time.removeObject(this),this.game.world.erase(this),this.container&&this.container.off("click",this._dismissBinding)},b.prototype.show=function(a,b,c){var d={message:a,duration:"undefined"==typeof c?1e3:c,done:b};return this.queue(d)},b.prototype.queue=function(a){return this.container||(this.container=this.document.find(this.containerSearch),
this.container.on("click",this._dismissBinding)),a.elapsed=0,this._queue.push(a),a},b.prototype.processFrame=function(a){var b=this;if(this._current&&this.paused!==!0){var c=this._current,d=c.duration&&c.elapsed>c.duration,e=c.dismissed===!0;if(!d&&!e)return void(c.elapsed+=a);this.dismiss()}this.paused||0===this._queue.length||(this._current=this._queue.shift(),this.scope.$apply(function(){b.paused=!0,b.scope.powAlert=b._current,b.animate.enter(b.element,b.container).then(function(){b.paused=!1})}))},b.prototype.dismiss=function(){var a=this;this._current&&!this.paused&&(this.paused=!0,this.scope.$apply(function(){a.animate.leave(a.element).then(function(){if(a._current){try{a._current.done&&a._current.done(a._current)}catch(b){console.log(b)}a._current=null}a.scope.powAlert=null,a.paused=!1})}),this._current&&(this._current.dismissed=!0))},b}(pow2.Events);b.PowAlertService=c,a.app.factory("powAlert",["$rootScope","$timeout","game","$compile","$document","$animate",function(a,b,d,e,f,g){var h=e('<div class="drop-overlay fade"><div class="message">{{powAlert.message}}</div></div>')(a);return new c(h,f,a,b,d,g)}])}(b=a.services||(a.services={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){a.app.controller("RPGGameController",["$scope","$timeout","game","powAlert",function(b,c,d,e){b.loadingTitle="Pow2!",b.loadingMessage="Asking Google for data...",b.loading=!0,b.range=function(a){return new Array(a)},b.resetGame=function(){d.resetGame(),e.show("Game Save Deleted.  This will take effect the next time you refresh.",null,0)},b.getState=function(){return d.getSaveData()},b.saveGame=function(){var a=d.currentScene.componentByType(pow2.scene.components.PlayerComponent);a&&d.world.model.setKeyData("playerPosition",a.host.point);var b=JSON.stringify(d.world.model.toJSON());d.saveGame(b),e.show("Game Saved!",null,0)},a.models.GameStateModel.getDataSource(function(){b.$apply(function(){b.loadingMessage="Loading the things..."});d.getSaveData();d.loadGame(d.getSaveData(),function(){b.$apply(function(){b.gameModel=d.world.model,b.party=d.world.model.party,b.inventory=d.world.model.inventory,b.player=d.world.model.party[0],b.loading=!1,b.loaded=!0})})}),d.world.scene.on("treasure:entered",function(b){"undefined"!=typeof b.gold&&(d.world.model.addGold(b.gold),e.show("You found "+b.gold+" gold!",null,0)),"string"==typeof b.item&&a.models.GameStateModel.getDataSource(function(c){var f=null,g=_.where(c.getSheetData("weapons"),{id:b.item})[0];g?f=new a.models.WeaponModel(g):(g=_.where(c.getSheetData("armor"),{id:b.item})[0],g&&(f=new a.models.ArmorModel(g))),f&&(d.world.model.inventory.push(f),e.show("You found "+f.get("name")+"!",null,0))})}),d.currentScene.on(pow2.tile.TileMap.Events.MAP_LOADED,function(a){d.world.model.setKeyData("playerMap",a.map.url)}),d.machine.on("enter",function(c){c.name===a.states.GameCombatState.NAME&&b.$apply(function(){b.combat=c.machine,b.inCombat=!0,c.machine.on("combat:attack",function(a){var b=c.machine.notifyWait(),d="",f=a.attacker.model.get("name"),g=a.defender.model.get("name");d=a.damage>0?f+" attacked "+g+" for "+a.damage+" damage!":f+" attacked "+g+", and MISSED!",e.show(d,b)}),c.machine.on("combat:run",function(a){var b=c.machine.notifyWait(),d=a.player.model.get("name");d+=a.success?" bravely ran away!":" failed to escape!",e.show(d,b)}),c.machine.on("combat:victory",function(a){var b=c.machine.notifyWait();e.show("Found "+a.gold+" gold!",null,0),e.show("Gained "+a.exp+" experience!",null,0),angular.forEach(a.levels,function(a){e.show(a.get("name")+" reached level "+a.get("level")+"!",null,0)}),e.show("Enemies Defeated!",b)}),c.machine.on("combat:defeat",function(a){e.show("Your party was defeated...",function(){d.loadGame(d.getSaveData(),function(){b.$apply(function(){b.gameModel=d.world.model,b.party=d.world.model.party,b.inventory=d.world.model.inventory,b.player=d.world.model.party[0],b.combat=null,b.inCombat=!1})})},0)})})}),d.machine.on("exit",function(c){b.$apply(function(){c.name===a.states.GameMapState.NAME?(b.dialog=null,b.store=null):c.name===a.states.GameCombatState.NAME&&(b.inCombat=!1,b.combat=null)}),console.log("UI: Exited state: "+c.name)})}])}(b=a.controllers||(a.controllers={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c;!function(b){a.app.directive("healthBar",function(){return{restrict:"E",scope:{model:"="},templateUrl:"games/rpg/directives/bits/healthBar.html",controller:function(a){a.getProgressClass=function(a){if(!a||!a.attributes)return"";var b=[],c=Math.round(a.attributes.hp/a.attributes.maxHP*100);return 0===c&&b.push("dead"),33>c?b.push("critical"):66>c?b.push("hurt"):b.push("fine"),b.join(" ")},a.getProgressBarStyle=function(a){if(!a||!a.attributes)return{};var b=Math.ceil(a.attributes.hp/a.attributes.maxHP*100);return{width:b+"%"}}}}})}(c=b.bits||(b.bits={}))}(b=a.directives||(a.directives={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c;!function(b){var c=function(b){function c(c,h,i){b.call(this),this.controller=c,this.data=h,this.current=null,this.target=null,this.player=null,this.action=null,this.spell=null,this.world=a.GameWorld.get(),this.states=[new f,new d,new e,new g(i)],this.scope=c.$scope,this.scene=h.players[0].scene}return __extends(c,b),c}(pow2.StateMachine);b.ChooseActionStateMachine=c;var d=function(b){function c(){b.apply(this,arguments),this.name=c.NAME}return __extends(c,b),c.prototype.enter=function(b){if(!b.controller||!b.controller.pointer)throw new Error("Requires UIAttachment");if(!b.current)throw new Error("Requires Current Player");var c=b.current;if(b.player=c.findComponent(pow2.game.components.PlayerCombatRenderComponent),!b.player)throw new Error("Requires player render component for combat animations.");var d=new pow2.Point(-1,-.25);b.action=null,b.target=null;var h=function(c){b.action=c,b.scope.selectAction=null,b.scene.off("click",j),b.action instanceof a.components.combat.actions.CombatMagicComponent?1===b.current.getSpells().length?(b.spell=b.current.getSpells()[0],b.setCurrentState(f.NAME)):b.setCurrentState(e.NAME):b.action.canTarget()?b.setCurrentState(f.NAME):b.setCurrentState(g.NAME)};b.scope.selectAction=h;var i=$(b.controller.pointer.element);if(!c)return void i.hide();b.scope.$apply(function(){b.controller.choosing=c});var j=function(a,c){b.scene.off("click",j),b.target=c[0],h(b.controller.getActions()[0])};b.player.moveForward(function(){b.controller.setPointerTarget(c,"right",d),i.show(),b.scene.on("click",j)})},c.prototype.exit=function(a){a.scope.$apply(function(){a.controller.choosing=null})},c.NAME="choose-type",c}(pow2.State);b.ChooseActionType=d;var e=function(a){function b(){a.apply(this,arguments),this.name=b.NAME}return __extends(b,a),b.prototype.enter=function(a){if(!a.current)throw new Error("Requires Current Player");a.scope.selectSpell=function(b){switch(a.spell=b,a.scope.selectSpell=null,a.target=b.benefit?a.current:null,b.type){case"target":a.setCurrentState(f.NAME);break;default:console.info("Unknown spell type, submitting without target: "+b.type),a.setCurrentState(g.NAME)}},a.scope.$apply(function(){a.controller.choosingSpell=a.player})},b.prototype.exit=function(a){a.scope.$apply(function(){a.controller.choosingSpell=null})},b.NAME="choose-spell",b}(pow2.State);b.ChooseMagicSpell=e;var f=function(a){function b(){a.apply(this,arguments),this.name=b.NAME}return __extends(b,a),b.prototype.enter=function(a){if(!a.controller||!a.controller.pointer)throw new Error("Requires UIAttachment");var b=a.data.enemies,c=a.target||b[0],d=$(a.controller.pointer.element);if(a.controller.addPointerClass(a.action.getActionName()),!c)return void d.hide();var e=function(b){return a.target&&a.target._uid===b._uid?(a.target=b,a.scope.selectTarget=null,a.scene.off("click",h),a.setCurrentState(g.NAME),void(a.controller.targeting=!1)):(a.target=b,void a.controller.setPointerTarget(b,"left",f))};a.scope.selectTarget=e;var f=new pow2.Point(.5,-.25),h=function(a,b){e(b[0])};a.controller.setPointerTarget(c,"left",f),a.scene.on("click",h),a.scope.$apply(function(){a.controller.targeting=!0})},b.prototype.exit=function(a){a.scope.$apply(function(){a.controller.targeting=!1})},b.NAME="choose-target",b}(pow2.State);b.ChooseActionTarget=f;var g=function(a){function b(c){a.call(this),this.submit=c,this.name=b.NAME}return __extends(b,a),b.prototype.enter=function(a){var b=this;if(!a.current||!a.action||!this.submit)throw new Error("Invalid state");if(a.action.canTarget()&&!a.target)throw new Error("Invalid target");a.player.moveBackward(function(){a.controller.pointer&&$(a.controller.pointer.element).hide(),a.action.from=a.current,a.action.to=a.target,a.action.spell=a.spell,a.action.select(),a.controller.removePointerClass(a.action.getActionName()),b.submit(a.action)})},b.NAME="choose-submit",b}(pow2.State);b.ChooseActionSubmit=g}(c=b.combat||(b.combat={}))}(b=a.directives||(a.directives={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){a.app.directive("combatCanvas",["$compile","game","$animate","$damageValue",function(b,c,d,e){return{restrict:"A",link:function(b,d,f){function g(){i.canvas.width=j.width(),i.canvas.height=j.height(),i.webkitImageSmoothingEnabled=!1,i.mozImageSmoothingEnabled=!1}var h=this;b.canvas=d[0];var i=b.canvas.getContext("2d");i.webkitImageSmoothingEnabled=!1,i.mozImageSmoothingEnabled=!1,window.addEventListener("resize",g,!1);var j=$(window),k=new a.GameCombatView(d[0],c.loader);c.machine.on("enter",function(b){b.name===a.states.GameCombatState.NAME&&b.machine.on("combat:attack",function(a){e.applyDamage(a.defender,a.damage,k)})}),c.machine.on("combat:begin",function(a){c.world.combatScene.addView(k),c.tileMap.scene.paused=!0,k.setTileMap(a.tileMap),a.machine.on("combat:beginTurn",function(a){b.$apply(function(){b.combat=b.combat})})}),c.machine.on("combat:end",function(a){c.world.combatScene.removeView(k),c.tileMap.scene.paused=!1,a.machine.off("combat:beginTurn",null,h)}),g()}}}])}(b=a.directives||(a.directives={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c=function(){function b(a,b){var c=this;this.game=a,this.$scope=b,this.pointer=null,this.combatView=null,this.combatData=null,this.stateMachine=null,this.choosing=null,this.choosingSpell=null,this.targeting=!1,a.world.time.addObject(this),b.$on("$destroy",function(){a.world.time.removeObject(c)})}return b.prototype.tick=function(a){if(this.combatView&&this.pointer&&this.pointer.object){var b=this.pointer.object.point.clone();b.y=b.y-this.combatView.camera.point.y+this.pointer.offset.y,b.x=b.x-this.combatView.camera.point.x+this.pointer.offset.x;var c=this.combatView.worldToScreen(b,this.combatView.cameraScale),d=$(this.pointer.element);d.css({left:c.x,top:c.y})}},b.prototype.setPointerTarget=function(a,b,c){void 0===b&&(b="right"),void 0===c&&(c=new pow2.Point);var d=$(this.pointer.element);d.removeClass("left right"),d.addClass(b),this.pointer&&(this.pointer.object=a,this.pointer.offset=c)},b.prototype.addPointerClass=function(a){$(this.pointer.element).addClass(a)},b.prototype.removePointerClass=function(a){$(this.pointer.element).removeClass(a)},b.prototype.destroy=function(){this.pointer&&$(this.pointer.element).remove(),this.pointer=null},b.prototype.getMemberClass=function(a,b){var c=[],d=this.choosing;return d&&d.model&&d.model.get("name")===a.model.get("name")&&c.push("choosing"),b&&b.model&&a.model.get("name")===b.model.get("name")&&c.push("focused"),c.join(" ")},b.prototype.getActions=function(){var b=this;if(!this.choosing)throw new Error("cannot get actions for non-existent game entity");var c=_.filter(this.choosing.findComponents(a.components.combat.CombatActionComponent),function(a){return a.canBeUsedBy(b.choosing)});return c},b.prototype.getSpells=function(){if(!this.choosingSpell||!this.choosingSpell.host)return[];var a=this.choosingSpell.host,b=a.getSpells();return b},b.prototype.getTargets=function(){var a=[],b=this.stateMachine&&this.stateMachine.spell&&this.stateMachine.spell.benefit;return this.combatData&&(a=b?this.combatData.players:this.combatData.enemies),a},b.$inject=["game","$scope"],b}();b.CombatViewController=c,a.app.directive("combatView",["game","$compile","$animate",function(b,d,e){var f=this;return{restrict:"E",replace:!0,templateUrl:"games/rpg/directives/combatView.html",controller:c,controllerAs:"combatCtrl",link:function(c,e,g,h){h.destroy();var i=d('<span class="point-to-player" style="position:absolute;left:0;top:0;"></span>')(c),j=function(c){h.combatData=c;var d=b.world.combatScene;if(!d)throw new Error("CombatView requires a combatScene to be present in the game world");if(h.combatView=d.getViewOfType(a.GameCombatView),!h.combatView)throw new Error("CombatView requires a GameCombatView for coordinate conversions");var f=function(a){g.data.choose(a),k()},g=new a.directives.combat.ChooseActionStateMachine(h,c,f);h.stateMachine=g,g.data=c;var j=c.players.slice(),k=function(){var b=j.shift();return b?(g.current=b,void g.setCurrentState(a.directives.combat.ChooseActionType.NAME)):(h.combatData=null,void(h.stateMachine=null))};e.parent().append(i),i.show(),k()},k=function(){c.$apply(function(){c.combat=c.combat})};b.machine.on("combat:begin",function(a){a.machine.on("combat:beginTurn",k),a.machine.on("combat:chooseMoves",j),h.destroy(),h.pointer={element:i[0],object:null,offset:new pow2.Point,view:h.combatView}},f),b.machine.on("combat:end",function(a){a.machine.off("combat:beginTurn",k),a.machine.off("combat:chooseMoves",j),h.destroy()}),c.$on("$destroy",function(){b.machine&&b.machine.off("combat:begin",null,f),h.destroy()})}}}])}(b=a.directives||(a.directives={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){a.app.directive("dialogView",["game",function(a){return{restrict:"E",replace:!0,templateUrl:"games/rpg/directives/dialogView.html",link:function(b){a.world.scene.on("dialog:entered",function(a){b.$apply(function(){b.dialog=a})}),a.world.scene.on("dialog:exited",function(){b.$apply(function(){b.dialog=null})})}}}])}(b=a.directives||(a.directives={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){a.app.directive("gameCanvas",["$compile","game",function(b,c){return{restrict:"A",link:function(b,d,e){function f(){g.canvas.width=h.width(),g.canvas.height=h.height(),g.webkitImageSmoothingEnabled=!1,g.mozImageSmoothingEnabled=!1}b.canvas=d[0];var g=b.canvas.getContext("2d");g.webkitImageSmoothingEnabled=!1,g.mozImageSmoothingEnabled=!1,window.addEventListener("resize",f,!1);var h=$(window);window.addEventListener("resize",f,!1);var h=(c.world.input,$(window)),i=new a.RPGMapView(d[0],c.loader);i.camera.extent.set(10,10),i.setTileMap(c.tileMap),c.world.scene.addView(i),f()}}}])}(b=a.directives||(a.directives={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){a.app.directive("gameMenu",["game",function(a){return{restrict:"E",templateUrl:"games/rpg/directives/gameMenu.html",controller:function(a){a.page="party",a.open=!1,a.toggle=function(){a.open=!a.open},a.showParty=function(){a.page="party"},a.showSave=function(){a.page="save"},a.showInventory=function(){a.page="inventory"}}}}])}(b=a.directives||(a.directives={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){a.app.directive("inventoryView",["game","powAlert",function(b,c){return{restrict:"E",templateUrl:"/games/rpg/directives/inventoryView.html",controller:function(d,e){var f=0;d.character=d.party[f],d.nextCharacter=function(){f++,f>=d.party.length&&(f=0),d.character=d.party[f]},d.previousCharacter=function(){f--,0>f&&(f=d.party.length-1),d.character=d.party[f]},d.equipItem=function(e){var f=d.character;if(d.inventory&&e&&f){var g=e.get("usedby");if(g&&-1===_.indexOf(g,f.get("type")))return void c.show(f.get("name")+" cannot equip this item");if(e instanceof a.models.ArmorModel){var h=f.equipArmor(e);h&&b.world.model.addInventory(h)}else e instanceof a.models.WeaponModel&&(f.weapon&&b.world.model.addInventory(f.weapon),f.weapon=e);b.world.model.removeInventory(e)}},d.unequipItem=function(c){var e=d.character;if(d.inventory&&c&&e){if(c instanceof a.models.ArmorModel)e.unequipArmor(c);else if(c instanceof a.models.WeaponModel){var f=c;if(f.isNoWeapon())return;e.weapon=null}b.world.model.addInventory(c)}}}}}])}(b=a.directives||(a.directives={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c;!function(b){var c=function(){function b(b){var c=this;this.$scope=b,this.$scope.currentClass="warrior",a.models.GameStateModel.getDataSource(function(a){var b=a.getSheetData("classes");c.$scope.classes=b})}return b.prototype.getClassIcon=function(a){return a.icon.replace(/\[gender\]/i,"male")},b.prototype.getItemClass=function(a){return a.id===this.$scope.currentClass?"active":""},b.prototype.previousClass=function(){var a="mage"===this.$scope.currentClass?"warrior":"mage";this.$scope.currentClass=a},b.prototype.nextClass=function(){var a="warrior"===this.$scope.currentClass?"mage":"warrior";this.$scope.currentClass=a},b.$inject=["$scope"],b}();b.MainMenuController=c,a.app.directive("mainMenu",function(){return{restrict:"E",scope:!0,templateUrl:"games/rpg/directives/pages/mainMenu.html",controllerAs:"mainMenu",controller:c,link:function(a,b,c){a.hero=c.hero,a.$watch(c.hero,function(b){a.hero=b})}}})}(c=b.pages||(b.pages={}))}(b=a.directives||(a.directives={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c=function(){function b(a,b,c){var d=this;this.game=a,this.powAlert=b,this.$scope=c,this.gameModel=null,this.selected=null,this.selling=!1,a.world.time.addObject(this),c.$on("$destroy",function(){d.destroy()}),this.gameModel=a.world.model}return b.prototype.destroy=function(){this.$scope.store=null,this.selling=!1,this.selected=null},b.prototype.actionItem=function(a){if(this.$scope.store&&a){var b=this.game.world.model,c=parseInt(a.cost);if(this.selling){for(var d=-1,e=0;e<b.inventory.length;e++)if(b.inventory[e].id===a.id){d=e;break}-1!==d&&(b.gold+=c,this.powAlert.show("Sold "+a.name+" for "+a.cost+" gold.",null,1500),b.inventory.splice(d,1))}else{if(c>b.gold)return void this.powAlert.show("You don't have enough money");b.gold-=c,this.powAlert.show("Purchased "+a.name+".",null,1500),b.inventory.push(a.instanceModel.clone())}this.selected=null,this.selling=!1}},b.prototype.getActionVerb=function(){return this.selling?"Sell":"Buy"},b.prototype.isBuying=function(){return!this.selected&&!this.selling},b.prototype.isSelling=function(){return!this.selected&&this.selling},b.prototype.toggleAction=function(){return this.selling||0!==this.gameModel.inventory.length?void(this.selling=!this.selling):(this.powAlert.show("You don't have any unequipped inventory to sell.",null,1500),void(this.selling=!1))},b.prototype.selectItem=function(b){b instanceof a.models.ItemModel&&(b=b.toJSON()),this.selected=b},b.prototype.initStoreFromFeature=function(b){var c=this;a.models.GameStateModel.getDataSource(function(d){var e="undefined"!=typeof b.host.category,f=[];e&&"weapons"!==b.host.category||(f=f.concat(_.map(d.getSheetData("weapons"),function(b){return _.extend({instanceModel:new a.models.WeaponModel(b)},b)}))),e&&"armor"!==b.host.category||(f=f.concat(_.map(d.getSheetData("armor"),function(b){return _.extend({instanceModel:new a.models.ArmorModel(b)},b)})));var g=[];_.each(b.host.groups,function(a){g=g.concat(_.filter(f,function(b){return-1!==_.indexOf(b.groups,a)}))}),b.inventory=_.where(g,{level:b.host.feature.level}),c.$scope.$apply(function(){c.$scope.store=b})})},b.$inject=["game","powAlert","$scope"],b}();b.StoreViewController=c,a.app.directive("storeView",["game",function(a,b){return{restrict:"E",templateUrl:"games/rpg/directives/storeView.html",controller:c,controllerAs:"storeCtrl",link:function(b,c,d,e){a.world.scene.on("store:entered",function(a){e.initStoreFromFeature(a)}),a.world.scene.on("store:exited",function(){b.$apply(function(){b.store=null})})}}}])}(b=a.directives||(a.directives={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){a.app.directive("templeView",["game","powAlert",function(a,b){return{restrict:"E",templateUrl:"games/rpg/directives/templeView.html",controller:function(c){c.heal=function(){if(c.temple){var d=a.world.model,e=d.gold,f=parseInt(c.temple.cost),g=!_.find(d.party,function(a){return a.get("hp")!==a.get("maxHP")});f>e?b.show("You don't have enough money"):g?b.show("Keep your monies.\nYour party is already fully healed."):(d.gold-=f,_.each(d.party,function(a){a.set({hp:a.get("maxHP")})}),b.show("Your party has been healed! \nYou now have ("+d.gold+") monies.",null,2500)),c.temple=null}},c.cancel=function(){c.temple=null}},link:function(b){a.world.scene.on("temple:entered",function(a){b.$apply(function(){b.temple=a})}),a.world.scene.on("temple:exited",function(){b.$apply(function(){b.temple=null})})}}}])}(b=a.directives||(a.directives={}))}(rpg||(rpg={}));var rpg;!function(a){var b=function(b){function c(a,c){b.call(this,a,c),this.objectRenderer=new pow2.tile.render.TileObjectRenderer,this.mouse=null,this.mouseClick=_.bind(this.mouseClick,this)}return __extends(c,b),c.prototype.onAddToScene=function(a){b.prototype.onAddToScene.call(this,a),this.mouse=a.world.input.mouseHook(this,"combat"),this.$el.on("click touchstart",this.mouseClick)},c.prototype.onRemoveFromScene=function(a){a.world.input.mouseUnhook("combat"),this.$el.off("click touchstart",this.mouseClick)},c.prototype.mouseClick=function(b){var c=[];return pow2.Input.mouseOnView(b.originalEvent,this.mouse.view,this.mouse),this.world.combatScene.db.queryPoint(this.mouse.world,a.objects.GameEntityObject,c)?(this.world.combatScene.trigger("click",this.mouse,c),b.stopImmediatePropagation(),!1):void 0},c.prototype.processCamera=function(){this.cameraComponent=this.scene.componentByType(a.components.combat.CombatCameraComponent),b.prototype.processCamera.call(this)},c.prototype.renderFrame=function(a){var c=this;b.prototype.renderFrame.call(this,a);var d=this.scene.objectsByComponent(pow2.game.components.PlayerCombatRenderComponent);_.each(d,function(a){c.objectRenderer.render(a,a,c)});var e=this.scene.componentsByType(pow2.tile.components.SpriteComponent);return _.each(e,function(a){c.objectRenderer.render(a.host,a,c)}),this},c}(pow2.tile.TileMapView);a.GameCombatView=b}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.defaults=function(){return _.extend({},b.DEFAULTS)},b.DEFAULTS={name:"",icon:"",cost:0,hero:null,usedby:null},b}(Backbone.Model);a.ItemModel=b}(b=a.models||(a.models={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.defaults=function(){return _.extend(a.prototype.defaults.call(this),b.DEFAULTS)},b.DEFAULTS={name:"No Armor",icon:"",defense:0,evade:0,cost:0},b}(a.ItemModel);a.ArmorModel=b}(b=a.models||(a.models={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b=null,c=function(c){function d(a){c.call(this),this.keyData={},_.defaults(this,a||{},{gold:200,playerPosition:new pow2.Point,playerMap:"",combatZone:"world-plains",party:[],inventory:[]})}return __extends(d,c),d.prototype.initData=function(a){d.getDataSource(a)},d.getDataSource=function(a){return b?(a&&a(b),b):pow2.ResourceLoader.get().loadAsType(pow2.SPREADSHEET_ID,pow2.GameDataResource,function(c){b=c,a&&a(c)})},d.prototype.setKeyData=function(a,b){this.keyData[a]=b},d.prototype.getKeyData=function(a){return this.keyData[a]},d.prototype.addInventory=function(a){return this.inventory.push(a),a},d.prototype.removeInventory=function(a){for(var b=0;b<this.inventory.length;b++)if(this.inventory[b].cid===a.cid)return this.inventory.splice(b,1),!0;return!1},d.prototype.addHero=function(a){this.party.push(a),a.game=this},d.prototype.addGold=function(a){this.gold+=a},d.prototype.parse=function(c,d){if(!b)throw new Error("cannot instantiate inventory without valid data source.\nCall model.initData(loader) first.");try{"string"==typeof c&&(c=JSON.parse(c))}catch(e){return void console.log("Failed to load save game.")}if("undefined"!=typeof c.keyData)try{this.keyData=JSON.parse(c.keyData)}catch(e){console.error("Failed to parse keyData"),this.keyData=c.keyData}var f=[];f=f.concat(_.map(b.getSheetData("weapons"),function(b){return _.extend({instanceModel:new a.WeaponModel(b)},b)})),f=f.concat(_.map(b.getSheetData("armor"),function(b){return _.extend({instanceModel:new a.ArmorModel(b)},b)})),this.inventory=_.map(c.inventory,function(a){var b=_.where(f,{id:a.id})[0];return b.instanceModel}),this.party=_.map(c.party,function(b){return new a.HeroModel(b,{parse:!0})}),_.extend(this,_.omit(c,"party","inventory","keyData"))},d.prototype.toJSON=function(){var a=_.omit(this,"party","inventory","keyData","world");a.party=_.map(this.party,function(a){return a.toJSON()}),a.inventory=_.map(this.inventory,function(a){return _.pick(a.attributes,"id")});try{a.keyData=JSON.stringify(this.keyData)}catch(b){console.error("Failed to stringify keyData"),a.keyData={}}return a},d}(pow2.Events);a.GameStateModel=c}(b=a.models||(a.models={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.defaults=function(){return _.extend(a.prototype.defaults.call(this),b.DEFAULTS)},b.prototype.isNoWeapon=function(){return this.attributes.name===b.DEFAULTS.name&&this.attributes.icon===b.DEFAULTS.icon&&this.attributes.attack===b.DEFAULTS.attack&&this.attributes.hit===b.DEFAULTS.hit&&this.attributes.cost===b.DEFAULTS.cost},b.DEFAULTS={name:"No Weapon",icon:"",attack:0,hit:0,cost:0},b}(a.ItemModel);a.WeaponModel=b}(b=a.models||(a.models={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b=[0,32,96,208,400,672,1056,1552,2184,2976];a.HeroTypes={Warrior:"warrior",LifeMage:"mage",Necromancer:"necromancer",Ranger:"ranger"};var c=function(c){function d(){c.apply(this,arguments),this.defenseBuff=0}return __extends(d,c),d.prototype.defaults=function(){return _.extend(c.prototype.defaults.call(this),d.DEFAULTS)},d.prototype.equipArmor=function(a){var b,c=a.get("type");return-1!==_.indexOf(d.ARMOR_TYPES,c)&&(b=this[c],this[c]=a),b},d.prototype.unequipArmor=function(a){var b=a.get("type"),c=this[b];return c&&b?(this[b]=null,!0):!1},d.prototype.getEvasion=function(){var b=this,c=_.reduce(d.ARMOR_TYPES,function(a,c){var d=b[c];return d?a+d.attributes.evade:a},0);return a.EntityModel.BASE_EVASION+this.attributes.agility+c},d.prototype.attack=function(a){var b=this.attributes.strength/2,c=this.weapon?this.weapon.attributes.attack:0,d=b+c,e=1.2*d,f=.8*d,g=Math.max(1,Math.floor(Math.random()*(e-f+1))+f);return this.rollHit(a)?a.damage(g):0},d.prototype.getXPForLevel=function(a){return void 0===a&&(a=this.attributes.level),0==a?0:b[a-1]},d.prototype.getDefense=function(a){var b=this;void 0===a&&(a=!1);var c=_.reduce(d.ARMOR_TYPES,function(a,c){var d=b[c];return d?a+d.attributes.defense:a},0);return c+(a?0:this.defenseBuff)},d.prototype.getDamage=function(){return(this.weapon?this.weapon.attributes.attack:0)+this.attributes.strength/2|0},d.prototype.awardExperience=function(a){var b=this.attributes.exp+a;return this.set({exp:b}),b>=this.attributes.nextLevelExp?(this.awardLevelUp(),!0):!1},d.prototype.awardLevelUp=function(){var a=this.attributes.level+1,b=this.getHPForLevel(a);this.set({level:a,maxHP:b,strength:this.getStrengthForLevel(a),agility:this.getAgilityForLevel(a),vitality:this.getVitalityForLevel(a),intelligence:this.getIntelligenceForLevel(a),nextLevelExp:this.getXPForLevel(a+1),prevLevelExp:this.getXPForLevel(a)}),this.trigger("levelUp",this)},d.prototype.parse=function(b,c){var e=this;try{"string"==typeof b&&(b=JSON.parse(b))}catch(f){return console.log("Failed to load save game."),{}}return b?(a.GameStateModel.getDataSource(function(c){if(_.each(d.ARMOR_TYPES,function(d){if(b[d]){var f=_.where(c.getSheetData("armor"),{name:b[d]})[0];f&&(e[d]=new a.ArmorModel(f))}}),b.weapon){var f=_.where(c.getSheetData("weapons"),{name:b.weapon})[0];e.weapon=new a.WeaponModel(f)}}),_.omit(b,_.flatten(["weapon",d.ARMOR_TYPES]))):{}},d.prototype.toJSON=function(){var a=this,b=c.prototype.toJSON.call(this);return this.weapon&&(b.weapon=this.weapon.get("name")),_.each(d.ARMOR_TYPES,function(c){a[c]&&(b[c]=a[c].get("name"))}),b},d.prototype.getHPForLevel=function(a){return void 0===a&&(a=this.attributes.level),Math.floor(this.attributes.vitality*Math.pow(a,1.1))+2*this.attributes.baseVitality},d.prototype.getStrengthForLevel=function(a){return void 0===a&&(a=this.attributes.level),Math.floor(this.attributes.baseStrength*Math.pow(a,.65))},d.prototype.getAgilityForLevel=function(a){return void 0===a&&(a=this.attributes.level),Math.floor(this.attributes.baseAgility*Math.pow(a,.95))},d.prototype.getVitalityForLevel=function(a){return void 0===a&&(a=this.attributes.level),Math.floor(this.attributes.baseVitality*Math.pow(a,.95))},d.prototype.getIntelligenceForLevel=function(a){return void 0===a&&(a=this.attributes.level),Math.floor(this.attributes.baseIntelligence*Math.pow(a,.95))},d.create=function(b,c){var e=null;switch(b){case a.HeroTypes.Warrior:e=new d({type:b,level:0,name:c,icon:"warrior-male.png",baseStrength:10,baseAgility:2,baseIntelligence:1,baseVitality:7,hitpercent:10,hitPercentPerLevel:3});break;case a.HeroTypes.LifeMage:e=new d({type:b,name:c,level:0,icon:"magician-female.png",baseStrength:1,baseAgility:6,baseIntelligence:9,baseVitality:4,hitpercent:5,hitPercentPerLevel:1});break;case a.HeroTypes.Ranger:e=new d({type:b,name:c,level:0,icon:"ranger-female.png",baseStrength:3,baseAgility:10,baseIntelligence:2,baseVitality:5,hitpercent:7,hitPercentPerLevel:2});break;case a.HeroTypes.DeathMage:e=new d({type:b,name:c,level:0,icon:"magician-male.png",baseStrength:2,baseAgility:10,baseIntelligence:4,baseVitality:4,hitpercent:5,hitPercentPerLevel:2});break;default:throw new Error("Unknown character class: "+b)}return e.awardLevelUp(),e.set({hp:e.get("maxHP")}),e},d.MAX_LEVEL=50,d.MAX_ATTR=50,d.ARMOR_TYPES=["head","body","arms","feet","accessory"],d.DEFAULTS={name:"Hero",icon:"",combatSprite:"",type:a.HeroTypes.Warrior,level:1,exp:0,nextLevelExp:0,prevLevelExp:0,hp:0,maxHP:6,description:"",baseStrength:0,baseAgility:0,baseIntelligence:0,baseVitality:0,hitpercent:5,hitPercentPerLevel:1,evade:0},d}(a.EntityModel);a.HeroModel=c}(b=a.models||(a.models={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.defaults=function(){return _.extend(a.prototype.defaults.call(this),b.DEFAULTS)},b.prototype.initialize=function(b){a.prototype.initialize.call(this,b),this.set({maxHP:b.hp,maxMP:b.mp})},b.prototype.attack=function(a){var b=a,c=b.getDefense(),d=this.attributes.attacklow,e=this.attributes.attackhigh,f=Math.floor(Math.random()*(e-d+1))+d;return this.rollHit(a)?a.damage(Math.max(1,f-c)):0},b.DEFAULTS={name:"Unnamed Creature",icon:"noIcon.png",groups:[],level:0,hp:0,exp:0,strength:0,numAttacks:0,armorClass:0,description:"",evade:0,hitpercent:1},b}(a.EntityModel);a.CreatureModel=b}(b=a.models||(a.models={}))}(rpg||(rpg={}));var rpg;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.tileMap=null,this._features=null}return __extends(c,b),c.prototype.clearCache=function(){this._features=null,b.prototype.clearCache.call(this)},c.prototype.renderFrame=function(c){return this._features||(this._features=this.scene.objectsByType(a.objects.GameFeatureObject),this._renderables=this._renderables.concat(this._features)),b.prototype.renderFrame.call(this,c),this},c}(pow2.game.GameMapView);a.RPGMapView=b}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b}(pow2.State);a.CombatState=b}(b=a.states||(a.states={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c;!function(c){var d=function(b){function c(){b.apply(this,arguments),this.name=c.NAME}return __extends(c,b),c.prototype.enter=function(c){b.prototype.enter.call(this,c),this.machine=c,
c.currentDone=!1,c.current.scale=1.25,this.current=c.current,c.current&&c.isFriendlyTurn()&&(c.focus=c.current),c.trigger("combat:beginTurn",c.current);var d=null;if(c.isFriendlyTurn()?(console.log("TURN: "+c.current.model.get("name")),d=c.playerChoices[c.current._uid]):(d=c.current.findComponent(a.components.combat.actions.CombatAttackComponent),d&&(d.to=c.getRandomPartyMember(),d.from=c.current)),!d)throw new Error("Invalid Combat Action Choice. This should not happen.");d.to&&d.to.isDefeated()&&(d.to=c.getRandomEnemy()),_.defer(function(){d.act(function(a,b){b&&console.error(b)})})},c.prototype.exit=function(a){this.current.scale=1,b.prototype.exit.call(this,a)},c.NAME="Combat Begin Turn",c}(b.CombatState);c.CombatBeginTurnState=d}(c=b.combat||(b.combat={}))}(b=a.states||(a.states={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c=function(b){function c(c){b.call(this),this.defaultState=a.states.combat.CombatStartState.NAME,this.states=[new a.states.combat.CombatStartState,new a.states.combat.CombatVictoryState,new a.states.combat.CombatDefeatState,new a.states.combat.CombatBeginTurnState,new a.states.combat.CombatChooseActionState,new a.states.combat.CombatEndTurnState,new a.states.combat.CombatEscapeState],this.party=[],this.enemies=[],this.turnList=[],this.playerChoices={},this.currentDone=!1,this.parent=c}return __extends(c,b),c.prototype.isFriendlyTurn=function(){var a=this;return this.current&&!!_.find(this.party,function(b){return b._uid===a.current._uid})},c.prototype.getLiveParty=function(){return _.reject(this.party,function(a){return a.isDefeated()})},c.prototype.getLiveEnemies=function(){return _.reject(this.enemies,function(a){return a.isDefeated()})},c.prototype.getRandomPartyMember=function(){for(var a=_.shuffle(this.party);a.length>0;){var b=a.shift();if(!b.isDefeated())return b}return null},c.prototype.getRandomEnemy=function(){for(var a=_.shuffle(this.enemies);a.length>0;){var b=a.shift();if(!b.isDefeated())return b}return null},c.prototype.partyDefeated=function(){var a=_.reject(this.party,function(a){return a.model.attributes.hp<=0});return 0===a.length},c.prototype.enemiesDefeated=function(){return 0===_.reject(this.enemies,function(a){return a.model.attributes.hp<=0}).length},c}(pow2.StateMachine);b.CombatStateMachine=c;var d=function(b){function d(){var c=this;b.call(this),this.name=d.NAME,this.machine=null,this.parent=null,this.finished=!1,a.GameWorld.get().loader.load(pow2.GAME_ROOT+"games/rpg/entities/combat.powEntities",function(a){c.factory=a}),a.models.GameStateModel.getDataSource(function(a){c.spreadsheet=a})}return __extends(d,b),d.prototype.enter=function(d){var e=this;b.prototype.enter.call(this,d),this.parent=d,this.machine=new c(d);var f=d.world.combatScene=new pow2.scene.Scene;if(d.world.mark(f),!this.factory||!this.spreadsheet)throw new Error("Invalid combat entity container or game data spreadsheet");_.each(d.model.party,function(a,b){var c=e.factory.createObject("CombatPlayer",{model:a,combat:e});if(!c)throw new Error("Entity failed to validate with given inputs");c.isDefeated()||(c.icon=a.get("icon"),e.machine.party.push(c),f.addObject(c))});var g=pow2.getMapUrl("combat");d.world.loader.load(g,function(b){e.tileMap=e.factory.createObject("GameCombatMap",{resource:b});var c=d.encounterInfo,g=c.target||c.map;_.each(e.tileMap.getLayers(),function(a){a.visible=a.name===g}),e.tileMap.dirtyLayers=!0,f.addObject(e.tileMap);for(var h=e.spreadsheet.getSheetData("enemies"),i=d.encounter.enemies.length,j=0;i>j;j++){var k=_.where(h,{id:d.encounter.enemies[j]});if(0!==k.length){var l=new a.models.CreatureModel(k[0]),m=e.factory.createObject("CombatEnemy",{model:l,combat:e,sprite:{name:"enemy",icon:l.get("icon")}});if(!m)throw new Error("Entity failed to validate with given inputs");f.addObject(m),e.machine.enemies.push(m)}}e.machine.enemies.length?(_.each(e.machine.party,function(a,b){var c=e.tileMap.getFeature("p"+(b+1));a.setPoint(new pow2.Point(c.x/16,c.y/16))}),_.each(e.machine.enemies,function(a,b){var c=e.tileMap.getFeature("e"+(b+1));c&&a.setPoint(new pow2.Point(c.x/16,c.y/16))}),d.trigger("combat:begin",e),e.machine.update(e)):d.trigger("combat:end",e)})},d.prototype.exit=function(a){a.trigger("combat:end",this);var b=this.parent.world;b&&b.combatScene&&(b.combatScene.destroy(),b.combatScene=null),this.tileMap.destroy(),this.finished=!1,this.machine=null,this.parent=null},d.NAME="combat",d}(pow2.State);b.GameCombatState=d}(b=a.states||(a.states={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function c(){a.apply(this,arguments),this.name=c.NAME,this.pending=[]}return __extends(c,a),c.prototype.enter=function(c){var d=this;a.prototype.enter.call(this,c),this.pending=c.getLiveParty(),c.playerChoices={},c.trigger("combat:chooseMoves",{choose:function(a){c.playerChoices[a.from._uid]=a,d.pending=_.filter(d.pending,function(b){return a.from._uid!==b._uid}),console.log(a.from.model.get("name")+" chose "+a.getActionName()),0===d.pending.length&&c.setCurrentState(b.CombatBeginTurnState.NAME)},players:this.pending,enemies:c.getLiveEnemies()})},c.NAME="Combat Choose Actions",c}(a.CombatState);b.CombatChooseActionState=c}(b=a.combat||(a.combat={}))}(b=a.states||(a.states={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b;!function(b){var c=function(b){function c(){b.apply(this,arguments),this.name=c.NAME}return __extends(c,b),c.prototype.enter=function(c){b.prototype.enter.call(this,c);var d={enemies:c.enemies,party:c.party};c.notify("combat:defeat",d,function(){c.parent.world.reportEncounterResult(!1),c.parent.setCurrentState(a.GameMapState.NAME)})},c.NAME="Combat Defeat",c}(a.CombatState);b.CombatDefeatState=c}(b=a.combat||(a.combat={}))}(b=a.states||(a.states={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function c(){a.apply(this,arguments),this.name=c.NAME}return __extends(c,a),c.prototype.enter=function(c){for(a.prototype.enter.call(this,c),c.current=null;c.turnList.length>0&&!c.current;)c.current=c.turnList.shift(),c.current&&c.current.isDefeated()&&(c.current=null);var d=c.current?b.CombatBeginTurnState.NAME:b.CombatStartState.NAME;if(c.partyDefeated()?d=b.CombatDefeatState.NAME:c.enemiesDefeated()&&(d=b.CombatVictoryState.NAME),!d)throw new Error("Invalid transition from end turn");c.setCurrentState(d)},c.NAME="Combat End Turn",c}(a.CombatState);b.CombatEndTurnState=c}(b=a.combat||(a.combat={}))}(b=a.states||(a.states={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b;!function(b){var c=function(b){function c(){b.apply(this,arguments),this.name=c.NAME}return __extends(c,b),c.prototype.enter=function(c){b.prototype.enter.call(this,c),c.notify("combat:escape",{player:c.current},function(){c.parent.world.reportEncounterResult(!1),c.parent.setCurrentState(a.GameMapState.NAME)})},c.NAME="Combat Escaped",c}(a.CombatState);b.CombatEscapeState=c}(b=a.combat||(a.combat={}))}(b=a.states||(a.states={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function c(){a.apply(this,arguments),this.name=c.NAME}return __extends(c,a),c.prototype.enter=function(c){a.prototype.enter.call(this,c),c.turnList=_.shuffle(_.union(c.getLiveParty(),c.getLiveEnemies())),c.current=c.turnList.shift(),c.currentDone=!0,c.setCurrentState(b.CombatChooseActionState.NAME)},c.NAME="Combat Started",c}(a.CombatState);b.CombatStartState=c}(b=a.combat||(a.combat={}))}(b=a.states||(a.states={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b;!function(b){var c=function(b){function c(){b.apply(this,arguments),this.name=c.NAME}return __extends(c,b),c.prototype.enter=function(c){b.prototype.enter.call(this,c);var d=0,e=0;_.each(c.enemies,function(a){d+=a.model.get("gold")||0,e+=a.model.get("exp")||0}),c.parent.model.addGold(d);var f=_.reject(c.party,function(a){return a.isDefeated()}),g=Math.round(e/f.length),h=[];_.each(f,function(a){var b=a.model,c=b.awardExperience(g);c&&h.push(b)});var i={state:this,party:c.party,enemies:c.enemies,levels:h,gold:d,exp:e};c.notify("combat:victory",i,function(){c.parent.world.reportEncounterResult(!0),c.parent.setCurrentState(a.GameMapState.NAME)})},c.NAME="Combat Victory",c}(a.CombatState);b.CombatVictoryState=c}(b=a.combat||(a.combat={}))}(b=a.states||(a.states={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments),this.name=b.NAME}return __extends(b,a),b.NAME="default",b}(pow2.State);b.GameDefaultState=c;var d=function(d){function e(){d.apply(this,arguments),this.model=null,this.defaultState=c.NAME,this.player=null,this.encounterInfo=null,this.encounter=null,this.states=[new c,new b.GameMapState,new b.GameCombatState]}return __extends(e,d),e.prototype.onAddToWorld=function(b){d.prototype.onAddToWorld.call(this,b),a.models.GameStateModel.getDataSource(),this.model=b.model||new a.models.GameStateModel},e.prototype.setCurrentState=function(a){if(this.world&&this.world.scene){var b=this.world.scene;this.player=b.objectByComponent(pow2.scene.components.PlayerComponent)}return d.prototype.setCurrentState.call(this,a)},e}(pow2.StateMachine);b.GameStateMachine=d}(b=a.states||(a.states={}))}(rpg||(rpg={}));var rpg;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments),this.name=b.NAME,this.mapPoint=null,this.map=null}return __extends(b,a),b.prototype.enter=function(b){a.prototype.enter.call(this,b),b.player&&this.mapPoint&&(b.player.setPoint(this.mapPoint),this.mapPoint=null),console.log("MAPPPPPPP")},b.prototype.exit=function(a){a.player&&(this.mapPoint=a.player.point.clone())},b.NAME="map",b}(pow2.State);a.GameMapState=b}(b=a.states||(a.states={}))}(rpg||(rpg={}));
//# sourceMappingURL=pow2.min.rpg.map