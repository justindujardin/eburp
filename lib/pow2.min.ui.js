
/*!
  pow2 - v0.0.21
  built: 2014-11-28
 */

var pow2;!function(a){var b;!function(a){a.app=angular.module("pow2",["ngAnimate","ngSanitize","ngTouch"]),a.app.directive("heroCard",function(){return{restrict:"E",scope:!0,templateUrl:"/source/ui/directives/heroCard.html",link:function(a,b,c){a.hero=c.hero,a.$watch(c.hero,function(b){a.hero=b})}}})}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(){function b(b,c){this.compile=b,this.scope=c,this._canvasAcquired=!1,this._stateKey="_test2Pow2State",this.qs().hasOwnProperty("dev")&&(console.log("Clearing gameData cache and loading live from Google Spreadsheets"),a.GameDataResource.clearCache()),this._renderCanvas=b('<canvas style="position:absolute;left:-9000px;top:-9000px;" width="64" height="64"></canvas>')(c)[0],this.loader=new a.ResourceLoader,this.currentScene=new a.Scene({autoStart:!0,debugRender:!1}),this.world=new a.GameWorld({scene:this.currentScene,model:new a.GameStateModel,state:new a.GameStateMachine}),this.machine=this.world.state,a.registerWorld("pow2",this.world),this.world.time.start()}return b.prototype.getSaveData=function(){return localStorage.getItem(this._stateKey)},b.prototype.resetGame=function(){localStorage.removeItem(this._stateKey)},b.prototype.saveGame=function(a){localStorage.setItem(this._stateKey,a)},b.prototype.createPlayer=function(b,c){if(!b)throw new Error("Cannot create player without valid model");this.sprite&&(this.sprite.destroy(),this.sprite=null),this.sprite=new a.GameEntityObject({name:b.attributes.name,icon:b.attributes.icon,model:b}),this.world.scene.addObject(this.sprite),this.sprite.addComponent(new a.PlayerRenderComponent),this.sprite.addComponent(new a.CollisionComponent),this.sprite.addComponent(new a.PlayerComponent),this.sprite.addComponent(new a.PlayerCameraComponent),this.sprite.addComponent(new a.PlayerTouchComponent),"undefined"==typeof c&&this.tileMap instanceof a.TileMap&&(c=this.tileMap.bounds.getCenter()),this.sprite.setPoint(c||new a.Point)},b.prototype.loadMap=function(b,c,d,e){var f=this;this.tileMap&&(this.tileMap.destroy(),this.tileMap=null),this.tileMap=new a.GameTileMap(b),this.tileMap.once("loaded",function(){var a=d||f.world.model.party[0];f.createPlayer(a,e),c&&c()}),this.world.scene.addObject(this.tileMap)},b.prototype.newGame=function(a){this.loadMap("town",a,this.world.model.party[0])},b.prototype.loadGame=function(b,c){var d=this;b?this.world.model.initData(function(){d.world.model.parse(b);var e=d.world.model.getKeyData("playerPosition");e=e?new a.Point(e.x,e.y):void 0,d.loadMap(d.world.model.getKeyData("playerMap")||"town",c,d.world.model.party[0],e)}):(0===this.world.model.party.length&&(this.world.model.addHero(a.HeroModel.create(a.HeroTypes.Warrior,"Warrior")),this.world.model.addHero(a.HeroModel.create(a.HeroTypes.Ranger,"Ranger")),this.world.model.addHero(a.HeroModel.create(a.HeroTypes.DeathMage,"Mage"))),this.newGame(c))},b.prototype.getRenderContext=function(a,b){if(this._canvasAcquired)throw new Error("Only one rendering canvas is available at a time.  Check for calls to this function without corresponding releaseCanvas() calls.");this._canvasAcquired=!0,this._renderCanvas.width=a,this._renderCanvas.height=b;var c=this._renderCanvas.getContext("2d");return c.webkitImageSmoothingEnabled=!1,c.mozImageSmoothingEnabled=!1,c},b.prototype.releaseRenderContext=function(){return this._canvasAcquired=!1,this._renderCanvas.toDataURL()},b.prototype.qs=function(){if(window.location.search){var a={};return function(){for(var b,c=/\+/g,d=/([^&=]+)=?([^&]*)/g,e=function(a){return decodeURIComponent(a.replace(c," "))},f=window.location.search.substring(1);b=d.exec(f);)a[e(b[1])]=e(b[2])}(),a}return{}},b}();b.PowGameService=c,b.app.factory("game",["$compile","$rootScope",function(a,b){return new c(a,b)}])}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){b.app.directive("combatCanvas",["$compile","game","$animate",function(b,c,d){return{restrict:"A",link:function(e,f){function g(){i.canvas.width=j.width(),i.canvas.height=j.height(),i.webkitImageSmoothingEnabled=!1,i.mozImageSmoothingEnabled=!1}var h=this;e.canvas=f[0];var i=e.canvas.getContext("2d");i.webkitImageSmoothingEnabled=!1,i.mozImageSmoothingEnabled=!1,window.addEventListener("resize",g,!1);var j=$(window),k=new a.GameCombatView(f[0],c.loader);c.machine.on("enter",function(c){c.name===a.GameCombatState.NAME&&c.machine.on("combat:attack",function(a,c,g){var h=g.point.clone();h.y-=k.camera.point.y+1.25,h.x-=k.camera.point.x;var i=k.worldToScreen(h,k.cameraScale),j=b('<span class="damage-value'+(0===a?" miss":"")+'" style="position:absolute;left:'+i.x+"px;top:"+i.y+'px;">'+a+"</span>")(e);e.$apply(function(){d.enter(j,f.parent(),null,function(){j.remove()})})})}),c.machine.on("combat:begin",function(a){c.world.combatScene.addView(k),c.tileMap.scene.paused=!0,k.setTileMap(a.tileMap),a.machine.on("combat:beginTurn",function(){e.$apply(function(){e.combat=e.combat})})}),c.machine.on("combat:end",function(a){c.world.combatScene.removeView(k),c.tileMap.scene.paused=!1,a.machine.off("combat:beginTurn",null,h)}),g()}}}])}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){b.app.directive("gameCanvas",["$compile","game",function(b,c){return{restrict:"A",link:function(b,d){function e(){f.canvas.width=g.width(),f.canvas.height=g.height(),f.webkitImageSmoothingEnabled=!1,f.mozImageSmoothingEnabled=!1}b.canvas=d[0];var f=b.canvas.getContext("2d");f.webkitImageSmoothingEnabled=!1,f.mozImageSmoothingEnabled=!1,window.addEventListener("resize",e,!1);var g=$(window);window.addEventListener("resize",e,!1);var g=(c.world.input,$(window)),h=new a.GameMapView(d[0],c.loader);h.camera.extent.set(10,10),h.setTileMap(c.tileMap),c.world.scene.addView(h),e()}}}])}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},pow2;!function(a){var b;!function(b){var c=function(a){function b(b,c,d,e,f,g){var h=this;a.call(this),this.element=b,this.document=c,this.scope=d,this.timeout=e,this.game=f,this.animate=g,this._uid=_.uniqueId("alert"),this.paused=!1,this.containerSearch=".ui-container",this.container=null,this._current=null,this._queue=[],this._dismissBinding=null,f.world.mark(this),f.world.time.addObject(this),this._dismissBinding=function(){h.dismiss()}}return __extends(b,a),b.prototype.onAddToWorld=function(){},b.prototype.onRemoveFromWorld=function(){},b.prototype.tick=function(){},b.prototype.destroy=function(){this.game.world.time.removeObject(this),this.game.world.erase(this),this.container&&this.container.off("click",this._dismissBinding)},b.prototype.show=function(a,b,c){var d={message:a,duration:"undefined"==typeof c?1e3:c,done:b};return this.queue(d)},b.prototype.queue=function(a){return this.container||(this.container=this.document.find(this.containerSearch),this.container.on("click",this._dismissBinding)),a.elapsed=0,this._queue.push(a),a},b.prototype.processFrame=function(a){var b=this;if(this._current&&this.paused!==!0){var c=this._current,d=c.duration&&c.elapsed>c.duration,e=c.dismissed===!0;if(!d&&!e)return void(c.elapsed+=a);this.dismiss()}this.paused||0===this._queue.length||(this._current=this._queue.shift(),this.scope.$apply(function(){b.scope.powAlert=b._current,b.animate.enter(b.element,b.container,null,function(){b.paused=!1})}))},b.prototype.dismiss=function(){var a=this;this.paused=!0,this.scope.$apply(function(){a.animate.leave(a.element,function(){a._current&&(a._current.done&&a._current.done(a._current),a._current=null),a.scope.powAlert=null,a.paused=!1})}),this._current&&(this._current.dismissed=!0)},b}(a.Events);b.PowAlertService=c,b.app.factory("powAlert",["$rootScope","$timeout","game","$compile","$document","$animate",function(a,b,d,e,f,g){var h=e('<div class="drop-overlay fade"><div class="message">{{powAlert.message}}</div></div>')(a);return new c(h,f,a,b,d,g)}])}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){b.app.controller("RPGGameController",["$scope","$timeout","game","powAlert",function(b,c,d,e){b.loadingTitle="Pow2!",b.loadingMessage="Asking Google for data...",b.loading=!0,b.range=function(a){return new Array(a)},b.resetGame=function(){d.resetGame(),e.show("Game Save Deleted.  This will take effect the next time you refresh.",null,0)},b.getState=function(){return d.getSaveData()},b.saveGame=function(){var b=d.currentScene.componentByType(a.PlayerComponent);b&&d.world.model.setKeyData("playerPosition",b.host.point);var c=JSON.stringify(d.world.model.toJSON());d.saveGame(c),e.show("Game Saved!",null,0)},a.GameStateModel.getDataSource(function(){b.$apply(function(){b.loadingMessage="Loading the things..."});d.getSaveData();d.loadGame(d.getSaveData(),function(){b.$apply(function(){b.gameModel=d.world.model,b.party=d.world.model.party,b.inventory=d.world.model.inventory,b.player=d.world.model.party[0],b.loading=!1,b.loaded=!0})})}),d.world.scene.on("treasure:entered",function(b){"undefined"!=typeof b.gold&&(d.world.model.addGold(b.gold),e.show("You found "+b.gold+" gold!",null,0)),"string"==typeof b.item&&a.GameStateModel.getDataSource(function(c){var f=null,g=_.where(c.getSheetData("weapons"),{id:b.item})[0];g?f=new a.WeaponModel(g):(g=_.where(c.getSheetData("armor"),{id:b.item})[0],g&&(f=new a.ArmorModel(g))),f&&(d.world.model.inventory.push(f),e.show("You found "+f.get("name")+"!",null,0))})}),d.currentScene.on("map:loaded",function(a){d.world.model.setKeyData("playerMap",a.mapName)}),d.machine.on("enter",function(c){c.name===a.GameCombatState.NAME&&b.$apply(function(){b.combat=c.machine,b.inCombat=!0,c.machine.on("combat:attack",function(a,b,d){var f="",g=b.model.get("name"),h=d.model.get("name");f=a>0?g+" attacked "+h+" for "+a+" damage!":g+" attacked "+h+", and MISSED!",e.show(f,function(){c.machine.update(c.machine)})}),c.machine.on("combat:victory",function(a){e.show("Found "+a.gold+" gold!",null,0),e.show("Gained "+a.exp+" experience!",null,0),angular.forEach(a.levels,function(a){e.show(a.get("name")+" reached level "+a.get("level")+"!",null,0)}),e.show("Enemies Defeated!",function(){c.machine.update(c.machine)})}),c.machine.on("combat:defeat",function(){e.show("Your party was defeated...",function(){c.machine.update(c.machine),d.loadGame(d.getSaveData(),function(){b.$apply(function(){b.gameModel=d.world.model,b.party=d.world.model.party,b.inventory=d.world.model.inventory,b.player=d.world.model.party[0],b.combat=null,b.inCombat=!1})})},0)})})}),d.machine.on("exit",function(c){b.$apply(function(){c.name===a.GameMapState.NAME?(b.dialog=null,b.store=null):c.name===a.GameCombatState.NAME&&(b.inCombat=!1,b.combat=null)}),console.log("UI: Exited state: "+c.name)})}])}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(a){a.app.directive("healthBar",function(){return{restrict:"E",scope:{model:"="},templateUrl:"/source/ui/directives/bits/healthBar.html",controller:function(a){a.getProgressClass=function(a){if(!a)return"";var b=[],c=Math.round(a.attributes.hp/a.attributes.maxHP*100);return 0===c&&b.push("dead"),b.push(33>c?"critical":66>c?"hurt":"fine"),b.join(" ")},a.getProgressBarStyle=function(a){if(!a)return{};var b=Math.ceil(a.attributes.hp/a.attributes.maxHP*100);return{width:b+"%"}}}}})}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(a){a.app.directive("iconRender",["$compile","game",function(a,b){return{restrict:"A",link:function(c,d,e){var f=parseInt(e.width||"64"),g=parseInt(e.height||"64"),h=a('<img src="" width="'+f+'"/>')(c);d.append(h),c.$watch(e.icon,function(a){return a?void b.world.sprites.getSingleSprite(a,e.frame||0,function(a){var d=b.getRenderContext(f,g);d.clearRect(0,0,f,g),d.drawImage(a,0,0,f,g);var e=b.releaseRenderContext();c.$apply(function(){h[0].src=e})}):void(h[0].src="/images/blank.gif")})}}}])}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(a){a.app.directive("combatView",["game",function(a){var b=this;return{restrict:"E",replace:!0,templateUrl:"/source/ui/directives/combatView.html",controller:function(a){a.getMemberClass=function(a,b){var c=[];return b&&b.model&&a.model.get("name")===b.model.get("name")&&c.push("focused"),c.join(" ")}},link:function(c){var d=function(){c.$apply(function(){c.combat=c.combat})};a.machine.on("combat:begin",function(a){a.machine.on("combat:beginTurn",d)},b),a.machine.on("combat:end",function(a){a.machine.off("combat:beginTurn",d)}),c.$on("$destroy",function(){a.machine&&a.machine.off("combat:begin",null,b)})}}}])}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(a){a.app.directive("dialogView",["game",function(a){return{restrict:"E",replace:!0,templateUrl:"/source/ui/directives/dialogView.html",link:function(b){a.world.scene.on("dialog:entered",function(a){b.$apply(function(){b.dialog=a})}),a.world.scene.on("dialog:exited",function(){b.$apply(function(){b.dialog=null})})}}}])}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.process=function(b){b.camera.point.set(this.host.point),b.cameraScale=Math.max(.2,Math.min(32,b.cameraScale));var c=b.screenToWorld(new a.Point(b.context.canvas.width,b.context.canvas.height),b.cameraScale);b.camera.extent.set(c)},c}(a.CameraComponent);b.EditorCameraComponent=c,b.app.directive("editorCanvas",["$compile","game","$animate",function(b,d){return{restrict:"A",scope:{map:"="},link:function(b,e,f){function g(){i.canvas.width=j.width(),i.canvas.height=j.height(),i.webkitImageSmoothingEnabled=!1,i.mozImageSmoothingEnabled=!1}var h=b.canvas=e[0],i=b.canvas.getContext("2d");i.webkitImageSmoothingEnabled=!1,i.mozImageSmoothingEnabled=!1,window.addEventListener("resize",g,!1);var j=$(window),k=new a.GameMapView(h,d.loader);e.on("mousemove",function(b){var c=a.Input.mouseOnView(b.originalEvent,k);console.log("mouse at px: "+c.point+" - world: "+c.world)}),k.camera.extent.set(10,10);e.on("click",function(b){var c=a.Input.mouseOnView(b.originalEvent,k),e=[];d.currentScene.db.queryPoint(c.world,a.SceneObject,e)&&console.log(e)}),e.on("mousewheel DOMMouseScroll MozMousePixelScroll",function(a){var b=a.originalEvent.detail?-1*a.originalEvent.detail:a.originalEvent.wheelDelta,c=k.cameraScale,d=c/10;return c+=b>0?d:-d,k.cameraScale=c,a.stopImmediatePropagation(),a.preventDefault(),!1});var l=f.map||d.tileMap,m=new c;k.addComponent(m),k.cameraComponent=m,k.setTileMap(l),d.world.scene.addView(k),g()}}}])}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(a){a.app.directive("gameMenu",["game",function(){return{restrict:"E",templateUrl:"/source/ui/directives/gameMenu.html",controller:function(a){a.page="party",a.open=!1,a.toggle=function(){a.open=!a.open},a.showParty=function(){a.page="party"},a.showSave=function(){a.page="save"},a.showInventory=function(){a.page="inventory"}}}}])}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){b.app.directive("inventoryView",["game","powAlert",function(b,c){return{restrict:"E",templateUrl:"/source/ui/directives/inventoryView.html",controller:function(d){var e=0;d.character=d.party[e],d.nextCharacter=function(){e++,e>=d.party.length&&(e=0),d.character=d.party[e]},d.previousCharacter=function(){e--,0>e&&(e=d.party.length-1),d.character=d.party[e]},d.equipItem=function(e){var f=d.character;if(d.inventory&&e&&f){var g=e.get("usedby");if(g&&-1===_.indexOf(g,f.get("type")))return void c.show(f.get("name")+" cannot equip this item");if(e instanceof a.ArmorModel){var h=f.equipArmor(e);h&&b.world.model.addInventory(h)}else e instanceof a.WeaponModel&&(f.weapon&&b.world.model.addInventory(f.weapon),f.weapon=e);b.world.model.removeInventory(e)}},d.unequipItem=function(c){var e=d.character;if(d.inventory&&c&&e){if(c instanceof a.ArmorModel)e.unequipArmor(c);else if(c instanceof a.WeaponModel){var f=c;if(f.isNoWeapon())return;e.weapon=null}b.world.model.addInventory(c)}}}}}])}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){var c=function(){function b(b){var c=this;this.$scope=b,this.$scope.currentClass="warrior",a.GameStateModel.getDataSource(function(a){var b=a.getSheetData("classes");c.$scope.$apply(function(){c.$scope.classes=b}),console.log(JSON.stringify(b,null,3))})}return b.prototype.getClassIcon=function(a){return a.icon.replace(/\[gender\]/i,"male")},b.prototype.getItemClass=function(a){return a.id===this.$scope.currentClass?"active":""},b.prototype.previousClass=function(){var a="mage"===this.$scope.currentClass?"warrior":"mage";this.$scope.currentClass=a},b.prototype.nextClass=function(){var a="warrior"===this.$scope.currentClass?"mage":"warrior";this.$scope.currentClass=a},b.$inject=["$scope"],b}();b.MainMenuController=c,b.app.directive("mainMenu",function(){return{restrict:"E",scope:!0,templateUrl:"/source/ui/directives/pages/mainMenu.html",controllerAs:"mainMenu",controller:c,link:function(a,b,c){a.hero=c.hero,a.$watch(c.hero,function(b){a.hero=b})}}})}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(b){b.app.directive("storeView",["game","powAlert",function(b,c){return{restrict:"E",templateUrl:"/source/ui/directives/storeView.html",controller:function(d){d.buyItem=function(a){if(d.store&&a){var e=b.world.model,f=parseInt(a.cost);f>e.gold?c.show("You don't have enough money"):(e.gold-=f,c.show("Purchased "+a.name+".",null,1500),e.inventory.push(a.instanceModel.clone()))}},d.initStoreFromFeature=function(b){a.GameStateModel.getDataSource(function(c){var e="undefined"!=typeof b.host.category,f=[];e&&"weapons"!==b.host.category||(f=f.concat(_.map(c.getSheetData("weapons"),function(b){return _.extend({instanceModel:new a.WeaponModel(b)},b)}))),e&&"armor"!==b.host.category||(f=f.concat(_.map(c.getSheetData("armor"),function(b){return _.extend({instanceModel:new a.ArmorModel(b)},b)})));var g=[];_.each(b.host.groups,function(a){g=g.concat(_.filter(f,function(b){return-1!==_.indexOf(b.groups,a)}))}),b.inventory=_.where(g,{level:b.feature.level}),d.$apply(function(){d.store=b})})}},link:function(a){b.world.scene.on("store:entered",function(b){a.initStoreFromFeature(b)}),b.world.scene.on("store:exited",function(){a.$apply(function(){a.store=null})})}}}])}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));var pow2;!function(a){var b;!function(a){a.app.directive("templeView",["game","powAlert",function(a,b){return{restrict:"E",templateUrl:"/source/ui/directives/templeView.html",controller:function(c){c.heal=function(){if(c.temple){var d=a.world.model,e=d.gold,f=parseInt(c.temple.cost),g=!_.find(d.party,function(a){return a.get("hp")!==a.get("maxHP")});f>e?b.show("You don't have enough money"):g?b.show("Keep your monies.\nYour party is already fully healed."):(d.gold-=f,_.each(d.party,function(a){a.set({hp:a.get("maxHP")})}),b.show("Your party has been healed! \nYou now have ("+d.gold+") monies.",null,2500)),c.temple=null}},c.cancel=function(){c.temple=null}},link:function(b){a.world.scene.on("temple:entered",function(a){b.$apply(function(){b.temple=a})}),a.world.scene.on("temple:exited",function(){b.$apply(function(){b.temple=null})})}}}])}(b=a.ui||(a.ui={}))}(pow2||(pow2={}));
//# sourceMappingURL=pow2.min.ui.map