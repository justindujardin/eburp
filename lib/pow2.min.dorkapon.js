
/*!
  pow2 - v0.1.3
  built: 2015-05-25
 */

var dorkapon;!function(a){a.NAME="dorkapon",a.SPREADSHEET_ID="1KUkfnr0ndj_hL5ZvWhmOz6pqgE2VyMCcRyZjJKhO0a0",a.ENTITIES_CONTAINER="games/dorkapon/entities/dorkapon.powEntities",a.app=angular.module("dorkapon",["ngMaterial","pow2","material.components.icon"]).config(function(a){a.theme("default").primaryPalette("blue-grey").accentPalette("deep-orange")})}(dorkapon||(dorkapon={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},dorkapon;!function(a){var b;!function(b){var c=function(c){function d(){c.apply(this,arguments),this.world=pow2.getWorld(a.NAME)}return __extends(d,c),d.prototype.doAction=function(a,b){console.warn("Subclass should entirely implement this functionality."),console.warn(" - Invoking completion callback next frame."),_.defer(b)},d.prototype.entered=function(a){var d=a.findComponent(b.PlayerTurnComponent);return d&&d.isCurrentTurn()&&(d.machine&&(d.machine.currentNode=this),d.decrementMove()),c.prototype.entered.call(this,a)},d}(pow2.tile.TileComponent);b.MapNodeComponent=c}(b=a.components||(a.components={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c=function(b){function c(a,c){b.call(this),this.target=a,this.choices=c,this.started=!1,this.startAngle=0,this.arc=Math.PI/3,this.spinTimeout=null,this.spinAngleStart=10,this.spinTime=0,this.spinTimeTotal=0,this.selection=null,this.ctx=null,this._renderPoint=new pow2.Point,this._iconCache={},this.items=[];for(var d=0;6>d;d++)this.items.push(c[_.random(0,c.length-1)])}return __extends(c,b),c.prototype.connectComponent=function(){return this.host instanceof a.DorkaponMapView&&b.prototype.connectComponent.call(this)},c.prototype.disconnectComponent=function(){return this.trigger("disconnected"),!0},c.prototype.afterFrame=function(a,b){this.started||(this.spin(a),this.started=!0),a.context&&(this.ctx=a.context,this.drawRouletteWheel(a))},c.prototype.drawRouletteWheel=function(a){var b=60,c=45,d=35;this.ctx.strokeStyle="white",this.ctx.lineWidth=2,this.ctx.font="normal 8px GraphicPixel";for(var e=a.worldToScreen(a.camera.getCenter()),f=0;6>f;f++){var g=this.startAngle+f*this.arc;this.ctx.fillStyle="#004c62",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,b,g,g+this.arc,!1),this.ctx.arc(e.x,e.y,d,g+this.arc,g,!0),this.ctx.fill(),this.ctx.stroke(),this.ctx.save(),this.ctx.translate(e.x+Math.cos(g+this.arc/2)*c,e.y+Math.sin(g+this.arc/2)*c),this.ctx.rotate(g+this.arc/2+Math.PI/2),this.renderIcon(this.items[f].icon,new pow2.Point,a),this.ctx.restore()}null!==this.selection&&(this.ctx.save(),this.ctx.font="bold 8px GraphicPixel",this.ctx.fillStyle="black",this.ctx.fillText(this.selection.name,e.x+1-this.ctx.measureText(this.selection.name).width/2,e.y+11),this.ctx.fillStyle="white",this.ctx.fillText(this.selection.name,e.x-this.ctx.measureText(this.selection.name).width/2,e.y+10),this.ctx.restore()),this.ctx.fillStyle="white",e.y-=10,this.ctx.beginPath(),this.ctx.moveTo(e.x-4,e.y-(b+5)),this.ctx.lineTo(e.x+4,e.y-(b+5)),this.ctx.lineTo(e.x+4,e.y-(b-5)),this.ctx.lineTo(e.x+9,e.y-(b-5)),this.ctx.lineTo(e.x+0,e.y-(b-13)),this.ctx.lineTo(e.x-9,e.y-(b-5)),this.ctx.lineTo(e.x-4,e.y-(b-5)),this.ctx.lineTo(e.x-4,e.y-(b+5)),this.ctx.fill()},c.prototype.spin=function(a){this.spinAngleStart=10*Math.random()+10,this.spinTime=0,this.selection=null,this.spinTimeTotal=3*Math.random()+4e3,this.rotateWheel(a)},c.prototype.rotateWheel=function(a){var b=this;if(this.spinTime+=30,this.spinTime>=this.spinTimeTotal)return void this.stopRotateWheel(a);var c=this.spinAngleStart-this.easeOut(this.spinTime,0,this.spinAngleStart,this.spinTimeTotal);this.startAngle+=c*Math.PI/180,this.spinTimeout=setTimeout(function(){b.rotateWheel(a)},30)},c.prototype.stopRotateWheel=function(a){var b=this;clearTimeout(this.spinTimeout);var c=180*this.startAngle/Math.PI+90,d=180*this.arc/Math.PI,e=Math.floor((360-c%360)/d);this.selection=this.items[e],_.delay(function(){b.spinTimeout=null,b.host.removeComponent(b)},1e3)},c.prototype.easeOut=function(a,b,c,d){var e=(a/=d)*a,f=e*a;return b+c*(f+-3*e+3*a)},c.prototype.renderIcon=function(a,b,c){var d=c.world.sprites.getSpriteMeta(a);if(d){if(!this._iconCache[d.source])return void(this._iconCache[d.source]=c.world.sprites.getSpriteSheet(d.source));if(this._iconCache[d.source].isReady()){var e=this._iconCache[d.source];this._renderPoint.set(b);var f=this._renderPoint,g=1,h=c.unitSize,i=c.unitSize;"undefined"!=typeof d.cellWidth&&"undefined"!=typeof d.cellHeight&&(h=d.cellWidth,i=d.cellHeight);var j=c.fastScreenToWorldNumber(h),k=c.fastScreenToWorldNumber(i);if(f.x-=j*g/2,f.y-=k*g/2,c.fastWorldToScreenPoint(f,f),d){var l=d.x,m=d.y;c.context.drawImage(e.data,l,m,h,i,f.x,f.y,h*g,i*g)}else c.context.drawImage(e.data,f.x,f.y,h*g,i*g)}}},c}(pow2.scene.SceneViewComponent);b.ChoiceRollComponent=c}(b=a.components||(a.components={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments),this._worker=new pow2.Point,this._workerRect=new pow2.Rect}return __extends(b,a),b.prototype.process=function(b){a.prototype.process.call(this,b),b.tileMap&&(b.camera.setCenter(this.host.renderPoint||this.host.point),b.camera.point.x=Math.min(b.camera.point.x,b.tileMap.bounds.extent.x-b.camera.extent.x),b.camera.point.y=Math.min(b.camera.point.y,b.tileMap.bounds.extent.y-b.camera.extent.y),b.camera.point.x=Math.max(-.5,b.camera.point.x),b.camera.point.y=Math.max(-.5,b.camera.point.y))},b}(pow2.scene.components.CameraComponent);a.PlayerCamera=b}(b=a.components||(a.components={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c=function(c){function d(){c.apply(this,arguments),this.heading=new pow2.Point(0,1),this.paths=null,this.map=null}return __extends(d,c),d.prototype.syncComponent=function(){return this.paths=this.host.findComponent(b.PlayerPathComponent),c.prototype.syncComponent.call(this)},d.prototype.collideMove=function(b,c,d){return void 0===d&&(d=[]),this.host.scene&&!this.map&&(this.map=this.host.scene.objectByType(pow2.tile.TileMap)),this.map&&this.paths&&this.map.bounds.pointInRect(b,c)?this.paths._graph.input[b][c]>=a.PathWeights.BLOCKED:!1},d}(pow2.scene.components.PlayerComponent);b.PlayerComponent=c}(b=a.components||(a.components={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.buildWeightedGraph=function(){for(var b=this.tileMap.getHorizPaths(),c=this.tileMap.getVertPaths(),d=this.tileMap.getNodes(),e=new Array(this.tileMap.bounds.extent.x),f=0;f<this.tileMap.bounds.extent.x;f++){var g=Array.apply(null,Array(this.tileMap.bounds.extent.y));e[f]=g.map(function(){return a.PathWeights.BLOCKED})}return _.each([].concat(b,c),function(b){e[b.x][b.y]=a.PathWeights.CAN_WALK}),_.each(d,function(b){e[b.x][b.y]=a.PathWeights.CAN_REST}),e},c}(pow2.tile.components.PathComponent);b.PlayerPathComponent=c}(b=a.components||(a.components={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c=function(b){function c(a){if(b.call(this),this.machine=a,this.turnDone=null,!a)throw new Error(pow2.errors.INVALID_ARGUMENTS)}return __extends(c,b),c.prototype.connectComponent=function(){return this.machine.on(a.states.DorkaponPlayerTurn.EVENT,this._machineCapture,this),b.prototype.connectComponent.call(this)},c.prototype.disconnectComponent=function(){return this.machine.off(a.states.DorkaponPlayerTurn.EVENT,this._machineCapture,this),b.prototype.disconnectComponent.call(this)},c.prototype.isCurrentTurn=function(a){return void 0===a&&(a=this.host),this.machine.currentPlayer._uid===a._uid},c.prototype.decrementMove=function(){var b=this.machine.currentPlayer.model;if(b.set({moves:b.attributes.moves-1}),this.turnDone&&b.attributes.moves<=0){var c=this.host.findComponent(a.components.PlayerComponent);c&&(c.path.length=0);var d=this.turnDone;this.turnDone=null,this.machine.currentNode?this.machine.currentNode.doAction(this.machine.currentPlayer,d):_.delay(d,500)}},c.prototype._machineCapture=function(a){a.player._uid===this.host._uid&&(this.turnDone=this.machine.notifyWait())},c}(pow2.scene.SceneComponent);b.PlayerTurnComponent=c}(b=a.components||(a.components={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b=function(b){function c(c,d,e,f){b.call(this),this.scene=e,this.parent=f,this.attackerMove=null,this.defenderMove=null,this.states=[new a.states.DorkaponCombatInit(this),new a.states.DorkaponCombatEnded(this),new a.states.DorkaponCombatChooseMoves(this),new a.states.DorkaponCombatExecuteMoves(this)],this.world=pow2.getWorld(a.NAME),this.left=this.attacker=this.createPlayer(c,new pow2.Point(3,6)),this.right=this.defender=this.createPlayer(d,new pow2.Point(10,6))}return __extends(c,b),c.prototype.createPlayer=function(a,b){var c=this.world.factory.createObject("DorkaponCombatPlayer",{model:a,machine:this});return c.name=a.attributes.name,c.icon=a.attributes.icon,this.scene.addObject(c),c.setPoint(b),c},c.Events={FINISHED:"combat:finished",ATTACK:"combat:attack"},c}(pow2.StateMachine);a.DorkaponCombatStateMachine=b}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){!function(a){a[a.ATTACK=1]="ATTACK",a[a.ATTACK_MAGIC=2]="ATTACK_MAGIC",a[a.ATTACK_SKILL=3]="ATTACK_SKILL",a[a.STRIKE=4]="STRIKE",a[a.DEFEND=5]="DEFEND",a[a.DEFEND_MAGIC=6]="DEFEND_MAGIC",a[a.DEFEND_SKILL=7]="DEFEND_SKILL",a[a.COUNTER=8]="COUNTER"}(b.MoveChoice||(b.MoveChoice={}));var c=b.MoveChoice,d=function(a){function b(b){a.call(this),this.machine=b}return __extends(b,a),b}(pow2.State);b.AppCombatStateBase=d;var e=function(b){function c(){b.apply(this,arguments),this.name=c.NAME}return __extends(c,b),c.prototype.enter=function(d){if(b.prototype.enter.call(this,d),console.log("Roll turns and determine who attacks first."),d.left.model instanceof a.models.DorkaponPlayer){var e=d.left.findComponent(pow2.game.components.PlayerRenderComponent);e.setHeading(pow2.game.components.Headings.EAST,!1)}else if(d.right.model instanceof a.models.DorkaponPlayer){var e=d.right.findComponent(pow2.game.components.PlayerRenderComponent);e.setHeading(pow2.game.components.Headings.WEST,!1)}var f=null,h=null,i={attacker:d.attacker,defender:d.defender,report:function(a,b){f=a,h=b}};d.notify(c.EVENT,i,function(){if(!f||!h)throw new Error("User did not report turn order.");d.attacker=f,d.defender=h,d.setCurrentState(g.NAME)})},c.NAME="dorkapon-init-combat",c.EVENT=c.NAME,c}(d);b.DorkaponCombatInit=e;var f=function(a){function c(){a.apply(this,arguments),this.name=c.NAME}return __extends(c,a),c.prototype.enter=function(d){a.prototype.enter.call(this,d);var e={winner:d.attacker,loser:d.defender};d.attacker.destroy(),d.defender.destroy(),d.notify(c.EVENT,e,function(){console.log("Combat is done."),d.parent.setCurrentState(b.AppMapState.NAME)})},c.NAME="dorkapon-combat-ended",c.EVENT=c.NAME,c}(d);b.DorkaponCombatEnded=f;var g=function(a){function b(){a.apply(this,arguments),this.name=b.NAME}return __extends(b,a),b.prototype.enter=function(c){a.prototype.enter.call(this,c),console.log("choose moves"),c.attackerMove=null,c.defenderMove=null;var d={attacker:c.attacker,defender:c.defender,report:function(a,b){a._uid===c.attacker._uid?c.attackerMove=b:a._uid===c.defender._uid&&(c.defenderMove=b)}};this.machine.notify(b.EVENT,d,function(){c.setCurrentState(h.NAME)})},b.prototype.exit=function(b){a.prototype.exit.call(this,b)},b.NAME="dorkapon-combat-choose-moves",b.EVENT=b.NAME,b}(d);b.DorkaponCombatChooseMoves=g;var h=function(b){function d(){b.apply(this,arguments),this.name=d.NAME}return __extends(d,b),d.prototype.enter=function(d){var e=this;b.prototype.enter.call(this,d),console.log("execute attack from "+d.attacker.model.attributes.name+" to "+d.defender.model.attributes.name);var h=function(){var a=d.defender.model.isDefeated()||d.attacker.model.isDefeated(),b=d.attacker;d.attacker=d.defender,d.defender=b,d.setCurrentState(a?f.NAME:g.NAME)},i=d.attacker.findComponent(pow2.game.components.PlayerCombatRenderComponent);if(!i)throw new Error("No valid attack component for player: "+d.attacker.model.attributes.name);var j=d.attacker._uid===d.right._uid;i.attackDirection=j?pow2.game.components.Headings.WEST:pow2.game.components.Headings.EAST,i.attack(function(){var b=0,f=0;switch(d.attackerMove){case c.ATTACK_MAGIC:b=d.attacker.model.getMagic();break;case c.ATTACK:b=d.attacker.model.getAttack();break;case c.ATTACK_SKILL:break;case c.STRIKE:b=2*d.attacker.model.getAttack()}switch(d.defenderMove){case c.DEFEND:(d.attackerMove===c.ATTACK||d.attackerMove===c.STRIKE)&&(b-=d.defender.model.getDefense());break;case c.DEFEND_MAGIC:d.attackerMove===c.ATTACK_MAGIC&&(b-=d.defender.model.getMagic());break;case c.DEFEND_SKILL:break;case c.COUNTER:d.attackerMove===c.STRIKE&&(f=2*b,b=0)}var g={attackerMove:d.attackerMove,defenderMove:d.defenderMove,attacker:d.attacker,defender:d.defender,attackerDamage:Math.max(Math.round(f),0),defenderDamage:Math.max(Math.round(b),0)};console.log(g),e.machine.notify(a.DorkaponCombatStateMachine.Events.ATTACK,g,h)})},d.NAME="dorkapon-combat-move-execute",d.EVENT=d.NAME,d}(d);b.DorkaponCombatExecuteMoves=h}(b=a.states||(a.states={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c;!function(c){var d=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.doAction=function(b,c){var d=b.scene.getViewOfType(a.DorkaponMapView),e=_.where(this.world.tables.getSheetData("armor"),{zone:1}),f=new a.components.ChoiceRollComponent(b,e);d.addComponent(f),f.on("disconnected",function(){b.model.set("armor",f.selection),_.delay(c,1e3)}),console.log("Roll for armor drop")},c}(b.MapNodeComponent);c.ArmorTile=d}(c=b.tiles||(b.tiles={}))}(b=a.components||(a.components={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.enter=function(b){return a.prototype.enter.call(this,b),console.log("BLUE NODE"),!0},b}(a.MapNodeComponent);b.BlueTile=c}(b=a.tiles||(a.tiles={}))}(b=a.components||(a.components={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.enter=function(b){return a.prototype.enter.call(this,b),console.log("GREEN NODE"),!0},b}(a.MapNodeComponent);b.GreenTile=c}(b=a.tiles||(a.tiles={}))}(b=a.components||(a.components={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.doAction=function(a,b){_.defer(b),console.log("Roll for item drop")},b}(a.MapNodeComponent);b.ItemTile=c}(b=a.tiles||(a.tiles={}))}(b=a.components||(a.components={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(a){var b;!function(b){var c=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.enter=function(b){return a.prototype.enter.call(this,b),console.log("RED NODE"),!0},b}(a.MapNodeComponent);b.RedTile=c}(b=a.tiles||(a.tiles={}))}(b=a.components||(a.components={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c;!function(c){var d=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.doAction=function(b,c){var d=b.scene.getViewOfType(a.DorkaponMapView),e=_.where(this.world.tables.getSheetData("weapons"),{zone:1}),f=new a.components.ChoiceRollComponent(b,e);d.addComponent(f),f.on("disconnected",function(){b.model.set("weapon",f.selection),_.delay(c,1e3)}),console.log("Roll for weapon drop")},c}(b.MapNodeComponent);c.WeaponTile=d}(c=b.tiles||(b.tiles={}))}(b=a.components||(a.components={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c;!function(c){var d=function(b){function c(){b.apply(this,arguments),this.machine=null}return __extends(c,b),c.prototype.doAction=function(b,c){var d=_.where(this.world.tables.getSheetData("enemies"),{level:1}),e=this.world.state.getState(a.states.AppCombatState.NAME),f=d[_.random(0,d.length-1)];e.attacker=b.model,e.defender=a.models.DorkaponMonster.create(f),this.world.state.setCurrentState(e),this.world.state.on(pow2.StateMachine.Events.EXIT,function(a){a.name===e.name&&_.defer(c)}),console.log("RANDOM ENCOUNTER LIKE WHOA")},c.prototype.enter=function(a){return b.prototype.enter.call(this,a),console.log("YELLOW NODE"),!0},c}(b.MapNodeComponent);c.YellowTile=d}(c=b.tiles||(b.tiles={}))}(b=a.components||(a.components={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c=function(){function a(){}return a}();b.CharacterCardController=c,a.app.controller("CharacterCardController",c)}(b=a.controllers||(a.controllers={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c=function(){function c(b,c,d,e,f,g){var h=this;return this.$scope=b,this.$rootScope=c,this.$timeout=d,this.$mdDialog=e,this.$dorkapon=f,this.$damageValue=g,this.combat=null,f.machine.on(pow2.StateMachine.Events.ENTER,function(b){if(b.name===a.states.AppCombatState.NAME){var c=b;console.log(c),h.$scope.$apply(function(){h.$rootScope.inCombat=!0,h.combat=c.machine}),h.listenCombatEvents(c)}}),f.machine.on(pow2.StateMachine.Events.EXIT,function(b){if(b.name===a.states.AppCombatState.NAME){var c=b;h.stopListeningCombatEvents(c),h.$scope.$apply(function(){h.$rootScope.inCombat=!1,h.combat=null})}}),this.$scope.$on("$destroy",function(){f.machine&&(f.machine.off(pow2.StateMachine.Events.ENTER,null,h),f.machine.off(pow2.StateMachine.Events.EXIT,null,h))}),this}return c.prototype.getHitPointValue=function(a){return a?Math.round(a.model.attributes.hp/a.model.attributes.maxhp*100):0},c.prototype.listenCombatEvents=function(b){var c=this;b.machine.on(a.DorkaponCombatStateMachine.Events.ATTACK,function(a){var d=b.machine.notifyWait();a.attackerDamage>0?(a.attacker.model.damage(a.attackerDamage),c.$damageValue.applyDamage(a.attacker,a.attackerDamage,c.$dorkapon.world.mapView,d)):(a.defender.model.damage(a.defenderDamage),c.$damageValue.applyDamage(a.defender,a.defenderDamage,c.$dorkapon.world.mapView,d))}),b.machine.on(a.states.DorkaponCombatEnded.EVENT,function(a){c.$scope.$apply(function(){c.combat=null})},this),b.machine.on(a.states.DorkaponCombatInit.EVENT,function(a){var d=b.machine.notifyWait();c.pickTurnOrderCard(a,d)},this),b.machine.on(a.states.DorkaponCombatChooseMoves.EVENT,function(a){var d=b.machine.notifyWait();c.pickMove(a,!0,function(){c.pickMove(a,!1,d)})},this)},c.prototype.stopListeningCombatEvents=function(a){a.machine.off(null,null,this)},c.prototype.pickTurnOrderCard=function(a,c){var d=this;this.$mdDialog.show({controller:b.CombatTurnOrderController,templateUrl:"games/dorkapon/dialogs/combatTurnOrder.html",controllerAs:"combat",clickOutsideToClose:!1,escapeToClose:!1}).then(function(b){var e=b?a.attacker:a.defender,f=b?a.defender:a.attacker;d.$mdDialog.hide(),a.report(e,f),c&&c()})},c.prototype.pickMove=function(a,c,d){this.$mdDialog.show({controller:b.CombatChooseMoveController,templateUrl:"games/dorkapon/dialogs/combatChooseMove.html",controllerAs:"choose",clickOutsideToClose:!1,escapeToClose:!1,locals:{event:a,attack:c},bindToController:!0}).then(function(b){a.report(c?a.attacker:a.defender,b),d&&d()})},c.$inject=["$scope","$rootScope","$timeout","$mdDialog","$dorkapon","$damageValue"],c}();b.CombatHudController=c,a.app.controller("CombatHudController",c)}(b=a.controllers||(a.controllers={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.playerPool=[],this.playerQueue=[],this.currentPlayer=null,this.currentNode=null,this.states=[new a.states.DorkaponInitGame,new a.states.DorkaponBeginTurns,new a.states.DorkaponPlayerTurn,new a.states.DorkaponPlayerTurnEnd]}return __extends(c,b),c}(pow2.StateMachine);a.DorkaponMapStateMachine=b}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments),this.name=b.NAME}return __extends(b,a),b.prototype.enter=function(b){a.prototype.enter.call(this,b),b.setCurrentState(c.NAME)},b.NAME="init-game",b}(pow2.State);a.DorkaponInitGame=b;var c=function(a){function b(){a.apply(this,arguments),this.name=b.NAME}return __extends(b,a),b.prototype.enter=function(b){a.prototype.enter.call(this,b),b.playerQueue=b.playerPool.slice(),b.currentPlayer=b.playerQueue.shift(),b.setCurrentState(d.NAME)},b.NAME="begin-turns",b}(pow2.State);a.DorkaponBeginTurns=c;var d=function(a){function b(){a.apply(this,arguments),this.name=b.NAME}return __extends(b,a),b.prototype.enter=function(c){a.prototype.enter.call(this,c);var d={player:c.currentPlayer};d.player.model.set({moves:Math.floor(6*Math.random())+1}),c.notify(b.EVENT,d,function(){c.setCurrentState(e.NAME)})},b.NAME="player-turn",b.EVENT="player:turn",b}(pow2.State);a.DorkaponPlayerTurn=d;var e=function(a){function b(){a.apply(this,arguments),this.name=b.NAME}return __extends(b,a),b.prototype.enter=function(e){a.prototype.enter.call(this,e);var f={player:e.currentPlayer};e.notify(b.EVENT,f,function(){e.playerQueue.length>0?(e.currentPlayer=e.playerQueue.shift(),console.log("Next turn is: "+e.currentPlayer.toString()),e.setCurrentState(d.NAME)):_.delay(function(){e.setCurrentState(c.NAME)},500)})},b.NAME="player-turn-end",b.EVENT="player:turn-end",b}(pow2.State);a.DorkaponPlayerTurnEnd=e}(b=a.states||(a.states={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b=function(b){function c(c){b.call(this,c),this.combatState=null,this.loader.registerType("powEntities",pow2.EntityContainerResource),this.tables=this.loader.loadAsType(a.SPREADSHEET_ID,pow2.GameDataResource),this.factory=this.loader.load(pow2.GAME_ROOT+a.ENTITIES_CONTAINER)}return __extends(c,b),c.getDataSource=function(b){var c=pow2.getWorld(a.NAME);return c.tables.isReady()?b(c.tables):c.tables.once(pow2.Resource.READY,function(){b(c.tables)}),c.tables},c}(pow2.scene.SceneWorld);a.DorkaponGameWorld=b}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c=function(){function b(b,c){this.compile=b,this.scope=c,this.qs().hasOwnProperty("dev")&&(console.log("Clearing gameData cache and loading live from Google Spreadsheets"),pow2.GameDataResource.clearCache(a.SPREADSHEET_ID)),this.loader=pow2.ResourceLoader.get(),this.world=new a.DorkaponGameWorld({scene:new pow2.scene.Scene({autoStart:!0,debugRender:!1})}),pow2.registerWorld(a.NAME,this.world),this.machine=this.world.setService("state",new a.DorkaponAppStateMachine),this.world.time.start()}return b.prototype.newGame=function(b){this.machine.setCurrentState(a.states.AppMapState.NAME),b&&b()},b.prototype.qs=function(){if(window.location.search){var a={};return function(){for(var b,c=/\+/g,d=/([^&=]+)=?([^&]*)/g,e=function(a){return decodeURIComponent(a.replace(c," "))},f=window.location.search.substring(1);b=d.exec(f);)a[e(b[1])]=e(b[2])}(),a}return{}},b}();b.DorkaponService=c,a.app.factory("$dorkapon",["$compile","$rootScope",function(a,b){return new c(a,b)}])}(b=a.services||(a.services={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){a.app.controller("DorkaponGameController",["$scope","$timeout","$dorkapon",function(b,c,d){b.loadingTitle="Dorkapon!",b.loadingMessage="Asking Google for data...",b.loading=!0,b.range=function(a){return new Array(a)},a.DorkaponGameWorld.getDataSource(function(){b.$apply(function(){b.loadingMessage="Loading the things..."}),d.newGame(function(){b.$apply(function(){b.loading=!1,b.loaded=!0})})})}])}(b=a.controllers||(a.controllers={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c=function(){function c(b,c,d){var e=this;this.$scope=b,this.$dorkapon=c,this.$mdDialog=d,this.turn=null;var f=function(){e.$scope.$$phase||e.$scope.$digest()};return c.machine.on(pow2.StateMachine.Events.ENTER,function(b){if(b.name===a.states.AppMapState.NAME){var c=b;c.machine.on(a.states.DorkaponPlayerTurn.EVENT,function(a){e.$scope.$apply(function(){e.turn=a}),a.player.model.on("change",f)},e),c.machine.on(a.states.DorkaponPlayerTurnEnd.EVENT,function(a){a.player.model.off("change",f),e.$scope.$apply(function(){e.turn=null})},e)}}),c.machine.on(pow2.StateMachine.Events.EXIT,function(b){if(b.name===a.states.AppMapState.NAME){var c=b;c.machine.off(a.states.DorkaponPlayerTurn.EVENT,null,e),c.machine.off(a.states.DorkaponPlayerTurnEnd.EVENT,null,e)}}),this.$scope.$on("$destroy",function(){c.machine&&(c.machine.off(pow2.StateMachine.Events.ENTER,null,e),c.machine.off(pow2.StateMachine.Events.EXIT,null,e))}),this}return c.prototype.showPlayerCard=function(a){this.$mdDialog.show({controller:b.CharacterCardController,controllerAs:"character",templateUrl:"games/dorkapon/controllers/characterCard.html",locals:{model:a.model},bindToController:!0})},c.$inject=["$scope","$dorkapon","$mdDialog"],c}();b.MapHudController=c,a.app.controller("MapHudController",c)}(b=a.controllers||(a.controllers={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c=function(){function b(a,b,c){var d=this;return this.$scope=a,this.$timeout=b,this.$mdDialog=c,this.event=null,this.attack=null,this.current=null,this.physicalText="",this.magicText="",this.specialText="",this.skillText="",b(function(){if(null===d.event||null===d.attack)throw new Error("Dialog must have event and attack bound to instance");d.attack?(d.physicalText="Attack",d.magicText="Magic",d.specialText="Strike",d.skillText="Skill",d.current=d.event.attacker):(d.physicalText="Defend",d.magicText="M Defend",d.specialText="Counter",d.skillText="Skill",d.current=d.event.defender)},0),this}return b.prototype.select=function(b){switch(b){case"physical":this.$mdDialog.hide(this.attack?a.states.MoveChoice.ATTACK:a.states.MoveChoice.DEFEND);break;case"magic":this.$mdDialog.hide(this.attack?a.states.MoveChoice.ATTACK_MAGIC:a.states.MoveChoice.DEFEND_MAGIC);break;case"special":this.$mdDialog.hide(this.attack?a.states.MoveChoice.STRIKE:a.states.MoveChoice.COUNTER);break;case"skill":this.$mdDialog.hide(this.attack?a.states.MoveChoice.ATTACK_SKILL:a.states.MoveChoice.DEFEND_SKILL)}},b.$inject=["$scope","$timeout","$mdDialog"],b}();b.CombatChooseMoveController=c,a.app.controller("CombatChooseMoveController",c)}(b=a.controllers||(a.controllers={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c=function(){function a(a,b,c){var d=this;return this.$scope=a,this.$timeout=b,this.$mdDialog=c,this.combat=null,this.picking=!0,this.left=null,this.right=null,this.leftText="?",this.rightText="?",this.pickCorrect=!1,this.pick=function(a){var b=_.random(0,100)>50;d.leftText=b?"✓":"✗",d.rightText=b?"✗":"✓",d.pick=null,d.pickCorrect=a===b,d.$timeout(function(){d.$mdDialog.hide(d.pickCorrect)},2e3)},this}return a.$inject=["$scope","$timeout","$mdDialog"],a}();b.CombatTurnOrderController=c,a.app.controller("CombatTurnOrderController",c)}(b=a.controllers||(a.controllers={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c=function(){function a(a,b,c){var d=this;this.$dorkapon=a,this.scope=b,this.$timeout=c,a.world.time.addObject(this),b.$on("$destroy",function(){a.world.time.removeObject(d)})}return a.$inject=["$dorkapon","$scope","$timeout"],a}();b.DorkaponHudController=c,a.app.directive("dorkaponHud",["$dorkapon","$compile",function(a,b){var d=this;return{restrict:"E",replace:!0,templateUrl:"games/dorkapon/directives/dorkaponHud.html",controller:c,controllerAs:"hud",link:function(b,c,e,f){b.$on("$destroy",function(){a.machine&&(a.machine.off(pow2.StateMachine.Events.ENTER,null,d),a.machine.off(pow2.StateMachine.Events.EXIT,null,d))})}}}])}(b=a.directives||(a.directives={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.targetFill="transparent",this.targetStroke="white",this.targetStrokeWidth=2,this.stateMachine=null}return __extends(c,b),c.prototype.processCamera=function(){if(this.stateMachine&&this.stateMachine.currentPlayer){var a=this.stateMachine.currentPlayer.findComponent(pow2.scene.components.CameraComponent);a&&a.process(this)}},c.prototype.mouseClick=function(b){if(this.stateMachine&&this.stateMachine.currentPlayer){var c=this.stateMachine.currentPlayer.findComponent(a.components.PlayerPathComponent),d=this.stateMachine.currentPlayer.findComponent(pow2.scene.components.PlayerComponent);if(c&&d){pow2.Input.mouseOnView(b.originalEvent,this.mouse.view,this.mouse);var e=c.tileMap.getNodes(),f=_.where(e,{x:this.mouse.world.x,y:this.mouse.world.y});return f.length&&(d.path=c.calculatePath(d.targetPoint,this.mouse.world)),b.preventDefault(),!1}}},c.prototype.renderFrame=function(a){var c=this;b.prototype.renderFrame.call(this,a);var d=this.scene.objectsByComponent(pow2.game.components.PlayerCombatRenderComponent);return _.each(d,function(a){c.objectRenderer.render(a,a,c)}),this},c}(pow2.game.GameMapView);a.DorkaponMapView=b}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){a.app.directive("dorkaponMap",["$compile","$dorkapon",function(b,c){return{restrict:"A",link:function(b,d,e){function f(){var a=800,b=600;(h&&i.width()<800||!h&&d.parent().width()<800)&&(a=400,b=300),h=!1,g.canvas.width=d[0].width=a,g.canvas.height=d[0].height=b,d.css({"min-width":a}),g.webkitImageSmoothingEnabled=!1,g.mozImageSmoothingEnabled=!1}b.canvas=d[0];var g=b.canvas.getContext("2d");g.webkitImageSmoothingEnabled=!1,g.mozImageSmoothingEnabled=!1,window.addEventListener("resize",f,!1);var h=!0,i=$(window),j=new a.DorkaponMapView(d[0],c.loader);c.world.setService("mapView",j),j.camera.extent.set(8,6),c.world.scene.addView(j),f()}}}])}(b=a.directives||(a.directives={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){!function(a){a[a.HORIZ_LEFT=25]="HORIZ_LEFT",a[a.HORIZ_CENTER=26]="HORIZ_CENTER",a[a.HORIZ_RIGHT=27]="HORIZ_RIGHT",a[a.VERT_TOP=34]="VERT_TOP",a[a.VERT_MIDDLE=35]="VERT_MIDDLE",a[a.VERT_BOTTOM=36]="VERT_BOTTOM"}(a.PathTiles||(a.PathTiles={}));var b=a.PathTiles;!function(a){a[a.YELLOW=54]="YELLOW",a[a.ARMOR=58]="ARMOR",a[a.WEAPON=59]="WEAPON",a[a.ITEM=60]="ITEM",a[a.RED=63]="RED",a[a.BLUE=72]="BLUE",a[a.GREEN=71]="GREEN"}(a.NodeTiles||(a.NodeTiles={}));var c=a.NodeTiles;!function(a){a[a.CAN_REST=10]="CAN_REST",a[a.CAN_WALK=5]="CAN_WALK",a[a.BLOCKED=1e3]="BLOCKED"}(a.PathWeights||(a.PathWeights={}));var d=(a.PathWeights,function(d){function e(){d.apply(this,arguments)}return __extends(e,d),e.prototype.loaded=function(){d.prototype.loaded.call(this),this.buildFeatures()},e.prototype.destroy=function(){return this.unloaded(),d.prototype.destroy.call(this)},e.prototype.unloaded=function(){this.removeFeaturesFromScene(),d.prototype.unloaded.call(this)},e.prototype.addFeaturesToScene=function(){var a=this,b=this.getNodes();_.each(b,function(b){b._object=a.createFeatureObject(b),b._object&&a.scene.addObject(b._object)})},e.prototype.removeFeaturesFromScene=function(){var a=this.getNodes();_.each(a,function(a){var b=a._object;delete a._object,b&&b.destroy()})},e.prototype.buildFeatures=function(){return this.removeFeaturesFromScene(),this.scene&&this.addFeaturesToScene(),!0},e.prototype.createFeatureObject=function(b){var d={tileMap:this,type:b.type,point:new pow2.Point(b.x,b.y)},e=new a.objects.DorkaponEntity(d);this.world.mark(e);var f=null;switch(b.type){case c.ARMOR:f="dorkapon.components.tiles.ArmorTile";break;case c.WEAPON:f="dorkapon.components.tiles.WeaponTile";break;case c.ITEM:f="dorkapon.components.tiles.ItemTile";break;case c.BLUE:f="dorkapon.components.tiles.BlueTile";break;case c.YELLOW:f="dorkapon.components.tiles.YellowTile";break;case c.RED:f="dorkapon.components.tiles.RedTile";break;case c.GREEN:f="dorkapon.components.tiles.GreenTile"}var g=pow2.EntityContainerResource.getClassType(f);if(g){var h=new g;if(!e.addComponent(h))throw new Error("Component "+h.name+" failed to connect to host "+this.name);
}return e},e.prototype.getNodes=function(){var a=this.getLayer(e.Layers.NODES);if(!a)return[];var b=this.bounds.extent.x,d=_.map(a.data,function(a,d){switch(a){case c.ARMOR:case c.WEAPON:case c.ITEM:case c.RED:case c.GREEN:case c.BLUE:case c.YELLOW:var e=d%b,f=(d-e)/b;return{type:a,x:e,y:f,_object:null};default:return null}});return _.compact(d)},e.prototype.getHorizPaths=function(){var a=this.getLayer(e.Layers.HORIZONTAL_PATHS);if(!a)return[];var c=this.bounds.extent.x,d=_.map(a.data,function(a,d){switch(a){case b.HORIZ_LEFT:case b.HORIZ_CENTER:case b.HORIZ_RIGHT:var e=d%c,f=(d-e)/c;return{type:a,x:e,y:f};default:return null}});return _.compact(d)},e.prototype.getVertPaths=function(){var a=this.getLayer(e.Layers.VERTICAL_PATHS);if(!a)return[];var c=this.bounds.extent.x,d=_.map(a.data,function(a,d){switch(a){case b.VERT_TOP:case b.VERT_MIDDLE:case b.VERT_BOTTOM:var e=d%c,f=(d-e)/c;return{type:a,x:e,y:f};default:return null}});return _.compact(d)},e.Layers={NODES:"nodes",HORIZONTAL_PATHS:"paths-horizontal",VERTICAL_PATHS:"paths-vertical"},e}(pow2.tile.TileMap));a.DorkaponTileMap=d}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.defaults=function(){return _.extend({},b.DEFAULTS)},b.prototype.damage=function(a){this.set("hp",this.attributes.hp-a),this.attributes.hp<0&&this.set("hp",0)},b.prototype.isDefeated=function(){return this.attributes.hp<=0},b.prototype.getAttack=function(){return this.attributes.attack},b.prototype.getDefense=function(){return this.attributes.defense},b.prototype.getMagic=function(){return this.attributes.magic},b.prototype.getSpeed=function(){return this.attributes.speed},b.DEFAULTS={name:"InvalidName",type:"InvalidClass",icon:"",moves:0,level:1,exp:0,hp:1,maxhp:1,attack:1,defense:1,magic:1,speed:1},b}(Backbone.Model);a.DorkaponEntity=b}(b=a.models||(a.models={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.defaults=function(){return _.extend(a.prototype.defaults.call(this),b.DEFAULTS)},b.create=function(a){var c=new b(a);return c.set({hp:c.attributes.hp,maxhp:c.attributes.hp}),c},b.DEFAULTS={name:"InvalidName",type:"InvalidClass",icon:"",level:1,exp:0,hp:1,maxhp:1,attack:1,defense:1,magic:1,speed:1},b}(a.DorkaponEntity);a.DorkaponMonster=b}(b=a.models||(a.models={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.defaults=function(){return _.extend(a.prototype.defaults.call(this),b.DEFAULTS)},b.prototype.getAttack=function(){var a=this.attributes.attack;return this.attributes.weapon&&(a+=this.attributes.weapon.attack),this.attributes.armor&&(a+=this.attributes.armor.attack),a},b.prototype.getDefense=function(){var a=this.attributes.defense;return this.attributes.weapon&&(a+=this.attributes.weapon.defense),this.attributes.armor&&(a+=this.attributes.armor.defense),a},b.prototype.getMagic=function(){var a=this.attributes.magic;return this.attributes.weapon&&(a+=this.attributes.weapon.magic),this.attributes.armor&&(a+=this.attributes.armor.magic),a},b.prototype.getSpeed=function(){var a=this.attributes.speed;return this.attributes.weapon&&(a+=this.attributes.weapon.speed),this.attributes.armor&&(a+=this.attributes.armor.speed),a},b.create=function(a){var c=new b(a);return _.isUndefined(a.magic)&&c.set({magic:a.basemagic}),_.isUndefined(a.attack)&&c.set({attack:a.baseattack}),_.isUndefined(a.speed)&&c.set({speed:a.basespeed}),_.isUndefined(a.defense)&&c.set({defense:a.basedefense}),c.set({hp:c.attributes.basehp,maxhp:c.attributes.basehp}),c},b.DEFAULTS={basehp:1,baseattack:1,basedefense:1,basemagic:1,basespeed:1,levelhp:10,levelattack:1,leveldefense:1,levelmagic:1,levelspeed:1,armor:null,weapon:null,offenseMagic:null,defenseMagic:null},b}(a.DorkaponEntity);a.DorkaponPlayer=b}(b=a.models||(a.models={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b}(pow2.tile.TileObject);a.DorkaponEntity=b}(b=a.objects||(a.objects={}))}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b=function(b){function c(){b.apply(this,arguments),this.states=[new a.states.AppMainMenuState(this),new a.states.AppMapState(this),new a.states.AppCombatState(this)]}return __extends(c,b),c}(pow2.StateMachine);a.DorkaponAppStateMachine=b}(dorkapon||(dorkapon={}));var dorkapon;!function(a){var b;!function(b){var c=function(b){function c(c){b.call(this),this.parent=c,this.world=pow2.getWorld(a.NAME)}return __extends(c,b),c}(pow2.State);b.AppStateBase=c;var d=function(a){function b(){a.apply(this,arguments),this.name=b.NAME}return __extends(b,a),b.NAME="app.states.mainmenu",b}(c);b.AppMainMenuState=d;var e=function(c){function d(){c.apply(this,arguments),this.name=d.NAME,this.attacker=null,this.defender=null,this.map=null,this.scene=new pow2.scene.Scene}return __extends(d,c),d.prototype.exit=function(a){this.world.mapView&&this.scene.removeView(this.world.mapView),this.world.combatState=this.machine=null,this.world.erase(this.scene),c.prototype.exit.call(this,a)},d.prototype.enter=function(d){var e=this;if(c.prototype.enter.call(this,d),!this.world.mapView)throw new Error("Entering map state without view to render it");this.world.mark(this.scene),this.scene.addView(this.world.mapView),this.world.mapView.setTileMap(this.map),this.world.mapView.camera.set(0,0,25,19),this.world.combatState=this.machine=new a.DorkaponCombatStateMachine(this.attacker,this.defender,this.scene,d),this.world.loader.load(pow2.getMapUrl("combat"),function(a){e.map=e.world.factory.createObject("DorkaponMapObject",{resource:a}),e.map.getLayer("world-plains").visible=!0,e.world.mapView.setTileMap(e.map),e.scene.addObject(e.map),e.machine.setCurrentState(b.DorkaponCombatInit.NAME),e.map.loaded()})},d.NAME="app.states.combat",d}(c);b.AppCombatState=e;var f=function(c){function d(){c.apply(this,arguments),this.name=d.NAME,this.map=null,this.machine=new a.DorkaponMapStateMachine,this.scene=new pow2.scene.Scene,this.initialized=!1}return __extends(d,c),d.prototype.createPlayer=function(a,b){if(!a)throw new Error("Cannot create player without valid model");if(!this.world.factory.isReady())throw new Error("Cannot create player before entities container is loaded");var c=this.world.factory.createObject("DorkaponMapPlayer",{model:a,machine:this.machine,map:this.map});return c.name=a.attributes.name,c.icon=a.attributes.icon,this.scene.addObject(c),c.setPoint(b),c},d.prototype.exit=function(a){if(!this.world.mapView)throw new Error("Entering map state without view to render it");this.world.mapView.stateMachine=null,this.scene.removeView(this.world.mapView),this.world.erase(this.scene),c.prototype.exit.call(this,a)},d.prototype.enter=function(a){if(c.prototype.enter.call(this,a),!this.world.mapView)throw new Error("Entering map state without view to render it");this.world.mark(this.scene),this.scene.addView(this.world.mapView),this.world.mapView.setTileMap(this.map),this.world.mapView.stateMachine=this.machine,this.initialized||this._loadMap()},d.prototype._loadMap=function(){var c=this;this.world.loader.load(pow2.getMapUrl("dorkapon"),function(d){c.map=c.world.factory.createObject("DorkaponMapObject",{resource:d}),c.world.mapView.setTileMap(c.map),a.DorkaponGameWorld.getDataSource(function(d){var e=d.getSheetData("classes"),f=[],g=_.where(e,{id:"warrior"})[0];g.icon=g.icon.replace("[gender]","male");var h=a.models.DorkaponPlayer.create(g);f.push(c.createPlayer(h,new pow2.Point(3,18))),g=_.where(e,{id:"mage"})[0],g.icon=g.icon.replace("[gender]","female"),h=a.models.DorkaponPlayer.create(g),f.push(c.createPlayer(h,new pow2.Point(12,11))),c.scene.addObject(c.map),c.machine.playerPool=f,c.map.loaded(),c.world.mapView.setTileMap(c.map),c.initialized=!0,c.machine.setCurrentState(b.DorkaponInitGame.NAME)})})},d.NAME="app.states.map",d}(c);b.AppMapState=f}(b=a.states||(a.states={}))}(dorkapon||(dorkapon={}));
//# sourceMappingURL=pow2.min.dorkapon.map